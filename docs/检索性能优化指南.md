# RAGæ£€ç´¢æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## æ£€ç´¢æ…¢çš„ä¸»è¦åŸå› åˆ†æ

æ ¹æ®ä»£ç åˆ†æï¼Œæ£€ç´¢é€Ÿåº¦æ…¢ä¸»è¦å—ä»¥ä¸‹å‡ ä¸ªå› ç´ å½±å“ï¼š

### 1. **APIè°ƒç”¨å»¶è¿Ÿï¼ˆæœ€ä¸»è¦åŸå› ï¼‰**

æ£€ç´¢æµç¨‹åŒ…å«å¤šä¸ªAPIè°ƒç”¨ï¼Œæ¯ä¸ªéƒ½éœ€è¦ç½‘ç»œè¯·æ±‚ï¼š

```
ç”¨æˆ·æŸ¥è¯¢ 
  â†“
1. é‚®ä»¶åˆ†ç±»ï¼ˆLLM APIè°ƒç”¨ï¼‰~ 1-3ç§’
  â†“
2. æ„å»ºRAGæŸ¥è¯¢ï¼ˆLLM APIè°ƒç”¨ï¼‰~ 1-3ç§’
  â†“
3. æŸ¥è¯¢å‘é‡åŒ–ï¼ˆåµŒå…¥æ¨¡å‹APIè°ƒç”¨ï¼‰~ 0.5-2ç§’
  â†“
4. å‘é‡æ£€ç´¢ï¼ˆæœ¬åœ°ChromaDBï¼‰~ 0.1-0.5ç§’
  â†“
5. ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆï¼ˆLLM APIè°ƒç”¨ï¼‰~ 2-5ç§’
```

**æ€»è€—æ—¶ï¼šçº¦ 4.6-13.5 ç§’**

### 2. **MMRæ£€ç´¢ç®—æ³•ï¼ˆäº§å“å’¨è¯¢åœºæ™¯ï¼‰**

äº§å“å’¨è¯¢ä½¿ç”¨MMRï¼ˆMaximal Marginal Relevanceï¼‰æ£€ç´¢ï¼Œéœ€è¦ï¼š
- è®¡ç®—å¤šæ ·æ€§å’Œç›¸å…³æ€§
- ä»æ›´å¤§çš„å€™é€‰æ± ï¼ˆfetch_k=30ï¼‰ä¸­é€‰æ‹©
- æ¯”ç®€å•ç›¸ä¼¼åº¦æ£€ç´¢æ…¢ 2-3å€

```python
# src/agents.py:136-143
product_retriever = vectorstore.as_retriever(
    search_type="mmr",  # MMRæ¯”similarityæ…¢
    search_kwargs={
        "k": 15,
        "fetch_k": 30,  # éœ€è¦æ£€ç´¢30ä¸ªå€™é€‰ï¼Œç„¶åç­›é€‰
        "lambda_mult": 0.3
    }
)
```

### 3. **åµŒå…¥æ¨¡å‹å“åº”æ—¶é—´**

ä¸åŒåµŒå…¥æ¨¡å‹çš„å“åº”é€Ÿåº¦ï¼š
- **Qwen3-Embedding-4Bï¼ˆ2560ç»´ï¼‰**ï¼šè¾ƒå¿«ï¼Œæ¨è
- **Qwen3-Embedding-8Bï¼ˆ4096ç»´ï¼‰**ï¼šè¾ƒæ…¢ï¼Œä½†ç²¾åº¦æ›´é«˜
- **æœ¬åœ°æ¨¡å‹**ï¼šæœ€å¿«ï¼Œä½†ç²¾åº¦å¯èƒ½è¾ƒä½

### 4. **ç½‘ç»œå»¶è¿Ÿ**

- APIæœåŠ¡å“åº”æ—¶é—´å—ç½‘ç»œå½±å“
- å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œå¯èƒ½éœ€è¦é‡è¯•ï¼ˆæœ€å¤š2æ¬¡ï¼‰
- æ¯æ¬¡é‡è¯•ç­‰å¾…2ç§’

### 5. **æ•°æ®åº“å¤§å°**

- æ–‡æ¡£æ•°é‡è¶Šå¤šï¼Œå‘é‡æ£€ç´¢æ—¶é—´è¶Šé•¿
- å½“å‰æ£€ç´¢k=15-20ä¸ªæ–‡æ¡£ï¼Œå¦‚æœæ•°æ®åº“å¾ˆå¤§ï¼Œè®¡ç®—é‡ä¼šå¢åŠ 

## ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¼˜åŒ–æ£€ç´¢ç­–ç•¥ï¼ˆæ¨èï¼‰

**å°†MMRæ£€ç´¢æ”¹ä¸ºç›¸ä¼¼åº¦æ£€ç´¢ï¼Œæé«˜é€Ÿåº¦**

```python
# ä¿®æ”¹ src/agents.py
# å°†äº§å“å’¨è¯¢çš„MMRæ£€ç´¢æ”¹ä¸ºsimilarityæ£€ç´¢
product_retriever = vectorstore.as_retriever(
    search_type="similarity",  # æ”¹ä¸ºsimilarityï¼Œé€Ÿåº¦æ›´å¿«
    search_kwargs={"k": 15}  # ä¿æŒæ£€ç´¢æ•°é‡
)
```

**ä¼˜ç‚¹**ï¼š
- é€Ÿåº¦æå‡ 2-3å€
- å®ç°ç®€å•ï¼Œåªéœ€ä¿®æ”¹ä¸€è¡Œä»£ç 
- å¯¹å¤§å¤šæ•°åœºæ™¯ï¼Œç›¸ä¼¼åº¦æ£€ç´¢å·²ç»è¶³å¤Ÿ

**ç¼ºç‚¹**ï¼š
- å¯èƒ½æ£€ç´¢åˆ°é‡å¤å†…å®¹ï¼ˆä½†LLMä¼šå¤„ç†ï¼‰

### æ–¹æ¡ˆ2ï¼šå‡å°‘æ£€ç´¢æ•°é‡

**é™ä½kå€¼ï¼Œå‡å°‘æ£€ç´¢çš„æ–‡æ¡£æ•°é‡**

```python
# ä¿®æ”¹ src/agents.py
product_retriever = vectorstore.as_retriever(
    search_type="similarity",
    search_kwargs={"k": 8}  # ä»15å‡å°‘åˆ°8
)
```

**ä¼˜ç‚¹**ï¼š
- å‘é‡æ£€ç´¢é€Ÿåº¦æ›´å¿«
- LLMå¤„ç†ä¸Šä¸‹æ–‡æ›´å°‘ï¼Œç”Ÿæˆç­”æ¡ˆæ›´å¿«

**ç¼ºç‚¹**ï¼š
- å¯èƒ½é—æ¼ç›¸å…³ä¿¡æ¯

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨æ›´å¿«çš„åµŒå…¥æ¨¡å‹

**åˆ‡æ¢åˆ°æ›´å¿«çš„åµŒå…¥æ¨¡å‹**

- ä½¿ç”¨ **Qwen3-Embedding-4B**ï¼ˆ2560ç»´ï¼‰è€Œä¸æ˜¯8Bç‰ˆæœ¬
- æˆ–ä½¿ç”¨æœ¬åœ°åµŒå…¥æ¨¡å‹ï¼ˆæœ€å¿«ï¼Œä½†éœ€è¦ä¸‹è½½æ¨¡å‹ï¼‰

### æ–¹æ¡ˆ4ï¼šæ·»åŠ ç¼“å­˜æœºåˆ¶

**ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢çš„ç»“æœ**

```python
from functools import lru_cache
import hashlib

@lru_cache(maxsize=100)
def cached_embed_query(query: str):
    """ç¼“å­˜æŸ¥è¯¢å‘é‡åŒ–ç»“æœ"""
    return embeddings.embed_query(query)
```

**ä¼˜ç‚¹**ï¼š
- ç›¸åŒæŸ¥è¯¢å¯ä»¥ç«‹å³è¿”å›
- å‡å°‘APIè°ƒç”¨æ¬¡æ•°

**ç¼ºç‚¹**ï¼š
- éœ€è¦é¢å¤–å†…å­˜
- åªå¯¹é‡å¤æŸ¥è¯¢æœ‰æ•ˆ

### æ–¹æ¡ˆ5ï¼šå¹¶è¡Œå¤„ç†ï¼ˆé«˜çº§ï¼‰

**åŒæ—¶è¿›è¡Œå‘é‡åŒ–å’Œåˆ†ç±»**

```python
import asyncio

async def parallel_retrieval(query, category):
    # å¹¶è¡Œæ‰§è¡Œå‘é‡åŒ–å’Œåˆ†ç±»
    embedding_task = asyncio.create_task(embeddings.aembed_query(query))
    category_task = asyncio.create_task(classify_email(query))
    
    embedding, category = await asyncio.gather(embedding_task, category_task)
    return embedding, category
```

### æ–¹æ¡ˆ6ï¼šä¼˜åŒ–è¶…æ—¶è®¾ç½®

**è°ƒæ•´APIè¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…**

```python
# ä¿®æ”¹ src/agents.py
embeddings = OpenAIEmbeddings(
    model=embedding_model,
    openai_api_key=api_key,
    openai_api_base="https://api.siliconflow.cn/v1",
    request_timeout=30  # ä»60ç§’å‡å°‘åˆ°30ç§’ï¼Œå¿«é€Ÿå¤±è´¥
)
```

## å¿«é€Ÿä¼˜åŒ–å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### ğŸš€ ç«‹å³å®æ–½ï¼ˆæ•ˆæœæœ€æ˜æ˜¾ï¼‰

1. **å°†MMRæ”¹ä¸ºsimilarityæ£€ç´¢**
   - ä¿®æ”¹ `src/agents.py` ç¬¬136è¡Œ
   - é¢„è®¡é€Ÿåº¦æå‡ï¼š2-3å€

2. **å‡å°‘æ£€ç´¢æ•°é‡**
   - å°†kä»15å‡å°‘åˆ°8-10
   - é¢„è®¡é€Ÿåº¦æå‡ï¼š20-30%

### âš¡ ä¸­æœŸä¼˜åŒ–

3. **ä½¿ç”¨æ›´å¿«çš„åµŒå…¥æ¨¡å‹**
   - ç¡®ä¿ä½¿ç”¨ Qwen3-Embedding-4B è€Œä¸æ˜¯8B
   - é¢„è®¡é€Ÿåº¦æå‡ï¼š30-50%

4. **æ·»åŠ æŸ¥è¯¢ç¼“å­˜**
   - å¯¹é‡å¤æŸ¥è¯¢è¿›è¡Œç¼“å­˜
   - é¢„è®¡é€Ÿåº¦æå‡ï¼šå¯¹é‡å¤æŸ¥è¯¢100%ï¼ˆç«‹å³è¿”å›ï¼‰

### ğŸ”§ é•¿æœŸä¼˜åŒ–

5. **ä¼˜åŒ–ç½‘ç»œè¿æ¥**
   - ä½¿ç”¨æ›´ç¨³å®šçš„ç½‘ç»œ
   - è€ƒè™‘ä½¿ç”¨ä»£ç†æˆ–CDN

6. **æ•°æ®åº“ä¼˜åŒ–**
   - å®šæœŸæ¸…ç†æ— ç”¨æ–‡æ¡£
   - é‡å»ºç´¢å¼•ä¼˜åŒ–æ€§èƒ½

## æ€§èƒ½ç›‘æ§

### æ·»åŠ æ€§èƒ½æ—¥å¿—

åœ¨ `src/nodes.py` çš„ `retrieve_from_rag` æ–¹æ³•ä¸­æ·»åŠ æ—¶é—´ç»Ÿè®¡ï¼š

```python
import time

def retrieve_from_rag(self, state: GraphState) -> GraphState:
    start_time = time.time()
    
    # ... ç°æœ‰ä»£ç  ...
    
    # åœ¨å…³é”®æ­¥éª¤è®°å½•æ—¶é—´
    embedding_start = time.time()
    # å‘é‡åŒ–æŸ¥è¯¢
    embedding_time = time.time() - embedding_start
    
    retrieval_start = time.time()
    # å‘é‡æ£€ç´¢
    retrieval_time = time.time() - retrieval_start
    
    llm_start = time.time()
    # LLMç”Ÿæˆç­”æ¡ˆ
    llm_time = time.time() - llm_start
    
    total_time = time.time() - start_time
    
    print(f"â±ï¸ [æ€§èƒ½] æ€»è€—æ—¶: {total_time:.2f}ç§’")
    print(f"  - å‘é‡åŒ–: {embedding_time:.2f}ç§’")
    print(f"  - æ£€ç´¢: {retrieval_time:.2f}ç§’")
    print(f"  - LLMç”Ÿæˆ: {llm_time:.2f}ç§’")
```

## æ€»ç»“

**æ£€ç´¢æ…¢çš„ä¸»è¦åŸå› **ï¼š
1. âœ… **ä¸æ˜¯æ¨¡å‹é—®é¢˜**ï¼Œè€Œæ˜¯**APIè°ƒç”¨æ¬¡æ•°å¤š**ï¼ˆ4-5æ¬¡ä¸²è¡Œè°ƒç”¨ï¼‰
2. âœ… **MMRæ£€ç´¢ç®—æ³•**æ¯”ç›¸ä¼¼åº¦æ£€ç´¢æ…¢
3. âœ… **ç½‘ç»œå»¶è¿Ÿ**å½±å“APIå“åº”æ—¶é—´

**æœ€å¿«è§æ•ˆçš„ä¼˜åŒ–**ï¼š
- å°†MMRæ”¹ä¸ºsimilarityæ£€ç´¢ï¼ˆ1è¡Œä»£ç ï¼Œé€Ÿåº¦æå‡2-3å€ï¼‰
- å‡å°‘æ£€ç´¢æ•°é‡kå€¼ï¼ˆé€Ÿåº¦æå‡20-30%ï¼‰

**å»ºè®®**ï¼šå…ˆå®æ–½æ–¹æ¡ˆ1å’Œ2ï¼Œè¿™ä¸¤ä¸ªæ”¹åŠ¨æœ€å°ï¼Œæ•ˆæœæœ€æ˜æ˜¾ã€‚

