# 终止处理检查点说明

## 最新更新（2024-12-21）

### 新增检查点

在验证邮件之后添加了**检查点7.5**，现在总共有**9个检查点**。

## 完整检查点列表

邮件处理过程中的9个终止检查点：

1. **检查点1：处理开始前**
   - 位置：`process_email_sync` 函数开始
   - 作用：在开始处理前检查是否被终止

2. **检查点2：分类后**
   - 位置：邮件分类完成后
   - 作用：分类是一个AI调用，完成后立即检查

3. **检查点3：RAG查询前**
   - 位置：开始RAG检索前
   - 作用：RAG查询前最后一次检查

4. **检查点4：RAG查询后**
   - 位置：RAG检索完成后
   - 作用：RAG查询是耗时操作，完成后立即检查

5. **检查点5：开始编写回复前**
   - 位置：打印"正在编写回复邮件..."后
   - 作用：进入重试循环前检查

6. **检查点6：每次重试前**
   - 位置：重试循环开始（`for trial in range(max_trials)`）
   - 作用：每次重试前检查，最多3次

7. **检查点7：验证前**
   - 位置：调用 `verify_generated_email` 前
   - 作用：验证前最后一次检查

8. **检查点7.5：验证后** ⭐ **新增**
   - 位置：调用 `verify_generated_email` 后
   - 作用：验证完成后立即检查，避免验证后无法终止的问题

9. **检查点8：保存回复前**
   - 位置：保存回复到邮件对象前
   - 作用：保存前最后一次检查

## 检查逻辑

`check_and_handle_stop` 函数会检查两个标志：

### 1. 全局停止标志（批量处理）

```python
if task_user_state.stop_processing:
    # 批量处理被终止
    # 恢复邮件状态为 pending
    # 发送 email_process_stopped WebSocket通知
    return True
```

### 2. 单封邮件停止标志

```python
if task_email_id in task_user_state.stopped_email_ids:
    # 单封邮件被终止
    # 恢复邮件状态为 pending
    # 清除终止标记
    # 发送 email_process_stopped WebSocket通知
    return True
```

## 为什么需要检查点7.5？

### 问题场景

用户在"正在验证生成的邮件..."时点击终止：

1. 验证操作是一个AI调用，可能需要几秒钟
2. 验证完成后，如果 `sendable = True`，会跳出循环
3. 直接到检查点8（保存回复前）
4. 如果验证很快完成，用户点击终止时可能已经过了检查点7，还没到检查点8
5. 导致无法及时终止

### 解决方案

在验证完成后立即添加检查点7.5：

```python
# 5. 验证邮件（同步阻塞操作）
verify_result = nodes.verify_generated_email(state)
state.update(verify_result)

# 检查点7.5：验证后
if check_and_handle_stop(f"验证后（第{trial+1}次尝试）"):
    return {'status': 'cancelled', 'message': '处理已终止', 'reply': None}

if state.get('sendable', False):
    break
```

### 效果

- 验证完成后立即检查终止标志
- 即使验证成功（`sendable = True`），也会先检查是否被终止
- 缩短终止响应时间

## 终止响应时间

| 阶段 | 最长等待时间 | 说明 |
|------|------------|------|
| 分类 | ~3秒 | AI分类调用 |
| RAG查询 | ~5秒 | 向量检索 + 文档召回 |
| 编写回复 | ~10秒 | AI生成回复 |
| 验证 | ~3秒 | AI验证回复 |
| 其他 | < 1秒 | 本地操作 |

**总结**：最长等待时间取决于当前正在执行的AI调用，通常在1-10秒之间。

## 相关文件

- `backend_api.py`：`process_email_sync` 函数和 `check_and_handle_stop` 函数
- `docs/终止处理功能完整实现说明.md`：完整实现文档
- `docs/终止处理功能测试指南.md`：测试指南
