# æ‘˜è¦è½®è¯¢ä¼˜åŒ–è¯´æ˜

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šæ¯æ¬¡æ‰“å¼€è¯¦æƒ…å¯¹è¯æ¡†éƒ½ä¼šå¯åŠ¨è½®è¯¢ï¼Œå³ä½¿æ‘˜è¦å·²ç»å­˜åœ¨ã€‚

## é—®é¢˜åˆ†æ

### åŸå§‹é€»è¾‘

```javascript
// å¦‚æœæœ‰æ‘˜è¦è¿˜åœ¨ç”Ÿæˆä¸­ï¼Œå¯åŠ¨è½®è¯¢æ£€æŸ¥
if (summary.bodyStatus === 'generating' || summary.replyStatus === 'generating') {
  summaryCheckInterval = setInterval(checkSummaryStatus, 2000)
}
```

**é—®é¢˜**ï¼š
- åˆ¤æ–­é€»è¾‘æ­£ç¡®ï¼Œä½†å¯èƒ½å› ä¸ºæ•°æ®é—®é¢˜å¯¼è‡´è¯¯åˆ¤
- ç¼ºå°‘è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œéš¾ä»¥è°ƒè¯•
- æ²¡æœ‰æ˜ç¡®åŒºåˆ†"æ— å†…å®¹"å’Œ"ç”Ÿæˆä¸­"çš„çŠ¶æ€

### å¯èƒ½çš„è¯¯åˆ¤åœºæ™¯

1. **æ‘˜è¦å­—æ®µä¸ºç©ºå­—ç¬¦ä¸²**
   ```javascript
   rawRecord.body_summary = ""  // ç©ºå­—ç¬¦ä¸²
   hasBodySummary = !!rawRecord.body_summary  // false
   // è¯¯åˆ¤ä¸º"ç”Ÿæˆä¸­"ï¼Œå¯åŠ¨è½®è¯¢
   ```

2. **æ‘˜è¦å­—æ®µä¸º null**
   ```javascript
   rawRecord.body_summary = null
   hasBodySummary = !!rawRecord.body_summary  // false
   // è¯¯åˆ¤ä¸º"ç”Ÿæˆä¸­"ï¼Œå¯åŠ¨è½®è¯¢
   ```

3. **æ‘˜è¦å­—æ®µä¸å­˜åœ¨**
   ```javascript
   rawRecord = { id: "xxx", subject: "xxx" }  // æ²¡æœ‰ body_summary å­—æ®µ
   hasBodySummary = !!rawRecord.body_summary  // false
   // æ­£ç¡®åˆ¤æ–­ä¸º"ç”Ÿæˆä¸­"ï¼Œå¯åŠ¨è½®è¯¢
   ```

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å¢å¼ºåˆ¤æ–­é€»è¾‘

```javascript
// ä¼˜åŒ–å‰
const hasBodySummary = rawRecord.body_summary

// ä¼˜åŒ–åï¼šæ˜ç¡®æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨ä¸”æœ‰å†…å®¹
const hasBodySummary = rawRecord.body_summary && rawRecord.body_summary.length > 0
```

### 2. æ·»åŠ è¯¦ç»†æ—¥å¿—

```javascript
// åŸå§‹é‚®ä»¶æ‘˜è¦
if (hasBodySummary) {
  summary.body = rawRecord.body_summary
  summary.bodyStatus = 'ready'
  console.log('[è¯¦æƒ…å¯¹è¯æ¡†] åŸå§‹é‚®ä»¶æ‘˜è¦å·²å­˜åœ¨ï¼Œé•¿åº¦:', rawRecord.body_summary.length)
} else if (rawRecord.body) {
  summary.body = rawRecord.body.length > 150 
    ? rawRecord.body.substring(0, 150) + '...' 
    : rawRecord.body
  summary.bodyStatus = 'generating'
  console.log('[è¯¦æƒ…å¯¹è¯æ¡†] åŸå§‹é‚®ä»¶æ‘˜è¦ç”Ÿæˆä¸­ï¼Œæ˜¾ç¤ºä¸´æ—¶é¢„è§ˆ')
} else {
  summary.body = ''
  summary.bodyStatus = 'none'
  console.log('[è¯¦æƒ…å¯¹è¯æ¡†] åŸå§‹é‚®ä»¶æ— å†…å®¹')
}
```

### 3. æ˜ç¡®è½®è¯¢æ¡ä»¶

```javascript
// åªæœ‰åœ¨æ‘˜è¦çœŸæ­£ç”Ÿæˆä¸­æ—¶æ‰å¯åŠ¨è½®è¯¢
const needPolling = summary.bodyStatus === 'generating' || summary.replyStatus === 'generating'

if (needPolling) {
  console.log('[è¯¦æƒ…å¯¹è¯æ¡†] æ‘˜è¦ç”Ÿæˆä¸­ï¼Œå¯åŠ¨è½®è¯¢æ£€æŸ¥', {
    bodyStatus: summary.bodyStatus,
    replyStatus: summary.replyStatus
  })
  summaryCheckInterval = setInterval(checkSummaryStatus, 2000)
} else {
  console.log('[è¯¦æƒ…å¯¹è¯æ¡†] æ‘˜è¦å·²å­˜åœ¨æˆ–æ— éœ€ç”Ÿæˆï¼Œä¸å¯åŠ¨è½®è¯¢', {
    bodyStatus: summary.bodyStatus,
    replyStatus: summary.replyStatus
  })
}
```

### 4. ä¼˜åŒ– WebSocket æ¶ˆæ¯å¤„ç†

```javascript
// æ”¶åˆ° WebSocket æ¶ˆæ¯åï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥åœæ­¢è½®è¯¢
if (currentRecord.value && msg.email_id === currentRecord.value.id) {
  if (msg.body_summary) {
    summary.body = msg.body_summary
    summary.bodyStatus = 'ready'
  }
  if (msg.reply_summary) {
    summary.reply = msg.reply_summary
    summary.replyStatus = 'ready'
  }
  
  // å¦‚æœä¸¤ä¸ªæ‘˜è¦éƒ½å·²ç”Ÿæˆï¼Œåœæ­¢è½®è¯¢
  if (summary.bodyStatus !== 'generating' && summary.replyStatus !== 'generating') {
    if (summaryCheckInterval) {
      clearInterval(summaryCheckInterval)
      summaryCheckInterval = null
      console.log('[WS] æ‰€æœ‰æ‘˜è¦å·²ç”Ÿæˆï¼Œåœæ­¢è½®è¯¢')
    }
  }
}
```

## çŠ¶æ€æœºè®¾è®¡

### æ‘˜è¦çŠ¶æ€

```javascript
// ä¸‰ç§çŠ¶æ€
'none'       // æ— å†…å®¹ï¼ˆæ—¢æ²¡æœ‰æ‘˜è¦ä¹Ÿæ²¡æœ‰åŸå§‹å†…å®¹ï¼‰
'generating' // ç”Ÿæˆä¸­ï¼ˆæœ‰åŸå§‹å†…å®¹ä½†æ²¡æœ‰æ‘˜è¦ï¼‰
'ready'      // å·²ç”Ÿæˆï¼ˆæœ‰æ‘˜è¦ï¼‰
```

### çŠ¶æ€è½¬æ¢

```
åˆå§‹çŠ¶æ€ï¼š
  - æœ‰æ‘˜è¦ â†’ 'ready'
  - æœ‰åŸå§‹å†…å®¹ä½†æ— æ‘˜è¦ â†’ 'generating'
  - æ— åŸå§‹å†…å®¹ â†’ 'none'

WebSocket æ¶ˆæ¯ï¼š
  'generating' â†’ 'ready'ï¼ˆæ”¶åˆ°æ‘˜è¦ï¼‰

è½®è¯¢æ£€æŸ¥ï¼š
  'generating' â†’ 'ready'ï¼ˆæ£€æµ‹åˆ°æ‘˜è¦ï¼‰
```

### è½®è¯¢å†³ç­–

```javascript
if (bodyStatus === 'generating' || replyStatus === 'generating') {
  // å¯åŠ¨è½®è¯¢
  startPolling()
} else {
  // ä¸å¯åŠ¨è½®è¯¢
  // - 'ready': æ‘˜è¦å·²å­˜åœ¨
  // - 'none': æ— å†…å®¹ï¼Œæ— éœ€ç”Ÿæˆæ‘˜è¦
}
```

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: æ‘˜è¦å·²å­˜åœ¨

**æ•°æ®**ï¼š
```json
{
  "id": "email-1",
  "body": "åŸå§‹é‚®ä»¶å†…å®¹...",
  "reply": "å›å¤å†…å®¹...",
  "body_summary": "åŸå§‹é‚®ä»¶æ‘˜è¦",
  "reply_summary": "å›å¤å†…å®¹æ‘˜è¦"
}
```

**é¢„æœŸè¡Œä¸º**ï¼š
1. æ‰“å¼€è¯¦æƒ…å¯¹è¯æ¡†
2. ç›´æ¥æ˜¾ç¤ºæ‘˜è¦
3. **ä¸å¯åŠ¨è½®è¯¢**
4. æ—¥å¿—è¾“å‡ºï¼š`[è¯¦æƒ…å¯¹è¯æ¡†] æ‘˜è¦å·²å­˜åœ¨æˆ–æ— éœ€ç”Ÿæˆï¼Œä¸å¯åŠ¨è½®è¯¢`

### åœºæ™¯ 2: æ‘˜è¦ç”Ÿæˆä¸­

**æ•°æ®**ï¼š
```json
{
  "id": "email-2",
  "body": "åŸå§‹é‚®ä»¶å†…å®¹...",
  "reply": "å›å¤å†…å®¹...",
  "body_summary": null,
  "reply_summary": null
}
```

**é¢„æœŸè¡Œä¸º**ï¼š
1. æ‰“å¼€è¯¦æƒ…å¯¹è¯æ¡†
2. æ˜¾ç¤ºä¸´æ—¶é¢„è§ˆï¼ˆæˆªå–å‰ 150 å­—ç¬¦ï¼‰
3. **å¯åŠ¨è½®è¯¢**
4. æ—¥å¿—è¾“å‡ºï¼š`[è¯¦æƒ…å¯¹è¯æ¡†] æ‘˜è¦ç”Ÿæˆä¸­ï¼Œå¯åŠ¨è½®è¯¢æ£€æŸ¥`
5. æ”¶åˆ° WebSocket æ¶ˆæ¯æˆ–è½®è¯¢æ£€æµ‹åˆ°æ‘˜è¦åï¼Œåœæ­¢è½®è¯¢

### åœºæ™¯ 3: æ— å†…å®¹

**æ•°æ®**ï¼š
```json
{
  "id": "email-3",
  "body": "",
  "reply": ""
}
```

**é¢„æœŸè¡Œä¸º**ï¼š
1. æ‰“å¼€è¯¦æƒ…å¯¹è¯æ¡†
2. ä¸æ˜¾ç¤ºæ‘˜è¦åŒºåŸŸ
3. **ä¸å¯åŠ¨è½®è¯¢**
4. æ—¥å¿—è¾“å‡ºï¼š`[è¯¦æƒ…å¯¹è¯æ¡†] åŸå§‹é‚®ä»¶æ— å†…å®¹`

### åœºæ™¯ 4: éƒ¨åˆ†æ‘˜è¦å­˜åœ¨

**æ•°æ®**ï¼š
```json
{
  "id": "email-4",
  "body": "åŸå§‹é‚®ä»¶å†…å®¹...",
  "reply": "å›å¤å†…å®¹...",
  "body_summary": "åŸå§‹é‚®ä»¶æ‘˜è¦",
  "reply_summary": null
}
```

**é¢„æœŸè¡Œä¸º**ï¼š
1. æ‰“å¼€è¯¦æƒ…å¯¹è¯æ¡†
2. åŸå§‹é‚®ä»¶æ‘˜è¦ï¼šç›´æ¥æ˜¾ç¤º
3. å›å¤å†…å®¹æ‘˜è¦ï¼šæ˜¾ç¤ºä¸´æ—¶é¢„è§ˆ
4. **å¯åŠ¨è½®è¯¢**ï¼ˆå› ä¸ºå›å¤æ‘˜è¦è¿˜åœ¨ç”Ÿæˆä¸­ï¼‰
5. æ”¶åˆ°å›å¤æ‘˜è¦åï¼Œåœæ­¢è½®è¯¢

## è°ƒè¯•æ–¹æ³•

### 1. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

æ‰“å¼€è¯¦æƒ…å¯¹è¯æ¡†æ—¶ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```javascript
// æ‘˜è¦å·²å­˜åœ¨
[è¯¦æƒ…å¯¹è¯æ¡†] åŸå§‹é‚®ä»¶æ‘˜è¦å·²å­˜åœ¨ï¼Œé•¿åº¦: 126
[è¯¦æƒ…å¯¹è¯æ¡†] å›å¤å†…å®¹æ‘˜è¦å·²å­˜åœ¨ï¼Œé•¿åº¦: 98
[è¯¦æƒ…å¯¹è¯æ¡†] æ‘˜è¦å·²å­˜åœ¨æˆ–æ— éœ€ç”Ÿæˆï¼Œä¸å¯åŠ¨è½®è¯¢ {bodyStatus: 'ready', replyStatus: 'ready'}

// æˆ–è€…æ‘˜è¦ç”Ÿæˆä¸­
[è¯¦æƒ…å¯¹è¯æ¡†] åŸå§‹é‚®ä»¶æ‘˜è¦ç”Ÿæˆä¸­ï¼Œæ˜¾ç¤ºä¸´æ—¶é¢„è§ˆ
[è¯¦æƒ…å¯¹è¯æ¡†] å›å¤å†…å®¹æ‘˜è¦ç”Ÿæˆä¸­ï¼Œæ˜¾ç¤ºä¸´æ—¶é¢„è§ˆ
[è¯¦æƒ…å¯¹è¯æ¡†] æ‘˜è¦ç”Ÿæˆä¸­ï¼Œå¯åŠ¨è½®è¯¢æ£€æŸ¥ {bodyStatus: 'generating', replyStatus: 'generating'}
```

### 2. æ£€æŸ¥æ•°æ®

åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// æŸ¥çœ‹å½“å‰è®°å½•
console.log(currentRecord.value)

// æŸ¥çœ‹æ‘˜è¦çŠ¶æ€
console.log({
  bodyStatus: summary.bodyStatus,
  replyStatus: summary.replyStatus,
  hasBodySummary: !!currentRecord.value?.body_summary,
  hasReplySummary: !!currentRecord.value?.reply_summary
})
```

### 3. æ£€æŸ¥è½®è¯¢çŠ¶æ€

```javascript
// æŸ¥çœ‹æ˜¯å¦åœ¨è½®è¯¢
console.log('è½®è¯¢çŠ¶æ€:', summaryCheckInterval !== null)
```

## æ€§èƒ½ä¼˜åŒ–

### ä¼˜åŒ–å‰

- æ¯æ¬¡æ‰“å¼€è¯¦æƒ…éƒ½å¯èƒ½å¯åŠ¨è½®è¯¢
- å³ä½¿æ‘˜è¦å·²å­˜åœ¨ï¼Œä¹Ÿä¼šæ¯ 2 ç§’è¯·æ±‚ä¸€æ¬¡ API
- æµªè´¹ç½‘ç»œèµ„æºå’ŒæœåŠ¡å™¨èµ„æº

### ä¼˜åŒ–å

- åªæœ‰åœ¨æ‘˜è¦çœŸæ­£ç”Ÿæˆä¸­æ—¶æ‰è½®è¯¢
- æ‘˜è¦å·²å­˜åœ¨æ—¶ï¼Œä¸å‘èµ·ä»»ä½•è¯·æ±‚
- æ”¶åˆ° WebSocket æ¶ˆæ¯åç«‹å³åœæ­¢è½®è¯¢

### æ€§èƒ½å¯¹æ¯”

å‡è®¾ç”¨æˆ·æŸ¥çœ‹ 10 å°å·²æœ‰æ‘˜è¦çš„é‚®ä»¶ï¼š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| å¯åŠ¨è½®è¯¢æ¬¡æ•° | 10 æ¬¡ | 0 æ¬¡ |
| API è¯·æ±‚æ¬¡æ•° | 50+ æ¬¡ï¼ˆæ¯å°é‚®ä»¶è½®è¯¢å¤šæ¬¡ï¼‰ | 0 æ¬¡ |
| ç½‘ç»œæµé‡ | é«˜ | æ—  |
| æœåŠ¡å™¨è´Ÿè½½ | é«˜ | æ—  |

## æ€»ç»“

### ä¼˜åŒ–è¦ç‚¹

1. âœ… **æ˜ç¡®åˆ¤æ–­æ¡ä»¶** - åŒºåˆ†"æ— å†…å®¹"ã€"ç”Ÿæˆä¸­"ã€"å·²ç”Ÿæˆ"
2. âœ… **è¯¦ç»†æ—¥å¿—è¾“å‡º** - ä¾¿äºè°ƒè¯•å’Œç›‘æ§
3. âœ… **åŠæ—¶åœæ­¢è½®è¯¢** - WebSocket æ¶ˆæ¯æˆ–æ£€æµ‹åˆ°æ‘˜è¦åç«‹å³åœæ­¢
4. âœ… **é¿å…ä¸å¿…è¦çš„è¯·æ±‚** - æ‘˜è¦å·²å­˜åœ¨æ—¶ä¸å¯åŠ¨è½®è¯¢

### ç”¨æˆ·ä½“éªŒæå‡

- âš¡ **æ›´å¿«çš„å“åº”** - æ‘˜è¦å·²å­˜åœ¨æ—¶ç«‹å³æ˜¾ç¤ºï¼Œæ— å»¶è¿Ÿ
- ğŸ“‰ **æ›´å°‘çš„ç½‘ç»œè¯·æ±‚** - å‡å°‘ä¸å¿…è¦çš„ API è°ƒç”¨
- ğŸ”‹ **æ›´ä½çš„èµ„æºæ¶ˆè€—** - å‡å°‘å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„è´Ÿè½½
- ğŸ¯ **æ›´å‡†ç¡®çš„çŠ¶æ€æ˜¾ç¤º** - æ˜ç¡®åŒºåˆ†ä¸åŒçŠ¶æ€

è¿™ä¸ªä¼˜åŒ–ç¡®ä¿äº†è½®è¯¢åªåœ¨çœŸæ­£éœ€è¦æ—¶æ‰å¯åŠ¨ï¼Œå¤§å¤§æå‡äº†æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚
