# æ¸…ç†æ—§å†å²è®°å½•æŒ‡å—

## èƒŒæ™¯

æ‘˜è¦ç”ŸæˆåŠŸèƒ½æ˜¯æ–°å¢çš„åŠŸèƒ½ï¼Œä¹‹å‰å¤„ç†çš„é‚®ä»¶æ²¡æœ‰æ‘˜è¦ã€‚è¿™äº›æ—§è®°å½•å¯ä»¥åˆ é™¤ï¼Œä»¥ä¾¿ï¼š
1. æ¸…ç†æ— ç”¨æ•°æ®
2. å‡å°‘å­˜å‚¨ç©ºé—´
3. æå‡ç³»ç»Ÿæ€§èƒ½
4. é¿å…ç”¨æˆ·çœ‹åˆ°"æ‘˜è¦ç”Ÿæˆä¸­"çš„æ—§è®°å½•

## æ–¹æ¡ˆé€‰æ‹©

### æ–¹æ¡ˆ 1: ä½¿ç”¨ Python è„šæœ¬ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… å¯ä»¥æ‰¹é‡å¤„ç†æ‰€æœ‰ç”¨æˆ·
- âœ… æ”¯æŒè¯•è¿è¡Œæ¨¡å¼ï¼ˆå…ˆé¢„è§ˆå†åˆ é™¤ï¼‰
- âœ… å¯ä»¥æŒ‡å®šæ—¥æœŸèŒƒå›´
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
- âš ï¸ éœ€è¦åœæ­¢åç«¯æœåŠ¡ï¼ˆé¿å…æ•°æ®å†²çªï¼‰

### æ–¹æ¡ˆ 2: ä½¿ç”¨ API ç«¯ç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… å¯ä»¥åœ¨å‰ç«¯ç•Œé¢æ“ä½œ
- âœ… ä¸éœ€è¦åœæ­¢æœåŠ¡
- âœ… ç”¨æˆ·å¯ä»¥è‡ªå·±æ¸…ç†

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ¯æ¬¡åªèƒ½æ¸…ç†ä¸€ä¸ªç”¨æˆ·
- âš ï¸ éœ€è¦æ·»åŠ å‰ç«¯ç•Œé¢

## æ–¹æ¡ˆ 1: ä½¿ç”¨ Python è„šæœ¬

### 1. è¯•è¿è¡Œæ¨¡å¼ï¼ˆæ¨èå…ˆè¿è¡Œï¼‰

æŸ¥çœ‹å°†è¦åˆ é™¤å“ªäº›è®°å½•ï¼Œä½†ä¸å®é™…åˆ é™¤ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰è®°å½•
python scripts/clear_old_history.py

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰è®°å½•
python scripts/clear_old_history.py --username admin

# æŸ¥çœ‹ 2025-12-20 ä¹‹å‰çš„è®°å½•
python scripts/clear_old_history.py --before 2025-12-20

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·åœ¨ 2025-12-20 ä¹‹å‰çš„è®°å½•
python scripts/clear_old_history.py --username admin --before 2025-12-20
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
============================================================
æ¸…ç†æ—§çš„å†å²è®°å½•
============================================================
ğŸ“Œ ç”¨æˆ·: æ‰€æœ‰ç”¨æˆ·
ğŸ“… åˆ é™¤æ—¥æœŸ: 2025-12-20 ä¹‹å‰çš„è®°å½•
ğŸ” æ¨¡å¼: è¯•è¿è¡Œï¼ˆä¸ä¼šå®é™…åˆ é™¤ï¼‰
============================================================

ğŸ“Š ç”¨æˆ· admin: åŸæœ‰ 15 æ¡è®°å½•ï¼Œå°†åˆ é™¤ 10 æ¡ï¼Œä¿ç•™ 5 æ¡
  - å°†åˆ é™¤: 2025-12-18 | å®¢æœæ€åº¦æ¶åŠ£ï¼Œé—®é¢˜å¤„ç†ä¸åŠæ—¶
  - å°†åˆ é™¤: 2025-12-19 | äº§å“å’¨è¯¢
  ...

============================================================
ğŸ” è¯•è¿è¡Œæ¨¡å¼: å…±å°†åˆ é™¤ 10 æ¡è®°å½•
ğŸ’¡ è¦å®é™…åˆ é™¤ï¼Œè¯·è¿è¡Œ: python scripts/clear_old_history.py --execute
============================================================
```

### 2. å®é™…æ‰§è¡Œåˆ é™¤

ç¡®è®¤æ— è¯¯åï¼Œæ·»åŠ  `--execute` å‚æ•°å®é™…åˆ é™¤ï¼š

```bash
# åˆ é™¤æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰è®°å½•
python scripts/clear_old_history.py --execute

# åˆ é™¤ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰è®°å½•
python scripts/clear_old_history.py --username admin --execute

# åˆ é™¤ 2025-12-20 ä¹‹å‰çš„è®°å½•
python scripts/clear_old_history.py --before 2025-12-20 --execute

# åˆ é™¤ç‰¹å®šç”¨æˆ·åœ¨ 2025-12-20 ä¹‹å‰çš„è®°å½•
python scripts/clear_old_history.py --username admin --before 2025-12-20 --execute
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
============================================================
æ¸…ç†æ—§çš„å†å²è®°å½•
============================================================
ğŸ“Œ ç”¨æˆ·: admin
ğŸ“… åˆ é™¤æ—¥æœŸ: 2025-12-20 ä¹‹å‰çš„è®°å½•
âš ï¸ æ¨¡å¼: å®é™…æ‰§è¡Œ
============================================================

ç¡®è®¤è¦åˆ é™¤å—ï¼Ÿ(yes/no): yes

ğŸ“Š ç”¨æˆ· admin: åŸæœ‰ 15 æ¡è®°å½•ï¼Œå°†åˆ é™¤ 10 æ¡ï¼Œä¿ç•™ 5 æ¡
âœ… å·²ä¿å­˜: data/users/user_email_data_admin.json

============================================================
âœ… å·²åˆ é™¤ 10 æ¡è®°å½•
============================================================
```

### 3. å¸¸ç”¨åœºæ™¯

#### åœºæ™¯ 1: åˆ é™¤æ‰€æœ‰æ—§è®°å½•ï¼ˆæœ€å½»åº•ï¼‰

```bash
# å…ˆè¯•è¿è¡ŒæŸ¥çœ‹
python scripts/clear_old_history.py

# ç¡®è®¤åæ‰§è¡Œ
python scripts/clear_old_history.py --execute
```

#### åœºæ™¯ 2: åªåˆ é™¤æŸä¸ªæ—¥æœŸä¹‹å‰çš„è®°å½•

```bash
# ä¾‹å¦‚ï¼šåˆ é™¤ 2025-12-20 ä¹‹å‰çš„è®°å½•ï¼ˆä¿ç•™ 12-20 åŠä¹‹åçš„ï¼‰
python scripts/clear_old_history.py --before 2025-12-20 --execute
```

#### åœºæ™¯ 3: åªæ¸…ç†ç‰¹å®šç”¨æˆ·

```bash
# åªæ¸…ç† admin ç”¨æˆ·çš„è®°å½•
python scripts/clear_old_history.py --username admin --execute
```

### 4. æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æç¤º**ï¼š

1. **å¤‡ä»½æ•°æ®**
   ```bash
   # åœ¨åˆ é™¤å‰å¤‡ä»½ç”¨æˆ·æ•°æ®
   cp -r data/users data/users_backup_$(date +%Y%m%d)
   ```

2. **åœæ­¢åç«¯æœåŠ¡**
   - è¿è¡Œè„šæœ¬å‰ï¼Œå»ºè®®åœæ­¢åç«¯æœåŠ¡
   - é¿å…æ•°æ®å†²çª

3. **ç¡®è®¤æ—¥æœŸæ ¼å¼**
   - æ—¥æœŸæ ¼å¼å¿…é¡»æ˜¯ `YYYY-MM-DD`
   - ä¾‹å¦‚ï¼š`2025-12-20`

4. **å…ˆè¯•è¿è¡Œ**
   - å§‹ç»ˆå…ˆè¿è¡Œè¯•è¿è¡Œæ¨¡å¼
   - ç¡®è®¤è¦åˆ é™¤çš„è®°å½•æ— è¯¯åå†æ‰§è¡Œ

## æ–¹æ¡ˆ 2: ä½¿ç”¨ API ç«¯ç‚¹

### API æ¥å£

```http
POST /api/history/clear
Content-Type: application/json
Cookie: session=xxx

{
  "before_date": "2025-12-20"  // å¯é€‰ï¼Œä¸æä¾›åˆ™åˆ é™¤æ‰€æœ‰è®°å½•
}
```

### ä½¿ç”¨ curl è°ƒç”¨

```bash
# åˆ é™¤æ‰€æœ‰è®°å½•
curl -X POST http://localhost:8000/api/history/clear \
  -H "Cookie: session=your_session_token" \
  -H "Content-Type: application/json"

# åˆ é™¤ 2025-12-20 ä¹‹å‰çš„è®°å½•
curl -X POST http://localhost:8000/api/history/clear \
  -H "Cookie: session=your_session_token" \
  -H "Content-Type: application/json" \
  -d '{"before_date": "2025-12-20"}'
```

### å“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "message": "æˆåŠŸåˆ é™¤ 10 æ¡è®°å½•",
  "deleted_count": 10,
  "remaining_count": 5
}
```

### åœ¨å‰ç«¯æ·»åŠ æ¸…ç†æŒ‰é’®ï¼ˆå¯é€‰ï¼‰

å¯ä»¥åœ¨å†å²è®°å½•é¡µé¢æ·»åŠ ä¸€ä¸ª"æ¸…ç†æ—§è®°å½•"æŒ‰é’®ï¼š

```javascript
// åœ¨ History.vue ä¸­æ·»åŠ 
const clearOldHistory = async () => {
  try {
    const confirm = await ElMessageBox.confirm(
      'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
      'è­¦å‘Š',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    )
    
    const res = await historyApi.clearHistory()
    
    if (res.success) {
      ElMessage.success(res.message)
      // åˆ·æ–°åˆ—è¡¨
      fetchHistory()
    }
  } catch (e) {
    if (e !== 'cancel') {
      ElMessage.error('æ¸…ç†å¤±è´¥')
    }
  }
}
```

## æ¨èæµç¨‹

### ç¬¬ä¸€æ¬¡æ¸…ç†ï¼ˆæ¨èï¼‰

1. **å¤‡ä»½æ•°æ®**
   ```bash
   cp -r data/users data/users_backup_$(date +%Y%m%d)
   ```

2. **åœæ­¢åç«¯æœåŠ¡**
   ```bash
   # æŒ‰ Ctrl+C åœæ­¢åç«¯
   ```

3. **è¯•è¿è¡ŒæŸ¥çœ‹**
   ```bash
   python scripts/clear_old_history.py
   ```

4. **ç¡®è®¤åæ‰§è¡Œ**
   ```bash
   python scripts/clear_old_history.py --execute
   ```

5. **å¯åŠ¨åç«¯æœåŠ¡**
   ```bash
   python backend_api.py
   ```

6. **éªŒè¯ç»“æœ**
   - æ‰“å¼€å‰ç«¯ï¼ŒæŸ¥çœ‹å†å²è®°å½•é¡µé¢
   - ç¡®è®¤æ—§è®°å½•å·²åˆ é™¤

### æ—¥å¸¸æ¸…ç†ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å®šæœŸæ¸…ç†ï¼Œå¯ä»¥ï¼š

1. **ä½¿ç”¨ API ç«¯ç‚¹**
   - åœ¨å‰ç«¯æ·»åŠ æ¸…ç†æŒ‰é’®
   - ç”¨æˆ·å¯ä»¥è‡ªå·±æ¸…ç†

2. **å®šæ—¶ä»»åŠ¡**
   ```bash
   # æ·»åŠ åˆ° crontabï¼Œæ¯å‘¨æ—¥å‡Œæ™¨ 2 ç‚¹æ¸…ç† 30 å¤©å‰çš„è®°å½•
   0 2 * * 0 cd /path/to/project && python scripts/clear_old_history.py --before $(date -d '30 days ago' +%Y-%m-%d) --execute
   ```

## å¸¸è§é—®é¢˜

### Q1: åˆ é™¤åèƒ½æ¢å¤å—ï¼Ÿ

**A**: ä¸èƒ½ã€‚åˆ é™¤æ˜¯æ°¸ä¹…æ€§çš„ã€‚å»ºè®®ï¼š
- åˆ é™¤å‰å¤‡ä»½æ•°æ®
- å…ˆä½¿ç”¨è¯•è¿è¡Œæ¨¡å¼ç¡®è®¤

### Q2: ä¼šå½±å“æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿå—ï¼Ÿ

**A**: å¦‚æœä½¿ç”¨è„šæœ¬ï¼š
- å»ºè®®åœæ­¢åç«¯æœåŠ¡
- é¿å…æ•°æ®å†²çª

å¦‚æœä½¿ç”¨ APIï¼š
- ä¸éœ€è¦åœæ­¢æœåŠ¡
- ä½†å¯èƒ½å½±å“æ­£åœ¨æŸ¥çœ‹å†å²è®°å½•çš„ç”¨æˆ·

### Q3: åˆ é™¤åç»Ÿè®¡æ•°æ®ä¼šå˜å—ï¼Ÿ

**A**: ä¼šçš„ã€‚å†å²è®°å½•åˆ é™¤åï¼š
- Dashboard çš„ç»Ÿè®¡æ•°æ®ä¼šæ›´æ–°
- å›¾è¡¨ä¼šåæ˜ æ–°çš„æ•°æ®

### Q4: èƒ½åªåˆ é™¤æ²¡æœ‰æ‘˜è¦çš„è®°å½•å—ï¼Ÿ

**A**: å¯ä»¥ä¿®æ”¹è„šæœ¬å®ç°ï¼š

```python
# åœ¨ clear_old_history.py ä¸­ä¿®æ”¹è¿‡æ»¤é€»è¾‘
if not record.get('body_summary') and not record.get('reply_summary'):
    deleted_count += 1
else:
    filtered_history.append(record)
```

### Q5: åˆ é™¤åé‚®ä»¶ç¼“å­˜ä¼šå—å½±å“å—ï¼Ÿ

**A**: ä¸ä¼šã€‚åˆ é™¤çš„åªæ˜¯å†å²è®°å½•ï¼ˆ`history`ï¼‰ï¼Œä¸å½±å“é‚®ä»¶ç¼“å­˜ï¼ˆ`emails_cache`ï¼‰ã€‚

## æ€»ç»“

### æ¨èæ–¹æ¡ˆ

å¯¹äºä½ çš„æƒ…å†µï¼ˆæ¸…ç†æ‘˜è¦åŠŸèƒ½å®ç°ä¹‹å‰çš„è®°å½•ï¼‰ï¼Œæ¨èï¼š

1. **ä½¿ç”¨ Python è„šæœ¬**
2. **åˆ é™¤æ‰€æœ‰æ—§è®°å½•**ï¼ˆå› ä¸ºéƒ½æ²¡æœ‰æ‘˜è¦ï¼‰
3. **å…ˆå¤‡ä»½ï¼Œå†è¯•è¿è¡Œï¼Œæœ€åæ‰§è¡Œ**

### å‘½ä»¤

```bash
# 1. å¤‡ä»½
cp -r data/users data/users_backup_$(date +%Y%m%d)

# 2. åœæ­¢åç«¯
# æŒ‰ Ctrl+C

# 3. è¯•è¿è¡Œ
python scripts/clear_old_history.py

# 4. æ‰§è¡Œåˆ é™¤
python scripts/clear_old_history.py --execute

# 5. å¯åŠ¨åç«¯
python backend_api.py
```

è¿™æ ·å¯ä»¥ä¸€æ¬¡æ€§æ¸…ç†æ‰€æœ‰æ—§è®°å½•ï¼Œä¹‹åæ–°å¤„ç†çš„é‚®ä»¶éƒ½ä¼šæœ‰æ‘˜è¦åŠŸèƒ½ã€‚
