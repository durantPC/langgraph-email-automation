# ğŸ“§ é‚®ä»¶è‡ªåŠ¨åŒ–ç³»ç»Ÿ - è¯´æ˜æ–‡æ¡£

> ğŸ“‹ **æ–‡æ¡£å¯¼èˆª**: [è¿”å›æ–‡æ¡£ç´¢å¼•](README.md) | [å¿«é€Ÿä¸Šæ‰‹](ä½¿ç”¨æ–‡æ¡£.md)

## ğŸ“– ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [é¡¹ç›®ç›®å½•ç»“æ„](#é¡¹ç›®ç›®å½•ç»“æ„)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [APIæ¥å£](#apiæ¥å£)
- [æ•°æ®åº“ç»“æ„](#æ•°æ®åº“ç»“æ„)
- [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## é¡¹ç›®æ¦‚è¿°

### ç®€ä»‹

é‚®ä»¶è‡ªåŠ¨åŒ–ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäº **LangChain**ã€**LangGraph**ã€**AIä»£ç†** å’Œ **RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰** æŠ€æœ¯çš„æ™ºèƒ½å®¢æˆ·æ”¯æŒé‚®ä»¶å¤„ç†ç³»ç»Ÿã€‚ç³»ç»Ÿä½¿ç”¨ LangChain æ¡†æ¶æ„å»º AI åº”ç”¨ï¼Œé€šè¿‡ LangGraph å®ç°å¤æ‚çš„å·¥ä½œæµç¼–æ’ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æ¥æ”¶é‚®ä»¶ã€æ™ºèƒ½åˆ†ç±»ã€æ£€ç´¢ç›¸å…³çŸ¥è¯†åº“ã€ç”Ÿæˆä¸“ä¸šå›å¤ï¼Œå¹¶æ”¯æŒäººå·¥å®¡æ ¸å’Œæ‰¹é‡å¤„ç†ã€‚

**æ ¸å¿ƒæŠ€æœ¯æ ˆ**ï¼š
- **LangChain** - LLMåº”ç”¨å¼€å‘æ¡†æ¶ï¼Œæä¾›ç»Ÿä¸€çš„APIå’Œå·¥å…·é“¾
- **LangGraph** - åŸºäºLangChainçš„çŠ¶æ€å›¾å·¥ä½œæµå¼•æ“
- **RAGæŠ€æœ¯** - æ£€ç´¢å¢å¼ºç”Ÿæˆï¼Œç»“åˆå‘é‡æ•°æ®åº“å’ŒLLM
- **FastAPI** - ç°ä»£Python Webæ¡†æ¶
- **Vue 3** - å‰ç«¯æ¡†æ¶

### æ ¸å¿ƒç‰¹æ€§

- ğŸ¤– **æ™ºèƒ½åˆ†ç±»**ï¼šè‡ªåŠ¨è¯†åˆ«é‚®ä»¶ç±»å‹ï¼ˆäº§å“å’¨è¯¢/å®¢æˆ·æŠ•è¯‰/å®¢æˆ·åé¦ˆ/æ— å…³é‚®ä»¶ï¼‰
- ğŸ” **RAGæ£€ç´¢**ï¼šåŸºäºå‘é‡æ•°æ®åº“æ£€ç´¢ç›¸å…³çŸ¥è¯†ï¼Œç”Ÿæˆç²¾å‡†å›å¤
- âœï¸ **è‡ªåŠ¨ç”Ÿæˆ**ï¼šAIç”Ÿæˆä¸“ä¸šã€å‹å¥½çš„é‚®ä»¶å›å¤å†…å®¹
- âœ… **è´¨é‡æ ¡éªŒ**ï¼šè‡ªåŠ¨æ ¡éªŒå›å¤è´¨é‡ï¼Œç¡®ä¿ä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§
- ğŸŒ **Webç®¡ç†**ï¼šæä¾›ç¾è§‚çš„Webç•Œé¢ï¼Œæ”¯æŒé‚®ä»¶ç®¡ç†ã€çŸ¥è¯†åº“ç®¡ç†ã€å†å²æŸ¥è¯¢
- ğŸ“Š **æ•°æ®åˆ†æ**ï¼šæä¾›å¤„ç†ç»Ÿè®¡ã€å¯¼å‡ºæŠ¥è¡¨ç­‰åŠŸèƒ½

### åº”ç”¨åœºæ™¯

- å®¢æˆ·æ”¯æŒå›¢é˜Ÿè‡ªåŠ¨åŒ–å¤„ç†å¸¸è§å’¨è¯¢
- äº§å“å”®å‰/å”®åè‡ªåŠ¨å›å¤
- æ‰¹é‡é‚®ä»¶å¤„ç†å’Œå½’æ¡£
- çŸ¥è¯†åº“é©±åŠ¨çš„æ™ºèƒ½é—®ç­”

---

## é¡¹ç›®ç›®å½•ç»“æ„

### å®Œæ•´ç›®å½•æ ‘

```
langgraph-email-automation/
â”‚
â”œâ”€â”€ ğŸ“„ æ ¹ç›®å½•æ–‡ä»¶
â”‚   â”œâ”€â”€ README.md                    # é¡¹ç›®ä¸»æ–‡æ¡£
â”‚   â”œâ”€â”€ requirements.txt             # Pythonä¾èµ–åˆ—è¡¨
â”‚   â”œâ”€â”€ package-lock.json            # Node.jsä¾èµ–é”å®šæ–‡ä»¶
â”‚   â”œâ”€â”€ .env                         # ç¯å¢ƒå˜é‡é…ç½®ï¼ˆéœ€è‡ªè¡Œåˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ workflow.png                 # å·¥ä½œæµç¤ºæ„å›¾
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸš€ å¯åŠ¨æ–‡ä»¶
â”‚   â”œâ”€â”€ backend_api.py              # åç«¯APIæœåŠ¡ï¼ˆFastAPIï¼‰
â”‚   â”œâ”€â”€ main.py                      # å‘½ä»¤è¡Œå•æ¬¡è¿è¡Œæ¨¡å¼
â”‚   â”œâ”€â”€ main_continuous.py           # å‘½ä»¤è¡ŒæŒç»­ç›‘æ§æ¨¡å¼
â”‚   â”œâ”€â”€ start.bat                    # Windowsä¸€é”®å¯åŠ¨è„šæœ¬
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ—„ï¸ æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”œâ”€â”€ create_index.py              # åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆé»˜è®¤ï¼‰
â”‚   â”œâ”€â”€ create_index_1024.py        # åˆ›å»º1024ç»´å‘é‡ç´¢å¼•
â”‚   â”œâ”€â”€ create_index_2560.py        # åˆ›å»º2560ç»´å‘é‡ç´¢å¼•
â”‚   â”œâ”€â”€ create_index_4096.py        # åˆ›å»º4096ç»´å‘é‡ç´¢å¼•
â”‚   â”œâ”€â”€ clear_db.py                  # æ¸…ç†å‘é‡æ•°æ®åº“
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“Š æ•°æ®æ–‡ä»¶
â”‚       â”œâ”€â”€ user_data.json           # ç”¨æˆ·è´¦å·æ•°æ®
â”‚       â”œâ”€â”€ username_mapping.json    # ç”¨æˆ·åæ˜ å°„
â”‚       â””â”€â”€ user_email_data_*.json  # ç”¨æˆ·é‚®ä»¶å¤„ç†å†å²ï¼ˆæŒ‰ç”¨æˆ·ï¼‰
â”‚
â”œâ”€â”€ ğŸ“ src/                          # åç«¯æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ agents.py                    # AIä»£ç†å®šä¹‰ï¼ˆLangChainï¼‰
â”‚   â”œâ”€â”€ graph.py                     # LangGraphå·¥ä½œæµå®šä¹‰
â”‚   â”œâ”€â”€ nodes.py                     # å·¥ä½œæµèŠ‚ç‚¹å®ç°
â”‚   â”œâ”€â”€ prompts.py                   # æç¤ºè¯æ¨¡æ¿
â”‚   â”œâ”€â”€ state.py                     # çŠ¶æ€å®šä¹‰ï¼ˆGraphStateï¼‰
â”‚   â”œâ”€â”€ structure_outputs.py         # ç»“æ„åŒ–è¾“å‡ºå®šä¹‰ï¼ˆPydanticï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ tools/                       # å·¥å…·ç±»
â”‚       â””â”€â”€ QQEmailTools.py          # QQé‚®ç®±æ“ä½œå·¥å…·ï¼ˆIMAP/SMTPï¼‰
â”‚
â”œâ”€â”€ ğŸ“ frontend/                     # å‰ç«¯é¡¹ç›®ï¼ˆVue 3ï¼‰
â”‚   â”œâ”€â”€ package.json                 # å‰ç«¯ä¾èµ–é…ç½®
â”‚   â”œâ”€â”€ vite.config.js               # Viteæ„å»ºé…ç½®
â”‚   â”œâ”€â”€ index.html                   # HTMLå…¥å£æ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ public/                      # é™æ€èµ„æº
â”‚   â”‚   â””â”€â”€ favicon.svg              # ç½‘ç«™å›¾æ ‡
â”‚   â”‚
â”‚   â””â”€â”€ src/                         # æºä»£ç 
â”‚       â”œâ”€â”€ main.js                  # åº”ç”¨å…¥å£
â”‚       â”œâ”€â”€ App.vue                  # æ ¹ç»„ä»¶
â”‚       â”‚
â”‚       â”œâ”€â”€ views/                    # é¡µé¢ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ Layout.vue           # å¸ƒå±€ç»„ä»¶ï¼ˆä¾§è¾¹æ ã€å¯¼èˆªï¼‰
â”‚       â”‚   â”œâ”€â”€ Dashboard.vue         # ä»ªè¡¨ç›˜ï¼ˆç»Ÿè®¡å›¾è¡¨ï¼‰
â”‚       â”‚   â”œâ”€â”€ Emails.vue           # é‚®ä»¶ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ Knowledge.vue        # çŸ¥è¯†åº“ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ History.vue          # å†å²è®°å½•
â”‚       â”‚   â”œâ”€â”€ Settings.vue         # ç³»ç»Ÿè®¾ç½®
â”‚       â”‚   â”œâ”€â”€ Profile.vue          # ä¸ªäººèµ„æ–™
â”‚       â”‚   â”œâ”€â”€ Login.vue            # ç™»å½•é¡µé¢
â”‚       â”‚   â””â”€â”€ Register.vue         # æ³¨å†Œé¡µé¢
â”‚       â”‚
â”‚       â”œâ”€â”€ components/               # å¯å¤ç”¨ç»„ä»¶ï¼ˆå¯é€‰ï¼‰
â”‚       â”‚
â”‚       â”œâ”€â”€ api/                     # APIæ¥å£å°è£…
â”‚       â”‚   â””â”€â”€ index.js             # Axioså°è£…ï¼Œæ‰€æœ‰APIè°ƒç”¨
â”‚       â”‚
â”‚       â”œâ”€â”€ router/                  # è·¯ç”±é…ç½®
â”‚       â”‚   â””â”€â”€ index.js             # Vue Routeré…ç½®ã€è·¯ç”±å®ˆå«
â”‚       â”‚
â”‚       â”œâ”€â”€ stores/                  # çŠ¶æ€ç®¡ç†
â”‚       â”‚   â””â”€â”€ index.js             # Pinia storeå®šä¹‰
â”‚       â”‚
â”‚       â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚       â”‚   â”œâ”€â”€ notification.js      # é€šçŸ¥å·¥å…·
â”‚       â”‚   â”œâ”€â”€ sound.js             # å£°éŸ³æç¤º
â”‚       â”‚   â””â”€â”€ theme.js             # ä¸»é¢˜ç®¡ç†
â”‚       â”‚
â”‚       â”œâ”€â”€ styles/                  # æ ·å¼æ–‡ä»¶
â”‚       â”‚   â””â”€â”€ global.scss          # å…¨å±€æ ·å¼
â”‚       â”‚
â”‚       â””â”€â”€ assets/                  # èµ„æºæ–‡ä»¶ï¼ˆå›¾ç‰‡ç­‰ï¼‰
â”‚
â”œâ”€â”€ ğŸ“ data/                         # çŸ¥è¯†åº“æ–‡æ¡£
â”‚   â””â”€â”€ agency.txt                   # ç¤ºä¾‹çŸ¥è¯†åº“æ–‡æ¡£ï¼ˆ.txtæ ¼å¼ï¼‰
â”‚
â”œâ”€â”€ ğŸ“ db/                           # å‘é‡æ•°æ®åº“ï¼ˆChromaDBï¼‰
â”‚   â”œâ”€â”€ chroma.sqlite3              # SQLiteå…ƒæ•°æ®
â”‚   â””â”€â”€ [collection_id]/            # é›†åˆæ•°æ®ç›®å½•
â”‚       â”œâ”€â”€ data_level0.bin          # å‘é‡æ•°æ®
â”‚       â”œâ”€â”€ header.bin               # ç´¢å¼•å¤´
â”‚       â”œâ”€â”€ length.bin                # å‘é‡é•¿åº¦
â”‚       â””â”€â”€ link_lists.bin           # HNSWç´¢å¼•
â”‚
â”œâ”€â”€ ğŸ“ db_1024/                      # 1024ç»´å‘é‡æ•°æ®åº“
â”‚   â””â”€â”€ (ç»“æ„åŒ db/)
â”‚
â”œâ”€â”€ ğŸ“ db_2560/                      # 2560ç»´å‘é‡æ•°æ®åº“ï¼ˆQwen3-Embedding-4Bï¼‰
â”‚   â””â”€â”€ (ç»“æ„åŒ db/)
â”‚
â”œâ”€â”€ ğŸ“ db_4096/                      # 4096ç»´å‘é‡æ•°æ®åº“ï¼ˆQwen3-Embedding-8Bï¼‰
â”‚   â””â”€â”€ (ç»“æ„åŒ db/)
â”‚
â”œâ”€â”€ ğŸ“ docs/                         # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ README.md                    # æ–‡æ¡£ç´¢å¼•
â”‚   â”œâ”€â”€ æ–‡æ¡£ç»“æ„è¯´æ˜.md              # æ–‡æ¡£ç»„ç»‡è¯´æ˜
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸš€ å¿«é€Ÿå¼€å§‹
â”‚   â”œâ”€â”€ ä½¿ç”¨æ–‡æ¡£.md                  # ç®€å•ç²¾ç‚¼çš„ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ å¿«é€Ÿå¼€å§‹.md                  # è¯¦ç»†é…ç½®æ­¥éª¤
â”‚   â”‚
â”‚   â”œâ”€â”€ âš™ï¸ é…ç½®æŒ‡å—
â”‚   â”œâ”€â”€ é…ç½®è¯´æ˜.md                  # é€šç”¨é…ç½®è¯´æ˜
â”‚   â”œâ”€â”€ ç¡…åŸºæµåŠ¨é…ç½®æŒ‡å—.md          # APIé…ç½®è¯¦è§£
â”‚   â”œâ”€â”€ æ¨¡å‹é€‰æ‹©è¯´æ˜.md              # æ¨¡å‹é€‰æ‹©æŒ‡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“– ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ è¿è¡Œæ¨¡å¼è¯´æ˜.md              # è¿è¡Œæ¨¡å¼è¯¦è§£
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ”§ æŠ€æœ¯æ–‡æ¡£
â”‚   â”œâ”€â”€ è¯´æ˜æ–‡æ¡£.md                  # å®Œæ•´æŠ€æœ¯æ–‡æ¡£ï¼ˆæœ¬æ–‡æ¡£ï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“œ é¡¹ç›®å†å²
â”‚       â”œâ”€â”€ å˜æ›´æ‘˜è¦.md              # é‡å¤§å˜æ›´è®°å½•
â”‚       â”œâ”€â”€ æ›´æ–°æ—¥å¿—.md              # ç‰ˆæœ¬æ›´æ–°å†å²
â”‚       â””â”€â”€ MIGRATION_COMPLETE.md    # è¿ç§»å®ŒæˆæŠ¥å‘Š
â”‚
â””â”€â”€ ğŸ“ scripts/                      # å¯åŠ¨è„šæœ¬ï¼ˆWindowsï¼‰
    â”œâ”€â”€ start_all.bat                # ä¸€é”®å¯åŠ¨ï¼ˆåç«¯+å‰ç«¯ï¼‰
    â”œâ”€â”€ start_backend.bat            # å¯åŠ¨åç«¯
    â””â”€â”€ start_frontend.bat           # å¯åŠ¨å‰ç«¯
```

### ç›®å½•è¯´æ˜

#### æ ¹ç›®å½•æ–‡ä»¶

**å¯åŠ¨æ–‡ä»¶**ï¼š
- `backend_api.py` - FastAPIåç«¯æœåŠ¡ï¼Œæä¾›RESTful APIå’ŒWebSocket
- `main.py` - å‘½ä»¤è¡Œå•æ¬¡è¿è¡Œæ¨¡å¼ï¼Œå¤„ç†å½“å‰æœªè¯»é‚®ä»¶åç»“æŸ
- `main_continuous.py` - å‘½ä»¤è¡ŒæŒç»­ç›‘æ§æ¨¡å¼ï¼Œæ¯15åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥é‚®ç®±
- `start.bat` - Windowsä¸€é”®å¯åŠ¨è„šæœ¬

**æ•°æ®åº“åˆå§‹åŒ–**ï¼š
- `create_index.py` - åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆä½¿ç”¨é»˜è®¤åµŒå…¥æ¨¡å‹ï¼‰
- `create_index_1024.py` - åˆ›å»º1024ç»´å‘é‡ç´¢å¼•
- `create_index_2560.py` - åˆ›å»º2560ç»´å‘é‡ç´¢å¼•ï¼ˆå¯¹åº”Qwen3-Embedding-4Bï¼‰
- `create_index_4096.py` - åˆ›å»º4096ç»´å‘é‡ç´¢å¼•ï¼ˆå¯¹åº”Qwen3-Embedding-8Bï¼‰
- `clear_db.py` - æ¸…ç†å‘é‡æ•°æ®åº“å·¥å…·

**é…ç½®æ–‡ä»¶**ï¼š
- `requirements.txt` - Pythonä¾èµ–åˆ—è¡¨
- `.env` - ç¯å¢ƒå˜é‡é…ç½®ï¼ˆéœ€è‡ªè¡Œåˆ›å»ºï¼ŒåŒ…å«APIå¯†é’¥ç­‰ï¼‰

**æ•°æ®æ–‡ä»¶**ï¼š
- `user_data.json` - ç”¨æˆ·è´¦å·æ•°æ®ï¼ˆç”¨æˆ·åã€å¯†ç å“ˆå¸Œç­‰ï¼‰
- `user_email_data_*.json` - æŒ‰ç”¨æˆ·å­˜å‚¨çš„é‚®ä»¶å¤„ç†å†å²
- `username_mapping.json` - ç”¨æˆ·åæ˜ å°„å…³ç³»

#### åç«¯æ ¸å¿ƒä»£ç  (`src/`)

- `agents.py` - **AIä»£ç†å®šä¹‰**ï¼šåŸºäºLangChainæ„å»ºçš„AIä»£ç†ç³»ç»Ÿ
  - åˆ†ç±»ä»£ç†ã€RAGæŸ¥è¯¢ä»£ç†ã€RAGç­”æ¡ˆç”Ÿæˆä»£ç†ã€å†™ä½œä»£ç†ã€æ ¡å¯¹ä»£ç†
  - LLMå’ŒåµŒå…¥æ¨¡å‹çš„åˆå§‹åŒ–
  
- `graph.py` - **å·¥ä½œæµå®šä¹‰**ï¼šLangGraphçŠ¶æ€å›¾å®šä¹‰
  - èŠ‚ç‚¹æ·»åŠ ã€æ¡ä»¶è¾¹è®¾ç½®ã€å·¥ä½œæµç¼–æ’
  
- `nodes.py` - **èŠ‚ç‚¹å®ç°**ï¼šå·¥ä½œæµèŠ‚ç‚¹çš„å…·ä½“å®ç°
  - é‚®ä»¶åŠ è½½ã€åˆ†ç±»ã€RAGæ£€ç´¢ã€å›å¤ç”Ÿæˆã€è´¨é‡æ ¡éªŒç­‰
  
- `prompts.py` - **æç¤ºè¯æ¨¡æ¿**ï¼šæ‰€æœ‰AIä»»åŠ¡çš„æç¤ºè¯æ¨¡æ¿
  - ä½¿ç”¨LangChainçš„ChatPromptTemplateç®¡ç†
  
- `state.py` - **çŠ¶æ€å®šä¹‰**ï¼šGraphStateçŠ¶æ€ç»“æ„å®šä¹‰
  - ä½¿ç”¨TypedDictå®šä¹‰å·¥ä½œæµçŠ¶æ€
  
- `structure_outputs.py` - **ç»“æ„åŒ–è¾“å‡º**ï¼šPydanticæ¨¡å‹å®šä¹‰
  - ç”¨äºAIçš„ç»“æ„åŒ–è¾“å‡ºï¼ˆåˆ†ç±»ç»“æœã€RAGæŸ¥è¯¢ç­‰ï¼‰
  
- `tools/QQEmailTools.py` - **é‚®ç®±å·¥å…·**ï¼šQQé‚®ç®±æ“ä½œå·¥å…·ç±»
  - IMAPè¿æ¥ã€SMTPè¿æ¥ã€é‚®ä»¶æ”¶å‘ã€æ ‡è®°å·²è¯»ç­‰

#### å‰ç«¯é¡¹ç›® (`frontend/`)

**é¡µé¢ç»„ä»¶** (`src/views/`)ï¼š
- `Layout.vue` - ä¸»å¸ƒå±€ï¼ˆä¾§è¾¹æ ã€å¯¼èˆªæ ã€å†…å®¹åŒºï¼‰
- `Dashboard.vue` - ä»ªè¡¨ç›˜ï¼ˆç»Ÿè®¡å›¾è¡¨ã€å®æ—¶çŠ¶æ€ï¼‰
- `Emails.vue` - é‚®ä»¶ç®¡ç†ï¼ˆåˆ—è¡¨ã€è¯¦æƒ…ã€æ“ä½œï¼‰
- `Knowledge.vue` - çŸ¥è¯†åº“ç®¡ç†ï¼ˆä¸Šä¼ ã€ç®¡ç†ã€æ£€ç´¢æµ‹è¯•ï¼‰
- `History.vue` - å†å²è®°å½•ï¼ˆæŸ¥è¯¢ã€ç­›é€‰ã€å¯¼å‡ºï¼‰
- `Settings.vue` - ç³»ç»Ÿè®¾ç½®ï¼ˆç”¨æˆ·é…ç½®ã€æ¨¡æ¿è®¾ç½®ï¼‰
- `Profile.vue` - ä¸ªäººèµ„æ–™
- `Login.vue` / `Register.vue` - ç”¨æˆ·è®¤è¯

**æ ¸å¿ƒæ¨¡å—**ï¼š
- `api/index.js` - APIæ¥å£å°è£…ï¼ˆAxiosï¼‰
- `router/index.js` - è·¯ç”±é…ç½®ï¼ˆVue Routerï¼‰
- `stores/index.js` - çŠ¶æ€ç®¡ç†ï¼ˆPiniaï¼‰
- `utils/` - å·¥å…·å‡½æ•°ï¼ˆé€šçŸ¥ã€å£°éŸ³ã€ä¸»é¢˜ï¼‰

#### æ•°æ®ç›®å½•

**çŸ¥è¯†åº“æ–‡æ¡£** (`data/`)ï¼š
- å­˜å‚¨çŸ¥è¯†åº“æ–‡æ¡£ï¼ˆ.txtæ ¼å¼ï¼‰
- æ–‡æ¡£ä¼šè¢«åˆ†å—ã€å‘é‡åŒ–åå­˜å‚¨åˆ°å‘é‡æ•°æ®åº“

**å‘é‡æ•°æ®åº“** (`db/`, `db_1024/`, `db_2560/`, `db_4096/`)ï¼š
- æ ¹æ®åµŒå…¥æ¨¡å‹ç»´åº¦è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„æ•°æ®åº“ç›®å½•
- å­˜å‚¨æ–‡æ¡£çš„å‘é‡åµŒå…¥å’Œå…ƒæ•°æ®
- æ”¯æŒç›¸ä¼¼åº¦æ£€ç´¢

#### æ–‡æ¡£ç›®å½• (`docs/`)

æ–‡æ¡£æŒ‰åŠŸèƒ½åˆ†ç±»ç»„ç»‡ï¼š
- **å¿«é€Ÿå¼€å§‹** - å…¥é—¨æ–‡æ¡£
- **é…ç½®æŒ‡å—** - é…ç½®ç›¸å…³æ–‡æ¡£
- **ä½¿ç”¨æŒ‡å—** - ä½¿ç”¨ç›¸å…³æ–‡æ¡£
- **æŠ€æœ¯æ–‡æ¡£** - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- **é¡¹ç›®å†å²** - å˜æ›´å’Œæ›´æ–°è®°å½•

### é‡è¦æ–‡ä»¶è¯´æ˜

#### å¿…é¡»åˆ›å»ºçš„æ–‡ä»¶

- `.env` - ç¯å¢ƒå˜é‡é…ç½®ï¼ˆåŒ…å«APIå¯†é’¥ã€é‚®ç®±é…ç½®ç­‰ï¼‰

#### è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶

- `db/` åŠå…¶å­ç›®å½• - å‘é‡æ•°æ®åº“ï¼ˆè¿è¡Œ`create_index.py`åç”Ÿæˆï¼‰
- `user_data.json` - ç”¨æˆ·æ•°æ®ï¼ˆé¦–æ¬¡æ³¨å†Œåç”Ÿæˆï¼‰
- `user_email_data_*.json` - é‚®ä»¶å†å²ï¼ˆå¤„ç†é‚®ä»¶åç”Ÿæˆï¼‰
- `__pycache__/` - Pythonç¼“å­˜æ–‡ä»¶ï¼ˆè¿è¡Œåè‡ªåŠ¨ç”Ÿæˆï¼‰

#### å¯å¿½ç•¥çš„æ–‡ä»¶/ç›®å½•

- `node_modules/` - Node.jsä¾èµ–ï¼ˆå¯é€šè¿‡`npm install`é‡æ–°ç”Ÿæˆï¼‰
- `__pycache__/` - Pythonç¼“å­˜
- `*.pyc` - Pythonç¼–è¯‘æ–‡ä»¶

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯å±‚ (Vue 3)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  é‚®ä»¶ç®¡ç† â”‚  â”‚  çŸ¥è¯†åº“   â”‚  â”‚  å†å²è®°å½• â”‚  â”‚  è®¾ç½®   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PiniaçŠ¶æ€ç®¡ç† / Vue Router / Axios HTTPå®¢æˆ·ç«¯    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP/WebSocket (RESTful API)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åç«¯APIå±‚ (FastAPI)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  RESTful API / WebSocket / æ–‡ä»¶ä¸Šä¼  / æ•°æ®å¯¼å‡º      â”‚ â”‚
â”‚  â”‚  CORSä¸­é—´ä»¶ / è®¤è¯ä¸­é—´ä»¶ / é”™è¯¯å¤„ç†                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  çº¿ç¨‹æ±  (ThreadPoolExecutor) - å¤„ç†AIå¼‚æ­¥ä»»åŠ¡      â”‚ â”‚
â”‚  â”‚  WebSocketç®¡ç†å™¨ - å®æ—¶æ¨é€å¤„ç†çŠ¶æ€                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    LangGraph å·¥ä½œæµå¼•æ“ (åŸºäºLangChainæ„å»º)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  çŠ¶æ€å›¾ (StateGraph) - LangGraphæ ¸å¿ƒ                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚ é‚®ä»¶åŠ è½½ â”‚â†’ â”‚ é‚®ä»¶åˆ†ç±» â”‚â†’ â”‚ RAGæ£€ç´¢  â”‚â†’ ...    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â”‚  æ¡ä»¶è¾¹ (Conditional Edges) - æ™ºèƒ½è·¯ç”±            â”‚ â”‚
â”‚  â”‚  é€’å½’é™åˆ¶ (Recursion Limit) - é˜²æ­¢æ— é™å¾ªç¯         â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  LangChainç»„ä»¶ï¼š                                    â”‚ â”‚
â”‚  â”‚  â€¢ ChatOpenAI - LLMè°ƒç”¨æ¥å£                        â”‚ â”‚
â”‚  â”‚  â€¢ OpenAIEmbeddings - æ–‡æœ¬åµŒå…¥                    â”‚ â”‚
â”‚  â”‚  â€¢ Chroma - å‘é‡æ•°æ®åº“é›†æˆ                        â”‚ â”‚
â”‚  â”‚  â€¢ ChatPromptTemplate - æç¤ºè¯ç®¡ç†                 â”‚ â”‚
â”‚  â”‚  â€¢ RunnablePassthrough - é“¾å¼è°ƒç”¨                 â”‚ â”‚
â”‚  â”‚  â€¢ RecursiveCharacterTextSplitter - æ–‡æ¡£åˆ†å—      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QQé‚®ç®±    â”‚  â”‚  å‘é‡æ•°æ®åº“  â”‚  â”‚  ç¡…åŸºæµåŠ¨API â”‚
â”‚  IMAP/SMTP â”‚  â”‚  ChromaDB   â”‚  â”‚   LLMæœåŠ¡    â”‚
â”‚  Port 993  â”‚  â”‚  æŒä¹…åŒ–å­˜å‚¨  â”‚  â”‚   OpenAIå…¼å®¹ â”‚
â”‚  Port 465  â”‚  â”‚  ä½™å¼¦ç›¸ä¼¼åº¦  â”‚  â”‚   æ¥å£       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµæ¶æ„

```
ç”¨æˆ·é‚®ä»¶ (QQé‚®ç®±)
    â”‚
    â–¼
[IMAPè¿æ¥] â†’ è·å–æœªè¯»é‚®ä»¶åˆ—è¡¨
    â”‚
    â–¼
[é‚®ä»¶è§£æ] â†’ æå–ä¸»é¢˜ã€æ­£æ–‡ã€å‘ä»¶äººã€æ—¶é—´æˆ³
    â”‚
    â–¼
[LangGraphå·¥ä½œæµ]
    â”‚
    â”œâ”€â†’ [é‚®ä»¶åˆ†ç±»èŠ‚ç‚¹] â†’ AIæ¨¡å‹åˆ†æ â†’ å››åˆ†ç±»ç»“æœ
    â”‚
    â”œâ”€â†’ [RAGæŸ¥è¯¢æ„å»º] â†’ æå–å…³é”®é—®é¢˜ â†’ ç”ŸæˆæŸ¥è¯¢è¯­å¥
    â”‚
    â”œâ”€â†’ [å‘é‡æ£€ç´¢] â†’ æŸ¥è¯¢å‘é‡åŒ– â†’ ChromaDBæ£€ç´¢ â†’ Top-Kæ–‡æ¡£
    â”‚
    â”œâ”€â†’ [å›å¤ç”Ÿæˆ] â†’ ç»„è£…ä¸Šä¸‹æ–‡ â†’ AIç”Ÿæˆå›å¤ â†’ è´¨é‡æ ¡éªŒ
    â”‚
    â””â”€â†’ [é‚®ä»¶å‘é€] â†’ SMTPè¿æ¥ â†’ å‘é€å›å¤ â†’ æ ‡è®°å·²è¯»
```

### æ¨¡å—åˆ’åˆ†

#### 1. å‰ç«¯æ¨¡å— (`frontend/`)

**æŠ€æœ¯æ ˆ**ï¼š
- Vue 3 (Composition API)
- Element Plus (UIç»„ä»¶åº“)
- Pinia (çŠ¶æ€ç®¡ç†)
- Vue Router (è·¯ç”±ç®¡ç†)
- Axios (HTTPå®¢æˆ·ç«¯)
- ECharts (æ•°æ®å¯è§†åŒ–)

**ç›®å½•ç»“æ„**ï¼š
```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ views/              # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Dashboard.vue   # ä»ªè¡¨ç›˜ - ç»Ÿè®¡å›¾è¡¨ã€å®æ—¶çŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ Emails.vue      # é‚®ä»¶ç®¡ç† - åˆ—è¡¨ã€è¯¦æƒ…ã€æ“ä½œ
â”‚   â”‚   â”œâ”€â”€ Knowledge.vue   # çŸ¥è¯†åº“ - æ–‡æ¡£ä¸Šä¼ ã€ç®¡ç†ã€æ£€ç´¢æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ History.vue     # å†å²è®°å½• - æŸ¥è¯¢ã€ç­›é€‰ã€å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ Settings.vue   # ç³»ç»Ÿè®¾ç½® - ç”¨æˆ·é…ç½®ã€ç³»ç»Ÿå‚æ•°
â”‚   â”‚   â”œâ”€â”€ Login.vue       # ç™»å½•é¡µé¢
â”‚   â”‚   â”œâ”€â”€ Register.vue   # æ³¨å†Œé¡µé¢
â”‚   â”‚   â””â”€â”€ Layout.vue      # å¸ƒå±€ç»„ä»¶ - ä¾§è¾¹æ ã€å¯¼èˆªæ 
â”‚   â”‚
â”‚   â”œâ”€â”€ components/        # å¯å¤ç”¨ç»„ä»¶
â”‚   â”‚   â””â”€â”€ (è‡ªå®šä¹‰ç»„ä»¶)
â”‚   â”‚
â”‚   â”œâ”€â”€ api/               # APIæ¥å£å°è£…
â”‚   â”‚   â””â”€â”€ index.js       # æ‰€æœ‰APIè°ƒç”¨çš„ç»Ÿä¸€å°è£…
â”‚   â”‚
â”‚   â”œâ”€â”€ router/            # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ index.js       # Vue Routeré…ç½®ã€è·¯ç”±å®ˆå«
â”‚   â”‚
â”‚   â”œâ”€â”€ stores/            # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â””â”€â”€ index.js       # Pinia storeå®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ notification.js # é€šçŸ¥å·¥å…·
â”‚   â”‚   â”œâ”€â”€ sound.js       # å£°éŸ³æç¤º
â”‚   â”‚   â””â”€â”€ theme.js       # ä¸»é¢˜ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ styles/            # æ ·å¼æ–‡ä»¶
â”‚       â””â”€â”€ global.scss    # å…¨å±€æ ·å¼
â”‚
â””â”€â”€ public/                # é™æ€èµ„æº
```

**æ ¸å¿ƒåŠŸèƒ½å®ç°**ï¼š

- **Dashboard.vue**ï¼š
  - å®æ—¶ç»Ÿè®¡ï¼šé‚®ä»¶æ€»æ•°ã€åˆ†ç±»ç»Ÿè®¡ã€å¤„ç†æˆåŠŸç‡
  - å›¾è¡¨å±•ç¤ºï¼šä½¿ç”¨EChartså±•ç¤ºå¤„ç†è¶‹åŠ¿
  - WebSocketè¿æ¥ï¼šå®æ—¶æ¥æ”¶å¤„ç†çŠ¶æ€æ›´æ–°

- **Emails.vue**ï¼š
  - é‚®ä»¶åˆ—è¡¨ï¼šåˆ†é¡µã€ç­›é€‰ã€æœç´¢
  - é‚®ä»¶è¯¦æƒ…ï¼šå®Œæ•´å†…å®¹å±•ç¤ºã€å›å¤é¢„è§ˆ
  - æ“ä½œåŠŸèƒ½ï¼šå‘é€ã€ç¼–è¾‘ã€åˆ é™¤ã€æ ‡è®°

- **Knowledge.vue**ï¼š
  - æ–‡æ¡£ä¸Šä¼ ï¼šæ”¯æŒ.txtæ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ†å—å’Œç´¢å¼•
  - æ–‡æ¡£ç®¡ç†ï¼šåˆ—è¡¨å±•ç¤ºã€åˆ é™¤ã€é‡å»ºç´¢å¼•
  - æ£€ç´¢æµ‹è¯•ï¼šè¾“å…¥æŸ¥è¯¢ï¼ŒæŸ¥çœ‹æ£€ç´¢ç»“æœ

#### 2. åç«¯æ¨¡å— (`src/`)

**æ ¸å¿ƒæ–‡ä»¶è¯´æ˜**ï¼š

**`graph.py` - å·¥ä½œæµå®šä¹‰**
```python
# å®šä¹‰LangGraphçŠ¶æ€å›¾
workflow = StateGraph(GraphState)

# æ·»åŠ èŠ‚ç‚¹
workflow.add_node("load_inbox_emails", nodes.load_new_emails)
workflow.add_node("categorize_email", nodes.categorize_email)
# ... æ›´å¤šèŠ‚ç‚¹

# è®¾ç½®æ¡ä»¶è¾¹ï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰
workflow.add_conditional_edges(
    "categorize_email",
    nodes.route_email_based_on_category,
    {
        "product related": "construct_rag_queries",
        "not product related": "email_writer",
        "unrelated": "skip_unrelated_email"
    }
)
```

**`nodes.py` - èŠ‚ç‚¹å®ç°**

ä¸»è¦èŠ‚ç‚¹åŠŸèƒ½ï¼š

1. **`load_new_emails`**ï¼š
   - è¿æ¥QQé‚®ç®±IMAPæœåŠ¡å™¨
   - æœç´¢æœ€è¿‘8å°æ—¶çš„æœªè¯»é‚®ä»¶
   - è§£æé‚®ä»¶å†…å®¹ï¼ˆä¸»é¢˜ã€æ­£æ–‡ã€å‘ä»¶äººã€æ—¶é—´æˆ³ï¼‰
   - è¿‡æ»¤è‡ªå·±å‘é€çš„é‚®ä»¶å’Œç©ºé‚®ä»¶
   - è¿”å›é‚®ä»¶åˆ—è¡¨

2. **`categorize_email`**ï¼š
   - è°ƒç”¨åˆ†ç±»AIä»£ç†
   - ä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºï¼ˆPydanticæ¨¡å‹ï¼‰
   - è¿”å›å››åˆ†ç±»ç»“æœï¼šproduct_enquiry / customer_complaint / customer_feedback / unrelated

3. **`construct_rag_queries`**ï¼š
   - åˆ†æé‚®ä»¶å†…å®¹
   - æå–å…³é”®é—®é¢˜
   - ç”Ÿæˆ1-3ä¸ªRAGæŸ¥è¯¢è¯­å¥

4. **`retrieve_from_rag`**ï¼š
   - æ ¹æ®é‚®ä»¶ç±»å‹é€‰æ‹©ä¸åŒçš„æ£€ç´¢ç­–ç•¥
   - å°†æŸ¥è¯¢å‘é‡åŒ–
   - åœ¨ChromaDBä¸­æ£€ç´¢Top-Kç›¸ä¼¼æ–‡æ¡£
   - ç»„è£…ä¸Šä¸‹æ–‡ä¿¡æ¯

5. **`write_draft_email`**ï¼š
   - ç»„è£…æç¤ºè¯ï¼ˆé‚®ä»¶å†…å®¹ + æ£€ç´¢æ–‡æ¡£ + ç³»ç»Ÿæç¤ºï¼‰
   - è°ƒç”¨å†™ä½œAIä»£ç†
   - ç”Ÿæˆä¸“ä¸šã€å‹å¥½çš„å›å¤å†…å®¹

6. **`verify_generated_email`**ï¼š
   - è°ƒç”¨æ ¡å¯¹AIä»£ç†
   - æ£€æŸ¥å›å¤è´¨é‡ï¼ˆç›¸å…³æ€§ã€ä¸“ä¸šæ€§ã€å®Œæ•´æ€§ã€å‹å¥½æ€§ï¼‰
   - è¿”å›æ ¡éªŒç»“æœå’Œä¿®æ”¹å»ºè®®

**`agents.py` - AIä»£ç†å®šä¹‰**

æœ¬é¡¹ç›®å®Œå…¨åŸºäº **LangChain** æ¡†æ¶æ„å»ºAIä»£ç†ç³»ç»Ÿã€‚æ‰€æœ‰AIåŠŸèƒ½éƒ½é€šè¿‡LangChainçš„ç»„ä»¶å®ç°ï¼ŒåŒ…æ‹¬LLMè°ƒç”¨ã€æç¤ºè¯ç®¡ç†ã€é“¾å¼è°ƒç”¨ç­‰ã€‚ç³»ç»ŸåŒ…å«å¤šä¸ªä¸“é—¨çš„AIä»£ç†ï¼š

- **åˆ†ç±»ä»£ç†** (`categorize_email`)ï¼š
  - ä½¿ç”¨LangChainçš„ `ChatOpenAI`ï¼ˆå…¼å®¹ç¡…åŸºæµåŠ¨APIï¼‰
  - ä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºï¼ˆPydanticæ¨¡å‹ï¼‰
  - æ¨¡å‹ï¼šmoonshotai/Kimi-K2-Thinkingï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡REPLY_MODELé…ç½®ï¼‰
  - æ¸©åº¦ï¼š0.1ï¼ˆç¡®ä¿åˆ†ç±»ç¨³å®šï¼‰

- **RAGæŸ¥è¯¢ä»£ç†** (`design_rag_queries`)ï¼š
  - ä½¿ç”¨LangChainçš„æç¤ºè¯æ¨¡æ¿ï¼ˆ`ChatPromptTemplate`ï¼‰
  - ä»é‚®ä»¶ä¸­æå–å…³é”®é—®é¢˜
  - ç”Ÿæˆ1-3ä¸ªæŸ¥è¯¢è¯­å¥

- **RAGç­”æ¡ˆç”Ÿæˆä»£ç†** (å¤šä¸ªç‰ˆæœ¬)ï¼š
  - ä½¿ç”¨LangChainçš„RAGé“¾ï¼ˆ`RunnablePassthrough`ï¼‰
  - `generate_rag_answer_product` - äº§å“å’¨è¯¢ä¸“ç”¨
  - `generate_rag_answer_complaint` - å®¢æˆ·æŠ•è¯‰ä¸“ç”¨
  - `generate_rag_answer_feedback` - å®¢æˆ·åé¦ˆä¸“ç”¨
  - `generate_rag_answer` - é€šç”¨ç‰ˆæœ¬

- **å‘é‡æ£€ç´¢**ï¼š
  - ä½¿ç”¨ `langchain_chroma.Chroma` è¿›è¡Œå‘é‡æ£€ç´¢
  - ä½¿ç”¨ `OpenAIEmbeddings`ï¼ˆå…¼å®¹ç¡…åŸºæµåŠ¨APIï¼‰è¿›è¡Œæ–‡æœ¬åµŒå…¥
  - æ”¯æŒç›¸ä¼¼åº¦æœç´¢å’ŒTop-Kæ£€ç´¢

- **å†™ä½œä»£ç†** (`write_email`)ï¼š
  - ä½¿ç”¨LangChainçš„æç¤ºè¯é“¾
  - ç”Ÿæˆé‚®ä»¶å›å¤
  - æ”¯æŒè‡ªå®šä¹‰ç­¾åã€é—®å€™è¯­ã€ç»“æŸè¯­

- **æ ¡å¯¹ä»£ç†** (`verify_email`)ï¼š
  - ä½¿ç”¨LangChainçš„LLMé“¾
  - è´¨é‡æ ¡éªŒ
  - è¿”å›æ ¡éªŒç»“æœå’Œä¿®æ”¹å»ºè®®

**`prompts.py` - æç¤ºè¯æ¨¡æ¿**

ä½¿ç”¨LangChainçš„ `ChatPromptTemplate` å’Œ `PromptTemplate` å®šä¹‰æ‰€æœ‰AIä»»åŠ¡çš„æç¤ºè¯æ¨¡æ¿ï¼š

- `CATEGORIZE_EMAIL_PROMPT` - é‚®ä»¶åˆ†ç±»æç¤ºè¯
- `GENERATE_RAG_QUERIES_PROMPT` - RAGæŸ¥è¯¢ç”Ÿæˆæç¤ºè¯
- `GENERATE_RAG_ANSWER_PROMPT` - RAGç­”æ¡ˆç”Ÿæˆæç¤ºè¯ï¼ˆé€šç”¨ï¼‰
- `GENERATE_RAG_ANSWER_PRODUCT_ENQUIRY` - äº§å“å’¨è¯¢ä¸“ç”¨
- `GENERATE_RAG_ANSWER_CUSTOMER_COMPLAINT` - å®¢æˆ·æŠ•è¯‰ä¸“ç”¨
- `GENERATE_RAG_ANSWER_CUSTOMER_FEEDBACK` - å®¢æˆ·åé¦ˆä¸“ç”¨
- `EMAIL_WRITER_PROMPT` - é‚®ä»¶å†™ä½œæç¤ºè¯
- `EMAIL_PROOFREADER_PROMPT` - é‚®ä»¶æ ¡éªŒæç¤ºè¯

æ‰€æœ‰æç¤ºè¯éƒ½é€šè¿‡LangChainçš„æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿè¿›è¡Œç®¡ç†å’Œæ ¼å¼åŒ–ã€‚

**`state.py` - çŠ¶æ€å®šä¹‰**

```python
class GraphState(TypedDict):
    emails: List[Email]              # å¾…å¤„ç†é‚®ä»¶åˆ—è¡¨
    current_email: Email             # å½“å‰æ­£åœ¨å¤„ç†çš„é‚®ä»¶
    email_category: str              # é‚®ä»¶åˆ†ç±»ç»“æœ
    rag_queries: List[str]           # RAGæŸ¥è¯¢åˆ—è¡¨
    retrieved_documents: str         # æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹
    generated_email: str             # ç”Ÿæˆçš„å›å¤å†…å®¹
    writer_messages: List[Message]   # å†™ä½œä»£ç†çš„æ¶ˆæ¯å†å²
    sendable: bool                   # å›å¤æ˜¯å¦å¯å‘é€
    trials: int                      # é‡è¯•æ¬¡æ•°ï¼ˆæœ€å¤š3æ¬¡ï¼‰
```

**`tools/QQEmailTools.py` - é‚®ç®±å·¥å…·**

ä¸»è¦æ–¹æ³•ï¼š

- `connect_imap()` - è¿æ¥IMAPæœåŠ¡å™¨
- `connect_smtp()` - è¿æ¥SMTPæœåŠ¡å™¨
- `fetch_unanswered_emails()` - è·å–æœªè¯»é‚®ä»¶
- `send_reply()` - å‘é€å›å¤é‚®ä»¶
- `create_draft_reply()` - åˆ›å»ºè‰ç¨¿ï¼ˆå®é™…ç›´æ¥å‘é€ï¼‰
- `mark_email_as_read()` - æ ‡è®°é‚®ä»¶ä¸ºå·²è¯»

#### 3. æ•°æ®å±‚

**å‘é‡æ•°æ®åº“ (ChromaDB)**

- **å­˜å‚¨ä½ç½®**ï¼šæ ¹æ®åµŒå…¥æ¨¡å‹ç»´åº¦è‡ªåŠ¨é€‰æ‹©
  - `db/` - é»˜è®¤ç›®å½•ï¼ˆæœªçŸ¥ç»´åº¦æ—¶ä½¿ç”¨ï¼‰
  - `db_1024/` - 1024ç»´æ¨¡å‹ä½¿ç”¨
  - `db_2560/` - 2560ç»´æ¨¡å‹ä½¿ç”¨ï¼ˆQwen/Qwen3-Embedding-4Bï¼‰
  - `db_4096/` - 4096ç»´æ¨¡å‹ä½¿ç”¨ï¼ˆQwen/Qwen3-Embedding-8Bï¼‰
- **é›†åˆåç§°**ï¼š`langchain`
- **åµŒå…¥æ¨¡å‹**ï¼š
  - é»˜è®¤ï¼š`Qwen/Qwen3-Embedding-4B`ï¼ˆ2560ç»´ï¼‰
  - å¯é€‰ï¼š`Qwen/Qwen3-Embedding-8B`ï¼ˆ4096ç»´ï¼‰
  - å¤‡ç”¨ï¼šæœ¬åœ°æ¨¡å‹ `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2`
- **å‘é‡ç»´åº¦**ï¼šæ ¹æ®æ¨¡å‹è‡ªåŠ¨æ£€æµ‹ï¼ˆ2560æˆ–4096ç»´ï¼‰
- **è·ç¦»åº¦é‡**ï¼šä½™å¼¦ç›¸ä¼¼åº¦
- **åˆ†å—ç­–ç•¥**ï¼š
  - å—å¤§å°ï¼š300å­—ç¬¦
  - é‡å ï¼š50å­—ç¬¦
  - ä½¿ç”¨ `RecursiveCharacterTextSplitter`

**ç”¨æˆ·æ•°æ® (JSONæ–‡ä»¶)**

- **`user_data.json`**ï¼š
  - å­˜å‚¨ç”¨æˆ·è´¦å·ä¿¡æ¯
  - å¯†ç ä½¿ç”¨å“ˆå¸Œå­˜å‚¨
  - æ”¯æŒå¤šç”¨æˆ·

- **`user_email_data_*.json`**ï¼š
  - æŒ‰ç”¨æˆ·å­˜å‚¨é‚®ä»¶å¤„ç†å†å²
  - åŒ…å«é‚®ä»¶å†…å®¹ã€åˆ†ç±»ã€ç”Ÿæˆçš„å›å¤ã€å¤„ç†æ—¶é—´ç­‰
  - æ”¯æŒå¯¼å‡ºExcelæŠ¥è¡¨

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. é‚®ä»¶è‡ªåŠ¨å¤„ç†æµç¨‹

#### å®Œæ•´å·¥ä½œæµèŠ‚ç‚¹å›¾

```
å¼€å§‹
  â†“
[load_inbox_emails] - åŠ è½½æ–°é‚®ä»¶
  â”‚
  â”œâ”€â†’ è¿æ¥IMAPæœåŠ¡å™¨ (imap.qq.com:993)
  â”œâ”€â†’ æœç´¢æœªè¯»é‚®ä»¶ (æœ€è¿‘8å°æ—¶)
  â”œâ”€â†’ è§£æé‚®ä»¶å†…å®¹ (ä¸»é¢˜ã€æ­£æ–‡ã€å‘ä»¶äººã€æ—¶é—´æˆ³)
  â””â”€â†’ è¿‡æ»¤è§„åˆ™ï¼šè·³è¿‡è‡ªå·±å‘é€çš„ã€ç©ºé‚®ä»¶
  â†“
[is_email_inbox_empty] - æ£€æŸ¥é‚®ç®±æ˜¯å¦ä¸ºç©º
  â”‚
  â”œâ”€â†’ å¦‚æœä¸ºç©º â†’ END
  â””â”€â†’ å¦‚æœæœ‰é‚®ä»¶ â†’ ç»§ç»­
  â†“
[categorize_email] - é‚®ä»¶åˆ†ç±»
  â”‚
  â”œâ”€â†’ è°ƒç”¨åˆ†ç±»AIä»£ç†
  â”œâ”€â†’ ä½¿ç”¨ç»“æ„åŒ–è¾“å‡º (Pydanticæ¨¡å‹)
  â””â”€â†’ è¿”å›åˆ†ç±»ç»“æœ
  â†“
[route_email_based_on_category] - è·¯ç”±å†³ç­–
  â”‚
  â”œâ”€â†’ "product_enquiry" â†’ [construct_rag_queries]
  â”œâ”€â†’ "customer_complaint" / "customer_feedback" â†’ [email_writer]
  â””â”€â†’ "unrelated" â†’ [skip_unrelated_email]
  â†“
[construct_rag_queries] - æ„å»ºRAGæŸ¥è¯¢ (ä»…äº§å“ç›¸å…³)
  â”‚
  â”œâ”€â†’ åˆ†æé‚®ä»¶å†…å®¹
  â”œâ”€â†’ æå–å…³é”®é—®é¢˜
  â””â”€â†’ ç”Ÿæˆ1-3ä¸ªæŸ¥è¯¢è¯­å¥
  â†“
[retrieve_from_rag] - æ£€ç´¢çŸ¥è¯†åº“ (ä»…äº§å“ç›¸å…³)
  â”‚
  â”œâ”€â†’ æ ¹æ®é‚®ä»¶ç±»å‹é€‰æ‹©æ£€ç´¢ç­–ç•¥
  â”‚   â”œâ”€â†’ product_enquiry â†’ äº§å“å’¨è¯¢ä¸“ç”¨æ£€ç´¢å™¨
  â”‚   â”œâ”€â†’ customer_complaint â†’ å®¢æˆ·æŠ•è¯‰ä¸“ç”¨æ£€ç´¢å™¨
  â”‚   â””â”€â†’ customer_feedback â†’ å®¢æˆ·åé¦ˆä¸“ç”¨æ£€ç´¢å™¨
  â”œâ”€â†’ å°†æŸ¥è¯¢å‘é‡åŒ– (ä½¿ç”¨åµŒå…¥æ¨¡å‹)
  â”œâ”€â†’ åœ¨ChromaDBä¸­æ£€ç´¢ (Top-Kç›¸ä¼¼æ–‡æ¡£ï¼Œé»˜è®¤K=3)
  â””â”€â†’ ç»„è£…ä¸Šä¸‹æ–‡ä¿¡æ¯
  â†“
[email_writer] - ç”Ÿæˆå›å¤
  â”‚
  â”œâ”€â†’ ç»„è£…æç¤ºè¯
  â”‚   â”œâ”€â†’ é‚®ä»¶å†…å®¹
  â”‚   â”œâ”€â†’ æ£€ç´¢åˆ°çš„æ–‡æ¡£ (å¦‚æœæœ‰)
  â”‚   â”œâ”€â†’ ç³»ç»Ÿæç¤º (è§’è‰²ã€é£æ ¼ã€æ ¼å¼)
  â”‚   â””â”€â†’ è‡ªå®šä¹‰æ¨¡æ¿ (ç­¾åã€é—®å€™è¯­ã€ç»“æŸè¯­)
  â”œâ”€â†’ è°ƒç”¨å†™ä½œAIä»£ç†
  â””â”€â†’ ç”Ÿæˆä¸“ä¸šã€å‹å¥½çš„å›å¤å†…å®¹
  â†“
[email_proofreader] - è´¨é‡æ ¡éªŒ
  â”‚
  â”œâ”€â†’ è°ƒç”¨æ ¡å¯¹AIä»£ç†
  â”œâ”€â†’ æ£€æŸ¥å›å¤è´¨é‡
  â”‚   â”œâ”€â†’ ç›¸å…³æ€§ï¼šå›å¤æ˜¯å¦ä¸é‚®ä»¶å†…å®¹ç›¸å…³
  â”‚   â”œâ”€â†’ ä¸“ä¸šæ€§ï¼šå›å¤æ˜¯å¦ä¸“ä¸šã€å‡†ç¡®
  â”‚   â”œâ”€â†’ å®Œæ•´æ€§ï¼šå›å¤æ˜¯å¦å®Œæ•´å›ç­”äº†é—®é¢˜
  â”‚   â””â”€â†’ å‹å¥½æ€§ï¼šå›å¤è¯­æ°”æ˜¯å¦å‹å¥½ã€ç¤¼è²Œ
  â”œâ”€â†’ è¿”å›æ ¡éªŒç»“æœ
  â”‚
  â”œâ”€â†’ å¦‚æœé€šè¿‡ â†’ [send_email]
  â””â”€â†’ å¦‚æœä¸é€šè¿‡ â†’ é‡è¯• (æœ€å¤š3æ¬¡)
  â†“
[send_email] - åˆ›å»ºå›å¤
  â”‚
  â”œâ”€â†’ ä¿å­˜åˆ°ç³»ç»Ÿæ•°æ®åº“ (user_email_data_*.json)
  â”œâ”€â†’ å¯é€‰ï¼šå‘é€åˆ°QQé‚®ç®± (SMTP)
  â””â”€â†’ æ ‡è®°åŸé‚®ä»¶ä¸ºå·²è¯»
  â†“
ç»“æŸ
```

#### é‚®ä»¶åˆ†ç±»è¯¦è§£

**åˆ†ç±»ç®—æ³•**ï¼š

ç³»ç»Ÿä½¿ç”¨AIæ¨¡å‹å¯¹é‚®ä»¶è¿›è¡Œå››åˆ†ç±»ï¼Œä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºç¡®ä¿åˆ†ç±»å‡†ç¡®æ€§ï¼š

```python
# åˆ†ç±»ç»“æœç»“æ„ (Pydanticæ¨¡å‹)
class EmailCategory(str, Enum):
    product_enquiry = "product_enquiry"      # äº§å“å’¨è¯¢
    customer_complaint = "customer_complaint" # å®¢æˆ·æŠ•è¯‰
    customer_feedback = "customer_feedback"   # å®¢æˆ·åé¦ˆ
    unrelated = "unrelated"                   # æ— å…³é‚®ä»¶
```

**åˆ†ç±»è§„åˆ™**ï¼š

1. **äº§å“å’¨è¯¢** (`product_enquiry`)ï¼š
   - å…³é”®è¯ï¼šä»·æ ¼ã€å’¨è¯¢ã€äº†è§£ã€äº§å“ã€åŠŸèƒ½ã€æœåŠ¡ã€apiã€æ¥å£ã€å¦‚ä½•ã€æ€ä¹ˆã€è¯·é—®ã€å¤šå°‘
   - ç‰¹å¾ï¼šè¯¢é—®äº§å“åŠŸèƒ½ã€ä»·æ ¼ã€ä½¿ç”¨æ–¹æ³•ç­‰
   - å¤„ç†æ–¹å¼ï¼šéœ€è¦æ£€ç´¢çŸ¥è¯†åº“ï¼Œæä¾›è¯¦ç»†ç­”æ¡ˆ

2. **å®¢æˆ·æŠ•è¯‰** (`customer_complaint`)ï¼š
   - å…³é”®è¯ï¼šæŠ•è¯‰ã€ä¸æ»¡ã€å·®è¯„ã€é€€æ¬¾ã€é—®é¢˜ä¸¥é‡ã€æ€åº¦å·®ã€åƒåœ¾ã€éª—å­
   - ç‰¹å¾ï¼šè¡¨è¾¾ä¸æ»¡ã€æ„¤æ€’ã€è¦æ±‚é€€æ¬¾ç­‰è´Ÿé¢æƒ…ç»ª
   - å¤„ç†æ–¹å¼ï¼šä½¿ç”¨æŠ•è¯‰ä¸“ç”¨æç¤ºè¯ï¼Œç”Ÿæˆä¸“ä¸šã€å‹å¥½çš„å¤„ç†å›å¤
   - **é‡è¦è§„åˆ™**ï¼šåŒ…å«æŠ•è¯‰å…³é”®è¯çš„é‚®ä»¶**å¿…é¡»**åˆ†ç±»ä¸ºæŠ•è¯‰ï¼Œä¸èƒ½åˆ†ç±»ä¸ºæ— å…³

3. **å®¢æˆ·åé¦ˆ** (`customer_feedback`)ï¼š
   - å…³é”®è¯ï¼šåé¦ˆã€å»ºè®®ã€æ„è§ã€å¸Œæœ›ã€æ”¹è¿›ã€ä½“éªŒ
   - ç‰¹å¾ï¼šæä¾›å»ºè®®ã€æ„è§ã€ä½¿ç”¨ä½“éªŒç­‰
   - å¤„ç†æ–¹å¼ï¼šæ„Ÿè°¢åé¦ˆï¼Œè®°å½•å»ºè®®

4. **æ— å…³é‚®ä»¶** (`unrelated`)ï¼š
   - å…³é”®è¯ï¼šå¹¿å‘Šã€æ¨å¹¿ã€ä¼˜æƒ åˆ¸ã€ä¸­å¥–ã€æŠ½å¥–ã€ä¿ƒé”€ã€ç‰¹ä»·
   - ç‰¹å¾ï¼šå¹¿å‘Šã€åƒåœ¾é‚®ä»¶ã€å®Œå…¨æ— å…³çš„å†…å®¹
   - å¤„ç†æ–¹å¼ï¼šè‡ªåŠ¨è·³è¿‡ï¼Œä¸ç”Ÿæˆå›å¤
   - **é‡è¦è§„åˆ™**ï¼šåªæœ‰æ˜ç¡®æ˜¯å¹¿å‘Šæˆ–åƒåœ¾é‚®ä»¶æ‰èƒ½åˆ†ç±»ä¸ºæ— å…³

**åˆ†ç±»æç¤ºè¯å…³é”®è§„åˆ™**ï¼š

```
CRITICAL RULE: å¦‚æœé‚®ä»¶ä¸»é¢˜æˆ–å†…å®¹åŒ…å«ä»¥ä¸‹ä»»ä½•è¯æ±‡ï¼š
"æŠ•è¯‰"ã€"å®¢æˆ·æŠ•è¯‰"ã€"ä¸æ»¡"ã€"å·®è¯„"ã€"é€€æ¬¾"ã€"é—®é¢˜ä¸¥é‡"ã€"æ€åº¦å·®"ã€"åƒåœ¾"ã€"éª—å­"
æˆ–è¡¨è¾¾ä»»ä½•ä¸æ»¡ã€æ„¤æ€’ã€è´Ÿé¢æƒ…ç»ª
å¿…é¡»åˆ†ç±»ä¸º customer_complaintï¼Œç»ä¸èƒ½åˆ†ç±»ä¸º unrelated
```

#### RAGæ£€ç´¢æœºåˆ¶è¯¦è§£

**1. æŸ¥è¯¢æ„å»ºé˜¶æ®µ**

```python
# ä»é‚®ä»¶ä¸­æå–å…³é”®é—®é¢˜
def construct_rag_queries(email_content):
    # è°ƒç”¨RAGæŸ¥è¯¢ç”Ÿæˆä»£ç†
    result = design_rag_queries.invoke({"email": email_content})
    # è¿”å›1-3ä¸ªæŸ¥è¯¢è¯­å¥
    return result.queries  # List[str]
```

**æŸ¥è¯¢ç”Ÿæˆç­–ç•¥**ï¼š
- åˆ†æé‚®ä»¶çš„ä¸»è¦æ„å›¾
- æå–å…³é”®é—®é¢˜ï¼ˆæœ€å¤š3ä¸ªï¼‰
- ç”Ÿæˆç®€æ´ã€æ˜ç¡®çš„æŸ¥è¯¢è¯­å¥
- ç¡®ä¿æŸ¥è¯¢èƒ½å¤Ÿæœ‰æ•ˆæ£€ç´¢åˆ°ç›¸å…³ä¿¡æ¯

**2. å‘é‡æ£€ç´¢é˜¶æ®µ**

```python
# å‘é‡æ£€ç´¢æµç¨‹
def retrieve_from_rag(query):
    # 1. å°†æŸ¥è¯¢æ–‡æœ¬å‘é‡åŒ–
    query_vector = embedding_model.embed_query(query)
    
    # 2. åœ¨ChromaDBä¸­æ£€ç´¢ç›¸ä¼¼æ–‡æ¡£
    # ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—
    results = vectorstore.similarity_search_with_score(
        query, 
        k=3  # Top-3 æœ€ç›¸ä¼¼çš„æ–‡æ¡£
    )
    
    # 3. ç»„è£…ä¸Šä¸‹æ–‡
    context = "\n\n".join([doc.page_content for doc, score in results])
    
    return context
```

**æ£€ç´¢å‚æ•°**ï¼š
- **Top-K**ï¼šé»˜è®¤æ£€ç´¢3ä¸ªæœ€ç›¸ä¼¼çš„æ–‡æ¡£ç‰‡æ®µ
- **ç›¸ä¼¼åº¦é˜ˆå€¼**ï¼šä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼ŒèŒƒå›´0-1
- **åˆ†å—å¤§å°**ï¼š300å­—ç¬¦
- **é‡å å¤§å°**ï¼š50å­—ç¬¦ï¼ˆç¡®ä¿ä¸Šä¸‹æ–‡è¿ç»­æ€§ï¼‰

**3. ä¸Šä¸‹æ–‡ç»„è£…é˜¶æ®µ**

æ ¹æ®é‚®ä»¶ç±»å‹é€‰æ‹©ä¸åŒçš„RAGç­”æ¡ˆç”Ÿæˆå™¨ï¼š

- **äº§å“å’¨è¯¢** (`product_enquiry`)ï¼š
  - ä½¿ç”¨ `generate_rag_answer_product`
  - æç¤ºè¯å¼ºè°ƒï¼šæä¾›è¯¦ç»†ã€å‡†ç¡®çš„äº§å“ä¿¡æ¯
  - å¦‚æœæ‰¾ä¸åˆ°ç›¸å…³ä¿¡æ¯ï¼Œæ˜ç¡®è¯´æ˜

- **å®¢æˆ·æŠ•è¯‰** (`customer_complaint`)ï¼š
  - ä½¿ç”¨ `generate_rag_answer_complaint`
  - æç¤ºè¯å¼ºè°ƒï¼šä¸“ä¸šã€å‹å¥½ã€ç§¯æè§£å†³é—®é¢˜
  - æä¾›è§£å†³æ–¹æ¡ˆå’Œåç»­è·Ÿè¿›

- **å®¢æˆ·åé¦ˆ** (`customer_feedback`)ï¼š
  - ä½¿ç”¨ `generate_rag_answer_feedback`
  - æç¤ºè¯å¼ºè°ƒï¼šæ„Ÿè°¢åé¦ˆã€è®°å½•å»ºè®®
  - è¡¨è¾¾å¯¹åé¦ˆçš„é‡è§†

**4. ç­”æ¡ˆç”Ÿæˆé˜¶æ®µ**

```python
# RAGç­”æ¡ˆç”Ÿæˆæµç¨‹
def generate_rag_answer(query, context):
    # ç»„è£…æç¤ºè¯
    prompt = f"""
    åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼š
    
    ä¸Šä¸‹æ–‡ï¼š
    {context}
    
    é—®é¢˜ï¼š
    {query}
    
    è¦æ±‚ï¼š
    1. åªåŸºäºä¸Šä¸‹æ–‡å›ç­”ï¼Œä¸è¦ç¼–é€ ä¿¡æ¯
    2. å¦‚æœä¸Šä¸‹æ–‡æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œå›ç­”"æˆ‘ä¸çŸ¥é“"
    3. å›ç­”è¦ä¸“ä¸šã€å‡†ç¡®ã€å‹å¥½
    """
    
    # è°ƒç”¨AIæ¨¡å‹ç”Ÿæˆç­”æ¡ˆ
    answer = llm.invoke(prompt)
    
    return answer
```

**RAGæ£€ç´¢ä¼˜åŒ–**ï¼š

1. **å¤šæŸ¥è¯¢ç­–ç•¥**ï¼šç”Ÿæˆå¤šä¸ªæŸ¥è¯¢ï¼Œæé«˜æ£€ç´¢è¦†ç›–ç‡
2. **é‡æ’åº**ï¼šå¯¹æ£€ç´¢ç»“æœè¿›è¡Œç›¸å…³æ€§é‡æ’åº
3. **ä¸Šä¸‹æ–‡çª—å£**ï¼šé™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œé¿å…è¶…å‡ºæ¨¡å‹é™åˆ¶
4. **ç¼“å­˜æœºåˆ¶**ï¼šç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœï¼Œå‡å°‘APIè°ƒç”¨

### 2. Webç®¡ç†ç•Œé¢

#### ä»ªè¡¨ç›˜
- é‚®ä»¶å¤„ç†ç»Ÿè®¡ï¼ˆæ€»æ•°ã€åˆ†ç±»ç»Ÿè®¡ã€æˆåŠŸç‡ï¼‰
- å®æ—¶å¤„ç†çŠ¶æ€
- ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

#### é‚®ä»¶ç®¡ç†
- é‚®ä»¶åˆ—è¡¨ï¼ˆæ”¶ä»¶ç®±ã€å·²å¤„ç†ã€è‰ç¨¿ï¼‰
- é‚®ä»¶è¯¦æƒ…æŸ¥çœ‹
- AIç”Ÿæˆçš„å›å¤é¢„è§ˆ
- ä¸€é”®å‘é€/ç¼–è¾‘/åˆ é™¤

#### çŸ¥è¯†åº“ç®¡ç†
- æ–‡æ¡£ä¸Šä¼ ï¼ˆæ”¯æŒ `.txt` æ ¼å¼ï¼‰
- æ–‡æ¡£åˆ—è¡¨ç®¡ç†
- æ£€ç´¢æµ‹è¯•
- å‘é‡æ•°æ®åº“é‡å»º

#### å†å²è®°å½•
- å¤„ç†å†å²æŸ¥è¯¢
- æ—¶é—´èŒƒå›´ç­›é€‰
- å…³é”®è¯æœç´¢
- ExcelæŠ¥è¡¨å¯¼å‡º

### 3. è´¨é‡æ ¡éªŒæœºåˆ¶

ç³»ç»Ÿåœ¨ç”Ÿæˆå›å¤åä¼šè‡ªåŠ¨è¿›è¡Œè´¨é‡æ ¡éªŒï¼š

- **ç›¸å…³æ€§æ£€æŸ¥**ï¼šå›å¤æ˜¯å¦ä¸é‚®ä»¶å†…å®¹ç›¸å…³
- **ä¸“ä¸šæ€§æ£€æŸ¥**ï¼šå›å¤æ˜¯å¦ä¸“ä¸šã€å‡†ç¡®
- **å®Œæ•´æ€§æ£€æŸ¥**ï¼šå›å¤æ˜¯å¦å®Œæ•´å›ç­”äº†é—®é¢˜
- **å‹å¥½æ€§æ£€æŸ¥**ï¼šå›å¤è¯­æ°”æ˜¯å¦å‹å¥½ã€ç¤¼è²Œ

å¦‚æœæ ¡éªŒä¸é€šè¿‡ï¼Œç³»ç»Ÿä¼šé‡æ–°ç”Ÿæˆå›å¤ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰ã€‚

---

## æŠ€æœ¯æ ˆ

### LangChain æ¡†æ¶ï¼ˆæ ¸å¿ƒï¼‰

**LangChain** æ˜¯æœ¬é¡¹ç›®çš„æ ¸å¿ƒæ¡†æ¶ï¼Œæä¾›äº†å®Œæ•´çš„LLMåº”ç”¨å¼€å‘å·¥å…·é“¾ã€‚

#### LangChain ç»„ä»¶ä½¿ç”¨

| LangChainç»„ä»¶ | ç”¨é€” | åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨ |
|--------------|------|--------------|
| **langchain-core** | æ ¸å¿ƒæŠ½è±¡å’Œæ¥å£ | æä¾›åŸºç¡€ç±»å’Œæ¥å£å®šä¹‰ |
| **langchain-community** | ç¤¾åŒºé›†æˆ | æä¾›æ–‡æ¡£åŠ è½½å™¨ç­‰å·¥å…· |
| **langchain-openai** | OpenAIå…¼å®¹æ¥å£ | è¿æ¥ç¡…åŸºæµåŠ¨APIï¼ˆChatOpenAIã€OpenAIEmbeddingsï¼‰ |
| **langchain-chroma** | ChromaDBé›†æˆ | å‘é‡æ•°æ®åº“æ“ä½œå’Œæ£€ç´¢ |
| **langgraph** | å·¥ä½œæµå¼•æ“ | çŠ¶æ€å›¾å·¥ä½œæµç¼–æ’ |

#### LangChain åœ¨é¡¹ç›®ä¸­çš„å…·ä½“åº”ç”¨

**1. LLMè°ƒç”¨** (`langchain_openai.ChatOpenAI`)
```python
from langchain_openai import ChatOpenAI

# ä½¿ç”¨LangChainçš„ChatOpenAIè¿æ¥ç¡…åŸºæµåŠ¨API
llm = ChatOpenAI(
    model="moonshotai/Kimi-K2-Thinking",
    temperature=0.1,
    openai_api_key=api_key,
    openai_api_base="https://api.siliconflow.cn/v1"
)
```

**2. æ–‡æœ¬åµŒå…¥** (`langchain_openai.OpenAIEmbeddings`)
```python
from langchain_openai import OpenAIEmbeddings

# ä½¿ç”¨LangChainçš„åµŒå…¥æ¨¡å‹æ¥å£
embeddings = OpenAIEmbeddings(
    model="Qwen/Qwen3-Embedding-4B",
    openai_api_key=api_key,
    openai_api_base="https://api.siliconflow.cn/v1"
)
```

**3. å‘é‡æ•°æ®åº“** (`langchain_chroma.Chroma`)
```python
from langchain_chroma import Chroma

# ä½¿ç”¨LangChainçš„Chromaé›†æˆ
vectorstore = Chroma.from_documents(
    documents=doc_chunks,
    embedding=embeddings,
    persist_directory="db_2560",
    collection_name="langchain"
)
```

**4. æç¤ºè¯ç®¡ç†** (`langchain_core.prompts.ChatPromptTemplate`)
```python
from langchain_core.prompts import ChatPromptTemplate

# ä½¿ç”¨LangChainçš„æç¤ºè¯æ¨¡æ¿
prompt = ChatPromptTemplate.from_template(
    "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ã€‚\n\né‚®ä»¶å†…å®¹ï¼š{email}\n\nè¯·ç”Ÿæˆå›å¤ï¼š"
)
```

**5. é“¾å¼è°ƒç”¨** (`langchain_core.runnables.RunnablePassthrough`)
```python
from langchain_core.runnables import RunnablePassthrough
from langchain_core.output_parsers import StrOutputParser

# ä½¿ç”¨LangChainçš„é“¾å¼è°ƒç”¨
chain = (
    {"context": retriever, "question": RunnablePassthrough()}
    | prompt
    | llm
    | StrOutputParser()
)
```

**6. æ–‡æ¡£å¤„ç†** (`langchain_community.document_loaders`, `langchain_text_splitters`)
```python
from langchain_community.document_loaders import TextLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter

# ä½¿ç”¨LangChainçš„æ–‡æ¡£åŠ è½½å™¨
loader = TextLoader("./data/agency.txt")
docs = loader.load()

# ä½¿ç”¨LangChainçš„æ–‡æ¡£åˆ†å—å™¨
splitter = RecursiveCharacterTextSplitter(
    chunk_size=300,
    chunk_overlap=50
)
chunks = splitter.split_documents(docs)
```

**7. å·¥ä½œæµç¼–æ’** (`langgraph`)
```python
from langgraph.graph import StateGraph, END

# ä½¿ç”¨LangGraphæ„å»ºçŠ¶æ€å›¾å·¥ä½œæµ
workflow = StateGraph(GraphState)
workflow.add_node("categorize_email", nodes.categorize_email)
workflow.add_conditional_edges(
    "categorize_email",
    nodes.route_email_based_on_category,
    {
        "product related": "construct_rag_queries",
        "not product related": "email_writer",
        "unrelated": "skip_unrelated_email"
    }
)
```

#### LangChain çš„ä¼˜åŠ¿

1. **ç»Ÿä¸€çš„APIæ¥å£**ï¼šé€šè¿‡ç»Ÿä¸€çš„æ¥å£è°ƒç”¨ä¸åŒçš„LLMæœåŠ¡
2. **ä¸°å¯Œçš„å·¥å…·é“¾**ï¼šæ–‡æ¡£å¤„ç†ã€å‘é‡æ£€ç´¢ã€æç¤ºè¯ç®¡ç†ç­‰ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆ
3. **å¯ç»„åˆæ€§**ï¼šé€šè¿‡é“¾å¼è°ƒç”¨ç»„åˆä¸åŒçš„ç»„ä»¶
4. **æ˜“äºæ‰©å±•**ï¼šæ”¯æŒè‡ªå®šä¹‰ç»„ä»¶å’Œå·¥å…·
5. **æ´»è·ƒçš„ç¤¾åŒº**ï¼šä¸°å¯Œçš„é›†æˆå’Œç¤ºä¾‹

### åç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Python | 3.8+ | ç¼–ç¨‹è¯­è¨€ |
| FastAPI | latest | Webæ¡†æ¶ |
| **LangChain** | latest | **LLMåº”ç”¨æ¡†æ¶ï¼ˆæ ¸å¿ƒï¼‰** |
| **LangGraph** | latest | **å·¥ä½œæµå¼•æ“ï¼ˆåŸºäºLangChainï¼‰** |
| langchain-core | latest | LangChainæ ¸å¿ƒåº“ |
| langchain-community | latest | LangChainç¤¾åŒºé›†æˆ |
| langchain-openai | latest | OpenAIå…¼å®¹æ¥å£ï¼ˆç”¨äºç¡…åŸºæµåŠ¨APIï¼‰ |
| langchain-chroma | latest | ChromaDBå‘é‡æ•°æ®åº“é›†æˆ |
| ChromaDB | latest | å‘é‡æ•°æ®åº“ |
| sentence-transformers | latest | æœ¬åœ°æ–‡æœ¬åµŒå…¥æ¨¡å‹ï¼ˆå¤‡ç”¨ï¼‰ |
| python-dotenv | latest | ç¯å¢ƒå˜é‡ç®¡ç† |
| uvicorn | latest | ASGIæœåŠ¡å™¨ |

### å‰ç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Vue 3 | ^3.4.0 | å‰ç«¯æ¡†æ¶ |
| Element Plus | ^2.4.0 | UIç»„ä»¶åº“ |
| Vue Router | ^4.2.0 | è·¯ç”±ç®¡ç† |
| Pinia | ^2.1.0 | çŠ¶æ€ç®¡ç† |
| Axios | ^1.6.0 | HTTPå®¢æˆ·ç«¯ |
| ECharts | ^5.4.0 | æ•°æ®å¯è§†åŒ– |
| Vite | ^5.0.0 | æ„å»ºå·¥å…· |

### AIæœåŠ¡

| æœåŠ¡ | æ¨¡å‹ | ç”¨é€” |
|------|------|------|
| ç¡…åŸºæµåŠ¨ | moonshotai/Kimi-K2-Thinking (é»˜è®¤) | æ–‡æœ¬ç”Ÿæˆã€åˆ†ç±»ã€å›å¤ç”Ÿæˆ |
| ç¡…åŸºæµåŠ¨ | Qwen/Qwen3-Embedding-4B (é»˜è®¤) | æ–‡æœ¬åµŒå…¥ |
| ç¡…åŸºæµåŠ¨ | Qwen/Qwen3-Embedding-8B (å¯é€‰) | æ–‡æœ¬åµŒå…¥ï¼ˆæ›´é«˜ç»´åº¦ï¼‰ |

### é‚®ç®±æœåŠ¡

- **QQé‚®ç®±**ï¼šIMAPï¼ˆæ¥æ”¶é‚®ä»¶ï¼‰+ SMTPï¼ˆå‘é€é‚®ä»¶ï¼‰

---

## å·¥ä½œæµç¨‹

### è¯¦ç»†å·¥ä½œæµ

```python
# 1. åŠ è½½æ–°é‚®ä»¶
load_inbox_emails()
  â†’ è¿æ¥IMAPæœåŠ¡å™¨
  â†’ è·å–æœªè¯»é‚®ä»¶åˆ—è¡¨
  â†’ è§£æé‚®ä»¶å†…å®¹ï¼ˆä¸»é¢˜ã€æ­£æ–‡ã€å‘ä»¶äººç­‰ï¼‰

# 2. æ£€æŸ¥é‚®ç®±æ˜¯å¦ä¸ºç©º
is_email_inbox_empty()
  â†’ å¦‚æœä¸ºç©ºï¼Œç»“æŸæµç¨‹
  â†’ å¦‚æœæœ‰é‚®ä»¶ï¼Œç»§ç»­å¤„ç†

# 3. é‚®ä»¶åˆ†ç±»
categorize_email()
  â†’ è°ƒç”¨åˆ†ç±»ä»£ç†
  â†’ åˆ†æé‚®ä»¶å†…å®¹
  â†’ è¿”å›åˆ†ç±»ç»“æœï¼ˆproduct related / complaint / feedback / unrelatedï¼‰

# 4. è·¯ç”±å†³ç­–
route_email_based_on_category()
  â†’ æ ¹æ®åˆ†ç±»ç»“æœè·¯ç”±åˆ°ä¸åŒèŠ‚ç‚¹

# 5a. äº§å“ç›¸å…³é‚®ä»¶å¤„ç†
construct_rag_queries()
  â†’ ä»é‚®ä»¶ä¸­æå–å…³é”®é—®é¢˜
  â†’ æ„å»ºRAGæŸ¥è¯¢è¯­å¥

retrieve_from_rag()
  â†’ å°†æŸ¥è¯¢å‘é‡åŒ–
  â†’ åœ¨ChromaDBä¸­æ£€ç´¢ç›¸ä¼¼æ–‡æ¡£
  â†’ è¿”å›Top-Kç›¸å…³æ–‡æ¡£ç‰‡æ®µ

# 5b. æŠ•è¯‰/åé¦ˆé‚®ä»¶å¤„ç†
  â†’ ç›´æ¥è¿›å…¥å†™ä½œé˜¶æ®µ

# 6. ç”Ÿæˆå›å¤
write_draft_email()
  â†’ ç»„è£…æç¤ºè¯ï¼ˆé‚®ä»¶å†…å®¹ + æ£€ç´¢åˆ°çš„æ–‡æ¡£ + ç³»ç»Ÿæç¤ºï¼‰
  â†’ è°ƒç”¨å†™ä½œä»£ç†ç”Ÿæˆå›å¤
  â†’ è¿”å›ç”Ÿæˆçš„å›å¤å†…å®¹

# 7. è´¨é‡æ ¡éªŒ
verify_generated_email()
  â†’ è°ƒç”¨æ ¡å¯¹ä»£ç†
  â†’ æ£€æŸ¥å›å¤è´¨é‡ï¼ˆç›¸å…³æ€§ã€ä¸“ä¸šæ€§ã€å®Œæ•´æ€§ã€å‹å¥½æ€§ï¼‰
  â†’ è¿”å›æ ¡éªŒç»“æœï¼ˆé€šè¿‡/ä¸é€šè¿‡ï¼‰

# 8. åˆ›å»ºå›å¤
create_draft_response()
  â†’ å¦‚æœæ ¡éªŒé€šè¿‡ï¼Œåˆ›å»ºé‚®ä»¶è‰ç¨¿
  â†’ ä¿å­˜åˆ°ç³»ç»Ÿæ•°æ®åº“
  â†’ å¯é€‰ï¼šå‘é€åˆ°QQé‚®ç®±è‰ç¨¿ç®±

# 9. è·³è¿‡æ— å…³é‚®ä»¶
skip_unrelated_email()
  â†’ æ ‡è®°ä¸ºæ— å…³é‚®ä»¶
  â†’ ä¸ç”Ÿæˆå›å¤
```

### çŠ¶æ€æµè½¬

```python
GraphState {
    emails: List[Email]              # é‚®ä»¶åˆ—è¡¨
    current_email: Email              # å½“å‰å¤„ç†çš„é‚®ä»¶
    email_category: str               # é‚®ä»¶åˆ†ç±»
    rag_queries: List[str]            # RAGæŸ¥è¯¢åˆ—è¡¨
    retrieved_documents: str          # æ£€ç´¢åˆ°çš„æ–‡æ¡£
    generated_email: str              # ç”Ÿæˆçš„å›å¤
    writer_messages: List[Message]    # å†™ä½œä»£ç†æ¶ˆæ¯å†å²
    sendable: bool                    # æ˜¯å¦å¯å‘é€
    trials: int                       # é‡è¯•æ¬¡æ•°
}
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# QQé‚®ç®±é…ç½®
MY_EMAIL=your_email@qq.com
QQ_EMAIL_AUTH_CODE=your_auth_code

# ç¡…åŸºæµåŠ¨APIé…ç½®
SILICONFLOW_API_KEY=sk-your_api_key

# å¯é€‰ï¼šæ•°æ®åº“è·¯å¾„
DB_PATH=./db

# å¯é€‰ï¼šAPIç«¯å£
API_PORT=8000

# å¯é€‰ï¼šå‰ç«¯ç«¯å£
FRONTEND_PORT=3000
```

### QQé‚®ç®±é…ç½®

1. **è·å–æˆæƒç **
   - ç™»å½• [QQé‚®ç®±ç½‘é¡µç‰ˆ](https://mail.qq.com/)
   - è®¾ç½® â†’ è´¦æˆ· â†’ POP3/IMAP/SMTPæœåŠ¡
   - å¼€å¯"IMAP/SMTPæœåŠ¡"
   - ç”Ÿæˆæˆæƒç ï¼ˆ16ä½å­—ç¬¦ï¼‰

2. **æœåŠ¡å™¨ä¿¡æ¯**
   - IMAPæœåŠ¡å™¨ï¼š`imap.qq.com`ï¼Œç«¯å£ï¼š`993`ï¼ˆSSLï¼‰
   - SMTPæœåŠ¡å™¨ï¼š`smtp.qq.com`ï¼Œç«¯å£ï¼š`465`ï¼ˆSSLï¼‰

### ç¡…åŸºæµåŠ¨é…ç½®

1. **æ³¨å†Œè´¦å·**
   - è®¿é—® [ç¡…åŸºæµåŠ¨](https://siliconflow.cn/)
   - æ³¨å†Œå¹¶ç™»å½•

2. **åˆ›å»ºAPIå¯†é’¥**
   - æ§åˆ¶å° â†’ APIå¯†é’¥ â†’ åˆ›å»ºå¯†é’¥
   - å¤åˆ¶å¯†é’¥ï¼ˆæ ¼å¼ï¼š`sk-xxxxx`ï¼‰

3. **æ¨¡å‹é€‰æ‹©**
   - LLMæ¨¡å‹é»˜è®¤ï¼š`moonshotai/Kimi-K2-Thinking`
   - åµŒå…¥æ¨¡å‹é»˜è®¤ï¼š`Qwen/Qwen3-Embedding-4B`
   - å¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼š
     - `REPLY_MODEL` - è®¾ç½®LLMæ¨¡å‹
     - `EMBEDDING_MODEL` - è®¾ç½®åµŒå…¥æ¨¡å‹
   - æ”¯æŒçš„æ¨¡å‹ï¼šç¡…åŸºæµåŠ¨å¹³å°ä¸Šçš„æ‰€æœ‰æ¨¡å‹

### å‘é‡æ•°æ®åº“é…ç½®

#### åˆ›å»ºç´¢å¼•

```bash
python create_index.py
```

#### ä¸åŒç»´åº¦ç´¢å¼•

é¡¹ç›®æä¾›äº†ä¸åŒåµŒå…¥ç»´åº¦çš„ç´¢å¼•åˆ›å»ºè„šæœ¬ï¼š

- `create_index.py` - ä½¿ç”¨ Qwen/Qwen3-Embedding-8Bï¼ˆ4096ç»´ï¼Œé»˜è®¤dbç›®å½•ï¼‰
- `create_index_1024.py` - 1024ç»´æ¨¡å‹ï¼ˆdb_1024ç›®å½•ï¼‰
- `create_index_2560.py` - 2560ç»´æ¨¡å‹ï¼ˆdb_2560ç›®å½•ï¼Œå¯¹åº”Qwen3-Embedding-4Bï¼‰
- `create_index_4096.py` - 4096ç»´æ¨¡å‹ï¼ˆdb_4096ç›®å½•ï¼Œå¯¹åº”Qwen3-Embedding-8Bï¼‰

**æ³¨æ„**ï¼šç³»ç»Ÿä¼šæ ¹æ®åµŒå…¥æ¨¡å‹ç»´åº¦è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„æ•°æ®åº“ç›®å½•ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®šã€‚

#### é‡å»ºç´¢å¼•

```bash
# åˆ é™¤æ—§æ•°æ®åº“
rmdir /s /q db  # Windows
rm -rf db       # Linux/Mac

# é‡æ–°åˆ›å»º
python create_index.py
```

---

## APIæ¥å£

### RESTful API

#### åŸºç¡€ä¿¡æ¯

- **Base URL**: `http://localhost:8000`
- **APIå‰ç¼€**: `/api`
- **è®¤è¯æ–¹å¼**: Session Cookie (ç™»å½•åè‡ªåŠ¨è®¾ç½®)
- **å†…å®¹ç±»å‹**: `application/json`
- **å­—ç¬¦ç¼–ç **: UTF-8

#### è®¤è¯ç›¸å…³

**1. ç”¨æˆ·ç™»å½•**

```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "user": {
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin"
  }
}
```

**2. ç”¨æˆ·æ³¨å†Œ**

```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "newuser",
  "password": "password123",
  "email": "user@example.com"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸ"
}
```

**3. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯**

```http
GET /api/auth/me
Cookie: session=xxx
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "username": "admin",
  "email": "admin@example.com",
  "role": "admin"
}
```

**4. ç”¨æˆ·ç™»å‡º**

```http
POST /api/auth/logout
Cookie: session=xxx
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "ç™»å‡ºæˆåŠŸ"
}
```

#### é‚®ä»¶ç›¸å…³

**1. è·å–é‚®ä»¶åˆ—è¡¨**

```http
GET /api/emails?status=all&page=1&page_size=20
Cookie: session=xxx
```

**æŸ¥è¯¢å‚æ•°**ï¼š
- `status`: é‚®ä»¶çŠ¶æ€ (`all` | `unread` | `processed` | `draft`)
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "emails": [
    {
      "id": "email_001",
      "sender": "customer@example.com",
      "subject": "äº§å“å’¨è¯¢",
      "body": "æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ ä»¬çš„äº§å“...",
      "category": "product_enquiry",
      "status": "processed",
      "reply": "æ„Ÿè°¢æ‚¨çš„å’¨è¯¢...",
      "created_at": "2024-01-01T10:00:00",
      "processed_at": "2024-01-01T10:05:00"
    }
  ],
  "total": 100,
  "page": 1,
  "page_size": 20
}
```

**2. è·å–é‚®ä»¶è¯¦æƒ…**

```http
GET /api/emails/{email_id}
Cookie: session=xxx
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "id": "email_001",
  "sender": "customer@example.com",
  "subject": "äº§å“å’¨è¯¢",
  "body": "å®Œæ•´çš„é‚®ä»¶å†…å®¹...",
  "category": "product_enquiry",
  "status": "processed",
  "reply": "ç”Ÿæˆçš„å›å¤å†…å®¹...",
  "rag_queries": ["äº§å“ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ", "æœ‰å“ªäº›åŠŸèƒ½ï¼Ÿ"],
  "retrieved_documents": "æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹...",
  "created_at": "2024-01-01T10:00:00",
  "processed_at": "2024-01-01T10:05:00"
}
```

**3. å¤„ç†æ–°é‚®ä»¶**

```http
POST /api/emails/process
Content-Type: application/json
Cookie: session=xxx

{
  "auto_send": false  // æ˜¯å¦è‡ªåŠ¨å‘é€ï¼ˆå¯é€‰ï¼‰
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "å¼€å§‹å¤„ç†é‚®ä»¶",
  "task_id": "task_123"
}
```

**è¯´æ˜**ï¼š
- æ­¤æ¥å£ä¼šè§¦å‘LangGraphå·¥ä½œæµå¤„ç†æ–°é‚®ä»¶
- å¤„ç†è¿‡ç¨‹é€šè¿‡WebSocketå®æ—¶æ¨é€çŠ¶æ€
- å¦‚æœ `auto_send=true`ï¼Œå¤„ç†å®Œæˆåä¼šè‡ªåŠ¨å‘é€

**4. å‘é€é‚®ä»¶**

```http
POST /api/emails/{email_id}/send
Content-Type: application/json
Cookie: session=xxx

{
  "reply_text": "è‡ªå®šä¹‰å›å¤å†…å®¹ï¼ˆå¯é€‰ï¼‰"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "é‚®ä»¶å‘é€æˆåŠŸ"
}
```

**é€Ÿç‡é™åˆ¶**ï¼š
- æ¯å°æ—¶æœ€å¤š20å°
- æ¯åŠå°æ—¶æœ€å¤š10å°
- æ¯å°é‚®ä»¶ä¹‹é—´è‡³å°‘é—´éš”30ç§’

**5. æ›´æ–°é‚®ä»¶**

```http
PUT /api/emails/{email_id}
Content-Type: application/json
Cookie: session=xxx

{
  "reply": "ä¿®æ”¹åçš„å›å¤å†…å®¹",
  "status": "draft"
}
```

**6. åˆ é™¤é‚®ä»¶**

```http
DELETE /api/emails/{email_id}
Cookie: session=xxx
```

#### çŸ¥è¯†åº“ç›¸å…³

**1. è·å–æ–‡æ¡£åˆ—è¡¨**

```http
GET /api/knowledge
Cookie: session=xxx
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "documents": [
    {
      "id": "doc_001",
      "filename": "agency.txt",
      "size": 10240,
      "chunks": 50,
      "created_at": "2024-01-01T00:00:00"
    }
  ]
}
```

**2. ä¸Šä¼ æ–‡æ¡£**

```http
POST /api/knowledge/upload
Content-Type: multipart/form-data
Cookie: session=xxx

file: [æ–‡ä»¶å†…å®¹]
```

**æ”¯æŒçš„æ ¼å¼**ï¼š
- `.txt` æ–‡æœ¬æ–‡ä»¶

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "æ–‡æ¡£ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨æ„å»ºç´¢å¼•...",
  "document_id": "doc_001",
  "chunks": 50
}
```

**å¤„ç†æµç¨‹**ï¼š
1. ä¸Šä¼ æ–‡ä»¶
2. è‡ªåŠ¨åˆ†å—ï¼ˆ300å­—ç¬¦/å—ï¼Œé‡å 50å­—ç¬¦ï¼‰
3. å‘é‡åŒ–ï¼ˆä½¿ç”¨åµŒå…¥æ¨¡å‹ï¼‰
4. å­˜å‚¨åˆ°ChromaDB
5. è¿”å›å¤„ç†ç»“æœ

**3. åˆ é™¤æ–‡æ¡£**

```http
DELETE /api/knowledge/{document_id}
Cookie: session=xxx
```

**4. é‡å»ºç´¢å¼•**

```http
POST /api/knowledge/rebuild
Cookie: session=xxx
```

**è¯´æ˜**ï¼š
- é‡æ–°å¤„ç†æ‰€æœ‰æ–‡æ¡£
- åˆ é™¤æ—§ç´¢å¼•
- åˆ›å»ºæ–°ç´¢å¼•
- å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´

**5. æµ‹è¯•æ£€ç´¢**

```http
POST /api/knowledge/search
Content-Type: application/json
Cookie: session=xxx

{
  "query": "äº§å“ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ",
  "top_k": 3
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "query": "äº§å“ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ",
  "results": [
    {
      "content": "æˆ‘ä»¬çš„äº§å“ä»·æ ¼æ˜¯...",
      "score": 0.95,
      "source": "agency.txt",
      "chunk_index": 10
    }
  ]
}
```

#### å†å²è®°å½•ç›¸å…³

**1. è·å–å†å²è®°å½•**

```http
GET /api/history?start_date=2024-01-01&end_date=2024-01-31&keyword=å’¨è¯¢
Cookie: session=xxx
```

**æŸ¥è¯¢å‚æ•°**ï¼š
- `start_date`: å¼€å§‹æ—¥æœŸ (YYYY-MM-DD)
- `end_date`: ç»“æŸæ—¥æœŸ (YYYY-MM-DD)
- `keyword`: å…³é”®è¯æœç´¢
- `category`: åˆ†ç±»ç­›é€‰
- `page`: é¡µç 
- `page_size`: æ¯é¡µæ•°é‡

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "records": [
    {
      "id": "email_001",
      "sender": "customer@example.com",
      "subject": "äº§å“å’¨è¯¢",
      "category": "product_enquiry",
      "status": "sent",
      "processed_at": "2024-01-01T10:05:00"
    }
  ],
  "total": 100,
  "page": 1
}
```

**2. å¯¼å‡ºExcel**

```http
GET /api/history/export?start_date=2024-01-01&end_date=2024-01-31
Cookie: session=xxx
```

**å“åº”**ï¼š
- Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- æ–‡ä»¶ä¸‹è½½ï¼ˆ.xlsxæ ¼å¼ï¼‰

**Excelå†…å®¹**ï¼š
- é‚®ä»¶IDã€å‘ä»¶äººã€ä¸»é¢˜ã€åˆ†ç±»ã€çŠ¶æ€ã€å¤„ç†æ—¶é—´ã€å›å¤å†…å®¹ç­‰

#### ç³»ç»Ÿè®¾ç½®ç›¸å…³

**1. è·å–ç”¨æˆ·è®¾ç½®**

```http
GET /api/settings
Cookie: session=xxx
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "signature": "Agentia å›¢é˜Ÿ",
  "greeting": "å°Šæ•¬çš„å®¢æˆ·ï¼Œæ‚¨å¥½ï¼",
  "closing": "ç¥å¥½ï¼",
  "auto_send": false,
  "auto_start": false
}
```

**2. æ›´æ–°ç”¨æˆ·è®¾ç½®**

```http
PUT /api/settings
Content-Type: application/json
Cookie: session=xxx

{
  "signature": "è‡ªå®šä¹‰ç­¾å",
  "greeting": "è‡ªå®šä¹‰é—®å€™è¯­",
  "closing": "è‡ªå®šä¹‰ç»“æŸè¯­",
  "auto_send": true,
  "auto_start": true
}
```

### WebSocket API

**è¿æ¥åœ°å€**ï¼š
```
ws://localhost:8000/ws
```

**è¿æ¥æ–¹å¼**ï¼š
```javascript
const ws = new WebSocket('ws://localhost:8000/ws');

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  console.log(message);
};
```

**æ¶ˆæ¯ç±»å‹**ï¼š

1. **é‚®ä»¶å¤„ç†çŠ¶æ€æ›´æ–°**

```json
{
  "type": "email_processed",
  "data": {
    "email_id": "email_001",
    "status": "success",
    "category": "product_enquiry",
    "message": "é‚®ä»¶å¤„ç†å®Œæˆ"
  }
}
```

2. **å¤„ç†è¿›åº¦æ›´æ–°**

```json
{
  "type": "processing_progress",
  "data": {
    "current": 1,
    "total": 5,
    "message": "æ­£åœ¨å¤„ç†ç¬¬1å°é‚®ä»¶..."
  }
}
```

3. **é”™è¯¯é€šçŸ¥**

```json
{
  "type": "error",
  "data": {
    "message": "å¤„ç†å¤±è´¥ï¼šAPIè°ƒç”¨è¶…æ—¶",
    "email_id": "email_001"
  }
}
```

4. **ç³»ç»Ÿé€šçŸ¥**

```json
{
  "type": "notification",
  "data": {
    "message": "æ–°é‚®ä»¶å·²æ¥æ”¶",
    "level": "info"  // info | warning | error
  }
}
```

### APIæ–‡æ¡£

å¯åŠ¨åç«¯åï¼Œè®¿é—®ï¼š

- **Swagger UI**: http://localhost:8000/docs
  - äº¤äº’å¼APIæ–‡æ¡£
  - å¯ä»¥ç›´æ¥æµ‹è¯•API
  - æŸ¥çœ‹è¯·æ±‚/å“åº”ç¤ºä¾‹

- **ReDoc**: http://localhost:8000/redoc
  - ç¾è§‚çš„APIæ–‡æ¡£
  - é€‚åˆé˜…è¯»å’Œåˆ†äº«

### é”™è¯¯å¤„ç†

**é”™è¯¯å“åº”æ ¼å¼**ï¼š
```json
{
  "detail": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

**å¸¸è§é”™è¯¯ç **ï¼š

- `400 Bad Request`: è¯·æ±‚å‚æ•°é”™è¯¯
- `401 Unauthorized`: æœªè®¤è¯æˆ–è®¤è¯å¤±è´¥
- `403 Forbidden`: æƒé™ä¸è¶³
- `404 Not Found`: èµ„æºä¸å­˜åœ¨
- `429 Too Many Requests`: è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰
- `500 Internal Server Error`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

**é”™è¯¯å¤„ç†ç¤ºä¾‹**ï¼š
```json
{
  "detail": "å·²è¾¾åˆ°æ¯å°æ—¶å‘é€é™åˆ¶ï¼ˆ20å°ï¼‰ï¼Œè¯·ç­‰å¾…30åˆ†é’Ÿåé‡è¯•"
}
```

---

## æ•°æ®åº“ç»“æ„

### å‘é‡æ•°æ®åº“ï¼ˆChromaDBï¼‰

**å­˜å‚¨ä½ç½®**ï¼š`db/` ç›®å½•

**é›†åˆåç§°**ï¼š`langchain`

**æ–‡ä»¶ç»“æ„**ï¼š
```
db/
â”œâ”€â”€ chroma.sqlite3          # SQLiteæ•°æ®åº“ï¼ˆå…ƒæ•°æ®ï¼‰
â””â”€â”€ [collection_id]/        # é›†åˆæ•°æ®ç›®å½•
    â”œâ”€â”€ data_level0.bin      # å‘é‡æ•°æ®ï¼ˆLevel 0ï¼‰
    â”œâ”€â”€ header.bin           # ç´¢å¼•å¤´æ–‡ä»¶
    â”œâ”€â”€ length.bin           # å‘é‡é•¿åº¦ä¿¡æ¯
    â””â”€â”€ link_lists.bin       # é“¾æ¥åˆ—è¡¨ï¼ˆHNSWç´¢å¼•ï¼‰
```

**æ–‡æ¡£ç»“æ„**ï¼š
```python
{
    "id": "doc_001_chunk_0",           # æ–‡æ¡£IDï¼ˆæ ¼å¼ï¼šæ–‡ä»¶å_å—ç´¢å¼•ï¼‰
    "content": "æ–‡æ¡£å†…å®¹ç‰‡æ®µ...",      # æ–‡æ¡£å†…å®¹ï¼ˆ300å­—ç¬¦ï¼‰
    "metadata": {
        "source": "agency.txt",         # æºæ–‡ä»¶å
        "chunk_index": 0,               # å—ç´¢å¼•
        "total_chunks": 50              # æ€»å—æ•°
    },
    "embedding": [0.123, 0.456, ...]    # å‘é‡åµŒå…¥ï¼ˆ1024ç»´ï¼‰
}
```

**ç´¢å¼•ä¿¡æ¯**ï¼š
- **åµŒå…¥æ¨¡å‹**ï¼š
  - é»˜è®¤ï¼š`Qwen/Qwen3-Embedding-4B`ï¼ˆ2560ç»´ï¼‰
  - å¯é€‰ï¼š`Qwen/Qwen3-Embedding-8B`ï¼ˆ4096ç»´ï¼‰
  - å¤‡ç”¨ï¼šæœ¬åœ°æ¨¡å‹ï¼ˆå¦‚æœAPIå¤±è´¥ï¼‰
- **å‘é‡ç»´åº¦**ï¼š
  - Qwen3-Embedding-4B: 2560ç»´
  - Qwen3-Embedding-8B: 4096ç»´
  - ç³»ç»Ÿä¼šæ ¹æ®æ¨¡å‹åç§°è‡ªåŠ¨æ£€æµ‹ç»´åº¦å¹¶é€‰æ‹©å¯¹åº”çš„æ•°æ®åº“ç›®å½•
- **è·ç¦»åº¦é‡**ï¼šä½™å¼¦ç›¸ä¼¼åº¦ (Cosine Similarity)
- **ç´¢å¼•ç®—æ³•**ï¼šHNSW (Hierarchical Navigable Small World)
- **åˆ†å—ç­–ç•¥**ï¼š
  - å—å¤§å°ï¼š300å­—ç¬¦
  - é‡å ï¼š50å­—ç¬¦
  - åˆ†å‰²å™¨ï¼š`RecursiveCharacterTextSplitter`

**æ£€ç´¢å‚æ•°**ï¼š
- **Top-K**ï¼šé»˜è®¤3ï¼ˆæ£€ç´¢æœ€ç›¸ä¼¼çš„3ä¸ªæ–‡æ¡£ç‰‡æ®µï¼‰
- **ç›¸ä¼¼åº¦é˜ˆå€¼**ï¼šæ— ç¡¬æ€§é˜ˆå€¼ï¼Œè¿”å›Top-Kç»“æœ
- **æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦**ï¼šæ ¹æ®æ¨¡å‹é™åˆ¶ï¼ˆé€šå¸¸2000-4000 tokensï¼‰

**æ•°æ®åº“æ“ä½œ**ï¼š

```python
# ä½¿ç”¨LangChainåˆ›å»ºå‘é‡æ•°æ®åº“
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_community.document_loaders import TextLoader

# 1. åŠ è½½æ–‡æ¡£
loader = TextLoader("./data/agency.txt")
docs = loader.load()

# 2. æ–‡æ¡£åˆ†å—ï¼ˆä½¿ç”¨LangChainçš„åˆ†å—å™¨ï¼‰
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=300,
    chunk_overlap=50
)
doc_chunks = text_splitter.split_documents(docs)

# 3. åˆ›å»ºåµŒå…¥æ¨¡å‹ï¼ˆä½¿ç”¨LangChainçš„OpenAIå…¼å®¹æ¥å£ï¼‰
embeddings = OpenAIEmbeddings(
    model="Qwen/Qwen3-Embedding-4B",  # æˆ– Qwen/Qwen3-Embedding-8B
    openai_api_key=api_key,
    openai_api_base="https://api.siliconflow.cn/v1",
    request_timeout=60
)

# 4. åˆ›å»ºå‘é‡æ•°æ®åº“ï¼ˆä½¿ç”¨LangChainçš„Chromaé›†æˆï¼‰
# ç³»ç»Ÿä¼šæ ¹æ®æ¨¡å‹ç»´åº¦è‡ªåŠ¨é€‰æ‹©æ•°æ®åº“ç›®å½•
vectorstore = Chroma.from_documents(
    documents=doc_chunks,
    embedding=embeddings,
    persist_directory="db_2560",  # æˆ– db_4096ï¼ˆæ ¹æ®ç»´åº¦ï¼‰
    collection_name="langchain"
)

# 5. æ£€ç´¢æ–‡æ¡£ï¼ˆä½¿ç”¨LangChainçš„æ£€ç´¢æ–¹æ³•ï¼‰
results = vectorstore.similarity_search_with_score(
    query="äº§å“ä»·æ ¼",
    k=3  # Top-3
)
```

### ç”¨æˆ·æ•°æ®ï¼ˆJSONæ–‡ä»¶ï¼‰

**`user_data.json` - ç”¨æˆ·è´¦å·æ•°æ®**

**æ–‡ä»¶ä½ç½®**ï¼šé¡¹ç›®æ ¹ç›®å½•

**æ•°æ®ç»“æ„**ï¼š
```json
{
  "users": {
    "admin": {
      "username": "admin",
      "password": "$2b$12$hashed_password_here",  // bcryptå“ˆå¸Œ
      "email": "admin@example.com",
      "role": "admin",                              // admin | user
      "created_at": "2024-01-01T00:00:00",
      "last_login": "2024-01-15T10:30:00"
    },
    "user1": {
      "username": "user1",
      "password": "$2b$12$hashed_password_here",
      "email": "user1@example.com",
      "role": "user",
      "created_at": "2024-01-02T00:00:00",
      "last_login": "2024-01-15T09:20:00"
    }
  }
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `username`: ç”¨æˆ·åï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
- `password`: bcryptå“ˆå¸Œåçš„å¯†ç 
- `email`: ç”¨æˆ·é‚®ç®±
- `role`: ç”¨æˆ·è§’è‰²ï¼ˆadminç®¡ç†å‘˜ / useræ™®é€šç”¨æˆ·ï¼‰
- `created_at`: åˆ›å»ºæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰
- `last_login`: æœ€åç™»å½•æ—¶é—´

**`user_email_data_*.json` - é‚®ä»¶å¤„ç†å†å²**

**æ–‡ä»¶å‘½åè§„åˆ™**ï¼š`user_email_data_{username}.json`

**æ•°æ®ç»“æ„**ï¼š
```json
{
  "emails": [
    {
      "id": "email_001",
      "sender": "customer@example.com",
      "subject": "äº§å“å’¨è¯¢",
      "body": "æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ ä»¬çš„äº§å“ä»·æ ¼å’ŒåŠŸèƒ½...",
      "category": "product_enquiry",
      "generated_reply": "æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ã€‚æˆ‘ä»¬çš„äº§å“ä»·æ ¼æ˜¯...",
      "rag_queries": [
        "äº§å“ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ",
        "äº§å“æœ‰å“ªäº›åŠŸèƒ½ï¼Ÿ"
      ],
      "retrieved_documents": "æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹...",
      "status": "sent",  // unread | processing | processed | sent | draft | failed
      "created_at": "2024-01-01T10:00:00",
      "processed_at": "2024-01-01T10:05:00",
      "sent_at": "2024-01-01T10:06:00",
      "imap_id": "base64_encoded_imap_id",
      "messageId": "<message-id@example.com>",
      "threadId": "thread-id",
      "references": "<previous-message-id@example.com>"
    }
  ],
  "statistics": {
    "total_emails": 100,
    "processed_emails": 95,
    "sent_emails": 90,
    "failed_emails": 5,
    "by_category": {
      "product_enquiry": 60,
      "customer_complaint": 20,
      "customer_feedback": 15,
      "unrelated": 5
    }
  },
  "last_updated": "2024-01-15T10:30:00"
}
```

**å­—æ®µè¯´æ˜**ï¼š

- **é‚®ä»¶åŸºæœ¬ä¿¡æ¯**ï¼š
  - `id`: é‚®ä»¶å”¯ä¸€æ ‡è¯†
  - `sender`: å‘ä»¶äººé‚®ç®±
  - `subject`: é‚®ä»¶ä¸»é¢˜
  - `body`: é‚®ä»¶æ­£æ–‡

- **å¤„ç†ä¿¡æ¯**ï¼š
  - `category`: é‚®ä»¶åˆ†ç±»ï¼ˆproduct_enquiry / customer_complaint / customer_feedback / unrelatedï¼‰
  - `generated_reply`: AIç”Ÿæˆçš„å›å¤å†…å®¹
  - `rag_queries`: RAGæŸ¥è¯¢åˆ—è¡¨
  - `retrieved_documents`: æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹

- **çŠ¶æ€ä¿¡æ¯**ï¼š
  - `status`: é‚®ä»¶çŠ¶æ€
    - `unread`: æœªè¯»
    - `processing`: å¤„ç†ä¸­
    - `processed`: å·²å¤„ç†ï¼ˆæœ‰å›å¤ä½†æœªå‘é€ï¼‰
    - `sent`: å·²å‘é€
    - `draft`: è‰ç¨¿
    - `failed`: å¤„ç†å¤±è´¥

- **æ—¶é—´æˆ³**ï¼š
  - `created_at`: é‚®ä»¶æ¥æ”¶æ—¶é—´
  - `processed_at`: å¤„ç†å®Œæˆæ—¶é—´
  - `sent_at`: å‘é€æ—¶é—´

- **é‚®ä»¶å…ƒæ•°æ®**ï¼š
  - `imap_id`: IMAPé‚®ä»¶IDï¼ˆç”¨äºæ ‡è®°å·²è¯»ï¼‰
  - `messageId`: é‚®ä»¶Message-ID
  - `threadId`: é‚®ä»¶çº¿ç¨‹ID
  - `references`: é‚®ä»¶Referenceså¤´ï¼ˆç”¨äºå›å¤ï¼‰

**æ•°æ®å¤‡ä»½å»ºè®®**ï¼š

1. **å®šæœŸå¤‡ä»½**ï¼š
   ```bash
   # å¤‡ä»½ç”¨æˆ·æ•°æ®
   cp user_data.json user_data.json.backup
   cp user_email_data_*.json backups/
   ```

2. **ç‰ˆæœ¬æ§åˆ¶**ï¼š
   - ä¸è¦å°†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„JSONæ–‡ä»¶æäº¤åˆ°Git
   - ä½¿ç”¨ `.gitignore` æ’é™¤è¿™äº›æ–‡ä»¶

3. **æ•°æ®è¿ç§»**ï¼š
   - å¯¼å‡ºä¸ºExcelæ ¼å¼ï¼ˆé€šè¿‡APIï¼‰
   - å®šæœŸæ¸…ç†æ—§æ•°æ®
   - å½’æ¡£å†å²æ•°æ®

---

## éƒ¨ç½²æŒ‡å—

### å¼€å‘ç¯å¢ƒéƒ¨ç½²

#### Windows

```bash
# 1. å®‰è£…Python 3.8+
# 2. å®‰è£…Node.js 16+

# 3. å®‰è£…åç«¯ä¾èµ–
pip install -r requirements.txt

# 4. å®‰è£…å‰ç«¯ä¾èµ–
cd frontend
npm install

# 5. é…ç½®ç¯å¢ƒå˜é‡
# åˆ›å»º .env æ–‡ä»¶

# 6. åˆå§‹åŒ–æ•°æ®åº“
python create_index.py

# 7. å¯åŠ¨æœåŠ¡
# æ–¹å¼1ï¼šä½¿ç”¨è„šæœ¬
scripts\start_all.bat

# æ–¹å¼2ï¼šæ‰‹åŠ¨å¯åŠ¨
# ç»ˆç«¯1
python backend_api.py

# ç»ˆç«¯2
cd frontend
npm run dev
```

#### Linux/Mac

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt
cd frontend && npm install

# 2. é…ç½®ç¯å¢ƒå˜é‡
# åˆ›å»º .env æ–‡ä»¶

# 3. åˆå§‹åŒ–æ•°æ®åº“
python create_index.py

# 4. å¯åŠ¨æœåŠ¡
# ç»ˆç«¯1
python backend_api.py

# ç»ˆç«¯2
cd frontend
npm run dev
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### åç«¯éƒ¨ç½²

é¡¹ç›®ä½¿ç”¨ `uvicorn` ä½œä¸ºASGIæœåŠ¡å™¨ï¼Œé€šè¿‡ `backend_api.py` ç›´æ¥å¯åŠ¨ï¼š

```bash
# ç›´æ¥è¿è¡Œï¼ˆå¼€å‘ç¯å¢ƒï¼‰
python backend_api.py

# æˆ–ä½¿ç”¨uvicornï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
uvicorn backend_api:app --host 0.0.0.0 --port 8000 --workers 4
```

**å¯åŠ¨å‚æ•°è¯´æ˜**ï¼š
- `--host 0.0.0.0`: ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
- `--port 8000`: ç«¯å£å·
- `--workers 4`: å·¥ä½œè¿›ç¨‹æ•°ï¼ˆæ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´ï¼‰

#### å‰ç«¯éƒ¨ç½²

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
cd frontend
npm run build

# æ„å»ºäº§ç‰©åœ¨ frontend/dist/ ç›®å½•
# å¯ä»¥ä½¿ç”¨ä»»ä½•é™æ€æ–‡ä»¶æœåŠ¡å™¨éƒ¨ç½²ï¼Œå¦‚ï¼š
# - Nginx
# - Apache
# - æˆ–ç›´æ¥ä½¿ç”¨Pythonçš„é™æ€æ–‡ä»¶æœåŠ¡
```

**ä½¿ç”¨Pythoné™æ€æ–‡ä»¶æœåŠ¡ï¼ˆç®€å•æ–¹å¼ï¼‰**ï¼š

```python
# åœ¨backend_api.pyä¸­æ·»åŠ é™æ€æ–‡ä»¶æœåŠ¡
from fastapi.staticfiles import StaticFiles

app.mount("/", StaticFiles(directory="frontend/dist", html=True), name="static")
```

è¿™æ ·å‰ç«¯å’Œåç«¯å¯ä»¥åœ¨åŒä¸€ä¸ªç«¯å£è¿è¡Œã€‚

### æ€§èƒ½ä¼˜åŒ–é…ç½®

#### åç«¯ä¼˜åŒ–

**1. Uvicorné…ç½®**

```bash
# ä½¿ç”¨å¤šä¸ªå·¥ä½œè¿›ç¨‹
uvicorn backend_api:app \
  --host 0.0.0.0 \
  --port 8000 \
  --workers 4 \
  --timeout-keep-alive 30
```

**2. æ•°æ®åº“ä¼˜åŒ–**

- ä½¿ç”¨SSDå­˜å‚¨å‘é‡æ•°æ®åº“
- å®šæœŸæ¸…ç†æ— ç”¨æ–‡æ¡£
- æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µé€‰æ‹©åˆé€‚ç»´åº¦çš„åµŒå…¥æ¨¡å‹ï¼ˆ4Bæ¨¡å‹é€Ÿåº¦æ›´å¿«ï¼Œ8Bæ¨¡å‹ç²¾åº¦æ›´é«˜ï¼‰

**3. APIè°ƒç”¨ä¼˜åŒ–**

- æ‰¹é‡å¤„ç†é‚®ä»¶
- ä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼ˆé¡¹ç›®å·²ä½¿ç”¨ThreadPoolExecutorï¼‰
- åˆç†è®¾ç½®APIè¶…æ—¶æ—¶é—´ï¼ˆåµŒå…¥æ¨¡å‹é»˜è®¤60ç§’ï¼‰

#### å‰ç«¯ä¼˜åŒ–

**1. æ„å»ºä¼˜åŒ–**

Viteå·²è‡ªåŠ¨ä¼˜åŒ–ï¼Œå¦‚éœ€è‡ªå®šä¹‰å¯åœ¨ `frontend/vite.config.js` ä¸­é…ç½®ï¼š

```javascript
export default {
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['vue', 'vue-router', 'pinia'],
          'ui': ['element-plus'],
          'charts': ['echarts', 'vue-echarts']
        }
      }
    }
  }
}
```

**2. é™æ€èµ„æºä¼˜åŒ–**

- å‹ç¼©å›¾ç‰‡
- ä½¿ç”¨CDNåŠ é€Ÿï¼ˆå¦‚éœ€è¦ï¼‰
- å¯ç”¨æµè§ˆå™¨ç¼“å­˜

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. é‚®ç®±è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šæ— æ³•è¿æ¥QQé‚®ç®±

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æˆæƒç æ˜¯å¦æ­£ç¡®ï¼ˆä¸æ˜¯QQå¯†ç ï¼‰
2. ç¡®è®¤å·²å¼€å¯IMAP/SMTPæœåŠ¡
3. æ£€æŸ¥ç½‘ç»œè¿æ¥
4. æŸ¥çœ‹é˜²ç«å¢™è®¾ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æµ‹è¯•é‚®ç®±è¿æ¥
python -c "from src.tools.QQEmailTools import QQEmailToolsClass; tool = QQEmailToolsClass(); tool.connect_imap()"
```

#### 2. APIè°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**ï¼šç¡…åŸºæµåŠ¨APIè¿”å›401æˆ–403é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å¯†é’¥å‰ç¼€æ˜¯ `sk-`
3. æ£€æŸ¥è´¦æˆ·ä½™é¢
4. ç¡®è®¤æ¨¡å‹åç§°æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æµ‹è¯•APIè¿æ¥
python -c "from langchain_openai import ChatOpenAI; import os; llm = ChatOpenAI(base_url='https://api.siliconflow.cn/v1', api_key=os.getenv('SILICONFLOW_API_KEY')); print(llm.invoke('æµ‹è¯•'))"
```

#### 3. å‘é‡æ•°æ®åº“é”™è¯¯

**ç—‡çŠ¶**ï¼šæ£€ç´¢å¤±è´¥æˆ–æ•°æ®åº“æŸå

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ `db/` ç›®å½•æ˜¯å¦å­˜åœ¨
2. æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶æ˜¯å¦å®Œæ•´
3. æ£€æŸ¥åµŒå…¥æ¨¡å‹æ˜¯å¦åŠ è½½æˆåŠŸ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é‡å»ºæ•°æ®åº“
rmdir /s /q db  # Windows
rm -rf db       # Linux/Mac
python create_index.py
```

#### 4. å‰ç«¯æ— æ³•è¿æ¥åç«¯

**ç—‡çŠ¶**ï¼šå‰ç«¯æ˜¾ç¤º"è¿æ¥å¤±è´¥"

**æ’æŸ¥æ­¥éª¤**ï¼š
1. ç¡®è®¤åç«¯å·²å¯åŠ¨ï¼ˆç«¯å£8000ï¼‰
2. æ£€æŸ¥CORSé…ç½®
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
4. æ£€æŸ¥ç½‘ç»œè¯·æ±‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
curl http://localhost:8000/api/health

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -ano | findstr :8000  # Windows
lsof -i :8000                 # Linux/Mac
```

#### 5. å†…å­˜ä¸è¶³

**ç—‡çŠ¶**ï¼šç¨‹åºè¿è¡Œç¼“æ…¢æˆ–å´©æºƒ

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ç³»ç»Ÿå†…å­˜ä½¿ç”¨
2. æŸ¥çœ‹å‘é‡æ•°æ®åº“å¤§å°
3. æ£€æŸ¥å¹¶å‘å¤„ç†æ•°é‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å‡å°‘å¹¶å‘å¤„ç†æ•°é‡
- ä½¿ç”¨æ›´å°çš„åµŒå…¥æ¨¡å‹
- å¢åŠ ç³»ç»Ÿå†…å­˜
- ä¼˜åŒ–å‘é‡æ•°æ®åº“ç´¢å¼•

### æ—¥å¿—æŸ¥çœ‹

#### åç«¯æ—¥å¿—

åç«¯æ—¥å¿—ç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ŒåŒ…æ‹¬ï¼š
- é‚®ä»¶å¤„ç†çŠ¶æ€
- APIè°ƒç”¨è®°å½•
- é”™è¯¯ä¿¡æ¯

#### å‰ç«¯æ—¥å¿—

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰æŸ¥çœ‹ï¼š
- Consoleï¼šJavaScripté”™è¯¯
- Networkï¼šAPIè¯·æ±‚çŠ¶æ€

### æ€§èƒ½ä¼˜åŒ–

#### 1. å‘é‡æ•°æ®åº“ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š

- **é€‰æ‹©åˆé€‚çš„åµŒå…¥æ¨¡å‹**ï¼š
  - Qwen3-Embedding-4Bï¼ˆ2560ç»´ï¼‰ï¼šé€Ÿåº¦å¿«ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼ˆæ¨èï¼‰
  - Qwen3-Embedding-8Bï¼ˆ4096ç»´ï¼‰ï¼šç²¾åº¦æ›´é«˜ï¼Œä½†é€Ÿåº¦è¾ƒæ…¢
  - ç³»ç»Ÿä¼šæ ¹æ®æ¨¡å‹è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„æ•°æ®åº“ç›®å½•

- **ä¼˜åŒ–åˆ†å—ç­–ç•¥**ï¼š
  ```python
  # æ ¹æ®æ–‡æ¡£ç±»å‹è°ƒæ•´åˆ†å—å¤§å°
  text_splitter = RecursiveCharacterTextSplitter(
      chunk_size=300,      # å¯ä»¥è°ƒæ•´ä¸º200-500
      chunk_overlap=50,    # å¯ä»¥è°ƒæ•´ä¸º30-100
      length_function=len
  )
  ```

- **å®šæœŸæ¸…ç†**ï¼š
  - åˆ é™¤è¿‡æœŸçš„æ–‡æ¡£
  - é‡å»ºç´¢å¼•ï¼ˆæ¯æœˆä¸€æ¬¡ï¼‰
  - å‹ç¼©æ•°æ®åº“æ–‡ä»¶

- **ç´¢å¼•ä¼˜åŒ–**ï¼š
  - ä½¿ç”¨SSDå­˜å‚¨
  - å¢åŠ å†…å­˜ç¼“å­˜
  - è°ƒæ•´HNSWå‚æ•°

#### 2. APIè°ƒç”¨ä¼˜åŒ–

**æ‰¹é‡å¤„ç†**ï¼š
```python
# æ‰¹é‡å¤„ç†é‚®ä»¶ï¼Œå‡å°‘APIè°ƒç”¨æ¬¡æ•°
emails = fetch_unanswered_emails()
batch_size = 5
for i in range(0, len(emails), batch_size):
    batch = emails[i:i+batch_size]
    process_batch(batch)
```

**ç¼“å­˜æœºåˆ¶**ï¼š
```python
# ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ
from functools import lru_cache

@lru_cache(maxsize=100)
def cached_rag_query(query):
    return retrieve_from_rag(query)
```

**å¼‚æ­¥å¤„ç†**ï¼š
```python
# ä½¿ç”¨å¼‚æ­¥å¤„ç†æé«˜å¹¶å‘
import asyncio

async def process_emails_async(emails):
    tasks = [process_email(email) for email in emails]
    return await asyncio.gather(*tasks)
```

#### 3. å‰ç«¯ä¼˜åŒ–

**ä»£ç åˆ†å‰²**ï¼š
```javascript
// æŒ‰è·¯ç”±åˆ†å‰²ä»£ç 
const Dashboard = () => import('./views/Dashboard.vue')
const Emails = () => import('./views/Emails.vue')
```

**æ‡’åŠ è½½**ï¼š
```javascript
// å›¾ç‰‡æ‡’åŠ è½½
<img v-lazy="imageUrl" />

// ç»„ä»¶æ‡’åŠ è½½
const Chart = defineAsyncComponent(() => import('./components/Chart.vue'))
```

**èµ„æºä¼˜åŒ–**ï¼š
- å‹ç¼©å›¾ç‰‡ï¼ˆä½¿ç”¨WebPæ ¼å¼ï¼‰
- ä½¿ç”¨CDNåŠ é€Ÿé™æ€èµ„æº
- å¯ç”¨HTTP/2
- ä½¿ç”¨Service Workerç¼“å­˜

#### 4. ç³»ç»Ÿçº§ä¼˜åŒ–

**æ•°æ®åº“è¿æ¥æ± **ï¼š
```python
# å¤ç”¨æ•°æ®åº“è¿æ¥
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

engine = create_engine(
    'sqlite:///db/chroma.sqlite3',
    poolclass=QueuePool,
    pool_size=10,
    max_overflow=20
)
```

**å†…å­˜ç®¡ç†**ï¼š
- é™åˆ¶å¹¶å‘å¤„ç†æ•°é‡
- åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„å¯¹è±¡
- ä½¿ç”¨ç”Ÿæˆå™¨å¤„ç†å¤§é‡æ•°æ®

**ç½‘ç»œä¼˜åŒ–**ï¼š
- ä½¿ç”¨HTTP/2
- å¯ç”¨Keep-Alive
- å‹ç¼©å“åº”æ•°æ®

### é«˜çº§æ•…éšœæ’æŸ¥

#### 1. é‚®ä»¶å¤„ç†å¡ä½

**ç—‡çŠ¶**ï¼šé‚®ä»¶å¤„ç†ä¸€ç›´æ˜¾ç¤º"å¤„ç†ä¸­"ï¼Œæ²¡æœ‰å®Œæˆ

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥LangGraphå·¥ä½œæµæ˜¯å¦æ­£å¸¸è¿è¡Œ
2. æŸ¥çœ‹æ˜¯å¦æœ‰APIè°ƒç”¨è¶…æ—¶
3. æ£€æŸ¥å‘é‡æ•°æ®åº“æ˜¯å¦å“åº”
4. æŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å¢åŠ è¶…æ—¶æ—¶é—´
llm = ChatOpenAI(
    model="moonshotai/Kimi-K2-Thinking",  # æˆ–é€šè¿‡REPLY_MODELç¯å¢ƒå˜é‡é…ç½®
    request_timeout=120,  # å¢åŠ åˆ°120ç§’
    openai_api_key=api_key,
    openai_api_base="https://api.siliconflow.cn/v1"
)

# æ·»åŠ é‡è¯•æœºåˆ¶
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=4, max=10))
def process_email_with_retry(email):
    return process_email(email)
```

#### 2. å‘é‡æ£€ç´¢ç»“æœä¸å‡†ç¡®

**ç—‡çŠ¶**ï¼šæ£€ç´¢åˆ°çš„æ–‡æ¡£ä¸æŸ¥è¯¢ä¸ç›¸å…³

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥åµŒå…¥æ¨¡å‹æ˜¯å¦æ­£ç¡®
2. æŸ¥çœ‹æŸ¥è¯¢è¯­å¥æ˜¯å¦æ¸…æ™°
3. æ£€æŸ¥æ–‡æ¡£åˆ†å—æ˜¯å¦åˆç†
4. éªŒè¯å‘é‡æ•°æ®åº“æ˜¯å¦æŸå

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# è°ƒæ•´æ£€ç´¢å‚æ•°
results = vectorstore.similarity_search_with_score(
    query,
    k=5,  # å¢åŠ æ£€ç´¢æ•°é‡
    score_threshold=0.7  # è®¾ç½®ç›¸ä¼¼åº¦é˜ˆå€¼
)

# ä½¿ç”¨é‡æ’åº
from langchain.retrievers import ContextualCompressionRetriever
from langchain.retrievers.document_compressors import LLMChainExtractor

compressor = LLMChainExtractor.from_llm(llm)
compression_retriever = ContextualCompressionRetriever(
    base_compressor=compressor,
    base_retriever=vectorstore.as_retriever()
)
```

#### 3. é‚®ä»¶åˆ†ç±»ä¸å‡†ç¡®

**ç—‡çŠ¶**ï¼šé‚®ä»¶åˆ†ç±»ç»“æœé”™è¯¯ï¼ˆå¦‚æŠ•è¯‰è¢«åˆ†ç±»ä¸ºæ— å…³ï¼‰

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥åˆ†ç±»æç¤ºè¯æ˜¯å¦æ­£ç¡®
2. æŸ¥çœ‹é‚®ä»¶å†…å®¹æ˜¯å¦å®Œæ•´
3. éªŒè¯AIæ¨¡å‹æ˜¯å¦æ­£å¸¸å·¥ä½œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ä¼˜åŒ–åˆ†ç±»æç¤ºè¯
CATEGORIZE_EMAIL_PROMPT = """
# é‡è¦è§„åˆ™ï¼š
# 1. åŒ…å«"æŠ•è¯‰"ã€"ä¸æ»¡"ç­‰å…³é”®è¯çš„é‚®ä»¶å¿…é¡»åˆ†ç±»ä¸ºcustomer_complaint
# 2. åªæœ‰æ˜ç¡®æ˜¯å¹¿å‘Šæˆ–åƒåœ¾é‚®ä»¶æ‰èƒ½åˆ†ç±»ä¸ºunrelated
# 3. ä¸ç¡®å®šæ—¶ï¼Œä¼˜å…ˆé€‰æ‹©æ›´ç›¸å…³çš„ç±»åˆ«
...
"""

# é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®æ›´å¼ºå¤§çš„æ¨¡å‹
# åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®ï¼š
# REPLY_MODEL=moonshotai/Kimi-K2-Thinking
# æˆ–ä½¿ç”¨ç¡…åŸºæµåŠ¨å¹³å°ä¸Šçš„å…¶ä»–æ¨¡å‹
```

#### 4. å†…å­˜æ³„æ¼

**ç—‡çŠ¶**ï¼šç³»ç»Ÿè¿è¡Œæ—¶é—´è¶Šé•¿ï¼Œå†…å­˜å ç”¨è¶Šé«˜

**æ’æŸ¥æ­¥éª¤**ï¼š
1. ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·ï¼ˆå¦‚memory_profilerï¼‰
2. æ£€æŸ¥æ˜¯å¦æœ‰å¾ªç¯å¼•ç”¨
3. æŸ¥çœ‹æ˜¯å¦æœ‰æœªé‡Šæ”¾çš„èµ„æº

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# åŠæ—¶é‡Šæ”¾èµ„æº
def process_email(email):
    try:
        result = process(email)
        return result
    finally:
        # æ¸…ç†èµ„æº
        del email
        gc.collect()

# é™åˆ¶ç¼“å­˜å¤§å°
from functools import lru_cache

@lru_cache(maxsize=100)  # é™åˆ¶ç¼“å­˜å¤§å°
def cached_function(arg):
    return expensive_operation(arg)
```

#### 5. å¹¶å‘å¤„ç†é—®é¢˜

**ç—‡çŠ¶**ï¼šå¤šä¸ªç”¨æˆ·åŒæ—¶å¤„ç†é‚®ä»¶æ—¶å‡ºç°é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ˜¯å¦æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜
2. æŸ¥çœ‹æ•°æ®åº“é”æ˜¯å¦æ­£å¸¸
3. éªŒè¯èµ„æºç«äº‰æƒ…å†µ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ä½¿ç”¨é”ä¿æŠ¤å…±äº«èµ„æº
from threading import Lock

email_lock = Lock()

def process_email_safely(email):
    with email_lock:
        # å¤„ç†é‚®ä»¶
        return process_email(email)

# ä½¿ç”¨é˜Ÿåˆ—ç®¡ç†ä»»åŠ¡
from queue import Queue

email_queue = Queue(maxsize=100)

def worker():
    while True:
        email = email_queue.get()
        process_email(email)
        email_queue.task_done()
```

### è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

```python
import logging

logging.basicConfig(
    level=logging.DEBUG,  # è®¾ç½®ä¸ºDEBUGçº§åˆ«
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('debug.log'),
        logging.StreamHandler()
    ]
)
```

#### 2. ä½¿ç”¨è°ƒè¯•å·¥å…·

```python
# ä½¿ç”¨pdbè°ƒè¯•
import pdb

def process_email(email):
    pdb.set_trace()  # è®¾ç½®æ–­ç‚¹
    result = process(email)
    return result

# ä½¿ç”¨ipdbï¼ˆæ›´å¼ºå¤§çš„è°ƒè¯•å™¨ï¼‰
import ipdb
ipdb.set_trace()
```

#### 3. æ€§èƒ½åˆ†æ

```python
# ä½¿ç”¨cProfileåˆ†ææ€§èƒ½
import cProfile
import pstats

profiler = cProfile.Profile()
profiler.enable()

# æ‰§è¡Œä»£ç 
process_emails()

profiler.disable()
stats = pstats.Stats(profiler)
stats.sort_stats('cumulative')
stats.print_stats(20)  # æ‰“å°å‰20ä¸ªæœ€è€—æ—¶çš„å‡½æ•°
```

#### 4. ç›‘æ§å…³é”®æŒ‡æ ‡

```python
# ç›‘æ§APIè°ƒç”¨
import time

def monitored_api_call(func):
    def wrapper(*args, **kwargs):
        start_time = time.time()
        try:
            result = func(*args, **kwargs)
            duration = time.time() - start_time
            print(f"APIè°ƒç”¨æˆåŠŸ: {func.__name__}, è€—æ—¶: {duration:.2f}ç§’")
            return result
        except Exception as e:
            duration = time.time() - start_time
            print(f"APIè°ƒç”¨å¤±è´¥: {func.__name__}, è€—æ—¶: {duration:.2f}ç§’, é”™è¯¯: {e}")
            raise
    return wrapper

@monitored_api_call
def call_llm_api(prompt):
    return llm.invoke(prompt)
```

---

## æ›´æ–°æ—¥å¿—

æŸ¥çœ‹ [æ›´æ–°æ—¥å¿—.md](æ›´æ–°æ—¥å¿—.md) äº†è§£ç‰ˆæœ¬æ›´æ–°å†å²ã€‚

---


---



---



