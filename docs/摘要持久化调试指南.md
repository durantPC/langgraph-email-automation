# 摘要持久化调试指南

## 问题描述

用户反馈：关闭详情页面后再打开，摘要又变成"摘要生成中"状态，需要重新轮询。

## 预期行为

摘要应该是**持久化**的：
1. 后端生成摘要后保存到数据库（JSON 文件）
2. 前端刷新页面或重新打开详情时，应该直接显示已保存的摘要
3. 不应该每次都显示"摘要生成中"

## 调试步骤

### 1. 检查后端是否保存了摘要

处理一封邮件后，查看后端日志：

```
✅ [摘要生成] 原始邮件摘要生成成功，长度: 126
✅ [摘要生成] 回复内容摘要生成成功，长度: 98
✅ [摘要生成] 已更新邮件缓存中的摘要: <email_id>
✅ [摘要生成] 已更新历史记录中的摘要: <email_id>
  - body_summary 长度: 126
  - reply_summary 长度: 98
✅ [摘要生成] 摘要已保存到邮件记录: <email_id>
```

**如果看到警告**：
```
⚠️ [摘要生成] 未在历史记录中找到邮件: <email_id>
  - 历史记录总数: 5
  - 历史记录ID列表: [...]
```

说明邮件 ID 不匹配，需要检查：
- 邮件处理时是否正确添加到历史记录
- 邮件 ID 是否一致

### 2. 检查数据文件

打开 `data/users/user_email_data_<username>.json`，查找对应的邮件记录：

```json
{
  "history": [
    {
      "id": "<email_id>",
      "subject": "邮件主题",
      "body_summary": "这是原始邮件的摘要...",
      "reply_summary": "这是回复内容的摘要...",
      "status": "processed",
      ...
    }
  ]
}
```

**检查点**：
- `body_summary` 字段是否存在且有内容
- `reply_summary` 字段是否存在且有内容
- 字段名是否正确（不是 `bodySummary` 或其他变体）

### 3. 检查前端是否收到摘要

打开浏览器控制台（F12），刷新 Dashboard 页面，查看日志：

```javascript
[Dashboard] 获取历史记录响应: {records: Array(5), total: 5, ...}
[Dashboard] 第一条记录: {
  id: "<email_id>",
  subject: "邮件主题",
  has_body_summary: true,
  has_reply_summary: true,
  body_summary_length: 126,
  reply_summary_length: 98
}
```

**如果 `has_body_summary` 或 `has_reply_summary` 为 `false`**：
- 说明后端没有返回摘要字段
- 检查后端数据文件是否真的保存了摘要

### 4. 检查详情对话框的逻辑

点击"查看详情"按钮，查看控制台日志：

```javascript
[详情对话框] 原始邮件摘要已存在
[详情对话框] 回复内容摘要已存在
```

**如果看到**：
```javascript
[详情对话框] 原始邮件摘要生成中，显示临时预览
[详情对话框] 回复内容摘要生成中，显示临时预览
[详情对话框] 启动摘要轮询检查
```

说明前端判断逻辑有问题，检查：
- `rawRecord.body_summary` 是否为 `undefined` 或 `null`
- 字段名是否正确

### 5. 检查 WebSocket 推送

如果摘要是刚生成的，应该通过 WebSocket 实时推送：

**后端日志**：
```
📤 [摘要生成] 准备推送摘要更新:
  - 用户: admin
  - 邮件ID: <email_id>
  - body_summary: 这是原始邮件的摘要...
  - reply_summary: 这是回复内容的摘要...
  - websocket_event_loop 存在: True
✅ [摘要生成] WebSocket 消息已成功发送给用户: admin
```

**前端日志**：
```javascript
[WS] 收到 summary_saved 消息: {
  email_id: "<email_id>",
  has_body_summary: true,
  has_reply_summary: true,
  current_record_id: "<email_id>"
}
[WS] 已更新详情对话框的 body_summary
[WS] 已更新详情对话框的 reply_summary
[WS] 已更新历史记录列表中的摘要: <email_id>
```

## 常见问题

### 问题 1: 后端保存了，但前端没收到

**原因**：
- 后端返回的历史记录中没有包含摘要字段
- 可能是数据序列化问题

**解决**：
- 检查 `save_user_email_data()` 函数是否正确保存
- 检查 `get_history()` API 是否正确返回所有字段

### 问题 2: 前端收到了，但判断逻辑错误

**原因**：
- 前端判断 `rawRecord.body_summary` 时，可能因为空字符串被判断为 `false`

**解决**：
```javascript
// 错误的判断
if (rawRecord.body_summary) { ... }  // 空字符串会被判断为 false

// 正确的判断
if (rawRecord.body_summary !== undefined && rawRecord.body_summary !== null) { ... }
```

### 问题 3: 邮件 ID 不匹配

**原因**：
- 邮件处理时生成的 ID 与历史记录中的 ID 不一致
- 可能是 Message-ID 格式问题（包含 `<>` 符号）

**解决**：
- 统一使用 `messageId` 作为唯一标识
- 确保保存和查询时使用相同的 ID

### 问题 4: WebSocket 连接断开

**原因**：
- 前端 WebSocket 连接失败或断开
- 摘要生成完成时无法推送

**解决**：
- 检查 WebSocket 连接状态
- 即使 WebSocket 失败，摘要仍然会保存到数据库
- 刷新页面后应该能看到摘要

## 测试流程

### 完整测试步骤

1. **处理一封邮件**
   - 点击"AI处理"按钮
   - 等待处理完成

2. **等待摘要生成**
   - 观察后端日志，确认摘要生成成功
   - 观察前端日志，确认收到 WebSocket 消息

3. **关闭详情对话框**
   - 点击"关闭"按钮

4. **刷新页面**
   - 按 F5 刷新浏览器
   - 观察前端日志，确认收到摘要字段

5. **重新打开详情**
   - 点击"查看详情"按钮
   - **预期**：直接显示摘要，不显示"摘要生成中"
   - **实际**：如果显示"摘要生成中"，说明有问题

### 快速验证

直接查看数据文件：

```bash
# Windows
type data\users\user_email_data_admin.json | findstr "body_summary"

# Linux/Mac
cat data/users/user_email_data_admin.json | grep "body_summary"
```

如果能看到 `"body_summary": "..."` 和 `"reply_summary": "..."`，说明后端保存成功。

## 修复建议

如果确认是持久化问题，可能需要：

1. **确保邮件添加到历史记录时包含所有字段**
2. **确保摘要生成时能找到对应的历史记录**
3. **确保数据保存时不会丢失字段**
4. **确保前端判断逻辑正确**

## 总结

摘要持久化的完整流程：

```
1. 邮件处理完成 → 添加到 history
2. 摘要生成完成 → 更新 history 中的记录
3. 保存到 JSON 文件 → 持久化存储
4. 前端获取历史记录 → 包含摘要字段
5. 前端显示详情 → 直接显示摘要，不轮询
```

任何一个环节出问题都会导致摘要无法持久化。通过上述调试步骤可以定位具体问题。
