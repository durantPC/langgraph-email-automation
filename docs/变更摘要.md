# 项目变更摘要

## 概述

本次变更将项目从使用国外的 API 服务（Groq、Google Gemini、Gmail）迁移到国内服务（智谱AI、QQ邮箱）。

---

## 🔄 主要变更

### 1. LLM模型替换

**原来:** Groq Llama 3.3-70b-versatile  
**现在:** 智谱AI GLM-4-Flash

**影响的文件:**
- `src/agents.py` - 将 `ChatGroq` 替换为 `ChatZhipuAI`
- `create_index.py` - 测试脚本使用智谱AI模型

### 2. 嵌入模型替换

**原来:** Google Gemini text-embedding-004  
**现在:** 智谱AI embedding-3

**影响的文件:**
- `src/agents.py` - 将 `GoogleGenerativeAIEmbeddings` 替换为 `ZhipuAIEmbeddings`
- `create_index.py` - 向量化使用智谱AI嵌入模型

### 3. 邮箱服务替换

**原来:** Gmail API (OAuth 认证)  
**现在:** QQ邮箱 (SMTP/IMAP 协议)

**新增文件:**
- `src/tools/QQEmailTools.py` - 全新的QQ邮箱工具类

**删除文件:**
- `src/tools/GmailTools.py` - 已删除

**影响的文件:**
- `src/nodes.py` - 使用 `QQEmailToolsClass` 替换 `GmailToolsClass`

---

## 📦 依赖变更

### 移除的依赖
```
langchain-groq
langchain_google_genai
google-api-python-client
google-auth-oauthlib
google-auth-httplib2
```

### 保留的依赖
```
langchain-core
langchain_community  # 包含智谱AI集成
langgraph
langchain_chroma
chromadb
beautifulsoup4
python-dotenv
colorama
langserve
sse_starlette
uvicorn
gunicorn
fastapi
```

---

## 🔧 配置变更

### 环境变量变更

**原来的 `.env` 配置:**
```env
MY_EMAIL=your_email@gmail.com
GROQ_API_KEY=your_groq_api_key
GOOGLE_API_KEY=your_gemini_api_key
```

**新的 `.env` 配置:**
```env
MY_EMAIL=your_email@qq.com
QQ_EMAIL_AUTH_CODE=your_qq_email_auth_code
ZHIPUAI_API_KEY=your_zhipuai_api_key
```

### 不再需要的文件
- `credentials.json` (Gmail OAuth 凭据)
- `token.json` (Gmail 访问令牌)

---

## 📄 文件修改清单

### 核心代码文件
| 文件 | 修改内容 |
|------|---------|
| `src/agents.py` | ✅ 替换为智谱AI的LLM和嵌入模型 |
| `src/nodes.py` | ✅ 使用QQEmailTools，中文化输出信息 |
| `src/tools/QQEmailTools.py` | ✅ 新建QQ邮箱工具类 |
| `src/tools/GmailTools.py` | ❌ 已删除 |
| `create_index.py` | ✅ 使用智谱AI模型 |
| `main.py` | ✅ 中文化输出信息 |
| `deploy_api.py` | ✅ 更新API描述 |

### 配置和文档文件
| 文件 | 修改内容 |
|------|---------|
| `requirements.txt` | ✅ 移除Google/Groq相关依赖 |
| `README.md` | ✅ 更新技术栈和配置说明 |
| `配置说明.md` | ✅ 新建详细配置文档 |
| `变更摘要.md` | ✅ 本文档 |

---

## 🚀 迁移步骤

如果你要在现有项目上应用这些变更，请按以下步骤操作：

### 1. 更新依赖
```bash
pip install -r requirements.txt
```

### 2. 配置环境变量
创建 `.env` 文件并添加：
- QQ邮箱地址和授权码
- 智谱AI API密钥

详见 `配置说明.md`

### 3. 删除旧的认证文件（如果存在）
```bash
rm credentials.json
rm token.json
```

### 4. 重新创建向量数据库
```bash
# 删除旧的向量数据库（使用不同的嵌入模型）
rm -rf db/

# 重新创建
python create_index.py
```

### 5. 测试运行
```bash
python main.py
```

---

## 🔍 技术细节

### QQ邮箱实现细节

**连接方式:**
- IMAP (SSL) - 用于接收邮件
  - 服务器: `imap.qq.com`
  - 端口: `993`
- SMTP (SSL) - 用于发送邮件
  - 服务器: `smtp.qq.com`
  - 端口: `465`

**主要功能:**
- `fetch_unanswered_emails()` - 获取最近8小时的未读邮件
- `send_reply()` - 发送回复邮件（保持对话线程）
- `create_draft_reply()` - QQ邮箱直接发送，不创建草稿

**与Gmail API的区别:**
| 功能 | Gmail API | QQ邮箱 IMAP/SMTP |
|------|-----------|------------------|
| 认证方式 | OAuth 2.0 | 用户名+授权码 |
| 草稿功能 | ✅ 支持 | ⚠️  本项目中直接发送 |
| 线程管理 | ✅ 原生支持 | ✅ 通过邮件头实现 |
| 搜索功能 | ✅ 强大 | ⚠️  基础搜索 |

### 智谱AI模型信息

**GLM-4-Flash:**
- 类型: 对话大模型
- 特点: 快速响应，适合实时应用
- 上下文长度: 128K tokens
- 结构化输出: ✅ 支持

**Embedding-3:**
- 类型: 文本向量化模型
- 维度: 2048
- 用途: 语义搜索、RAG应用

---

## ⚠️ 注意事项

### 功能差异

1. **邮件草稿功能**
   - 原Gmail可以创建草稿
   - 现QQ邮箱直接发送邮件
   - 如需草稿功能，需要手动实现本地保存

2. **邮件搜索**
   - Gmail API支持复杂查询
   - IMAP搜索功能有限
   - 本实现使用简单的时间范围搜索

3. **授权方式**
   - Gmail使用OAuth（更安全但配置复杂）
   - QQ邮箱使用授权码（简单但需要妥善保管）

### 安全建议

1. ✅ 不要将 `.env` 文件提交到版本控制
2. ✅ 定期更换QQ邮箱授权码
3. ✅ 妥善保管智谱AI密钥
4. ✅ 使用独立的邮箱账号用于自动化

---

## 📊 成本对比

| 服务 | 原方案 | 新方案 |
|------|--------|--------|
| LLM | Groq (免费但有限额) | 智谱AI (新用户有免费额度) |
| 嵌入 | Google Gemini (有免费额度) | 智谱AI (新用户有免费额度) |
| 邮箱 | Gmail API (免费) | QQ邮箱 (免费) |

**总体:** 两个方案成本相近，新方案更适合国内网络环境。

---

## 🆘 故障排查

### 问题1: 智谱AI调用失败
```
解决方案:
1. 检查API密钥是否正确
2. 确认账户有足够额度
3. 检查网络连接
4. 查看智谱AI控制台的调用日志
```

### 问题2: QQ邮箱连接失败
```
解决方案:
1. 确认已开启IMAP/SMTP服务
2. 使用授权码而非QQ密码
3. 检查防火墙设置
4. 尝试重新生成授权码
```

### 问题3: 向量数据库错误
```
解决方案:
删除旧数据库重新创建:
rm -rf db/
python create_index.py
```

---

## 📞 支持资源

- 智谱AI文档: https://open.bigmodel.cn/dev/api
- QQ邮箱帮助: https://service.mail.qq.com/
- LangChain文档: https://python.langchain.com/
- 项目原始仓库: https://github.com/kaymen99/langgraph-email-automation

---

## ✅ 验证清单

迁移完成后，请确认：

- [ ] 依赖已全部安装
- [ ] 环境变量已正确配置
- [ ] QQ邮箱IMAP/SMTP服务已开启
- [ ] 智谱AI密钥有效且有额度
- [ ] 向量数据库已重新创建
- [ ] 程序能正常启动
- [ ] 能成功接收邮件
- [ ] 能成功发送回复

---

**变更完成日期:** 2025-11-29  
**变更类型:** 架构升级 - 国际服务 → 国内服务  
**影响范围:** 全栈（LLM、嵌入模型、邮箱服务）

