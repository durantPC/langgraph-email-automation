# 多服务商支持说明

## 功能概述

系统现在支持真正的多服务商模型配置，可以同时使用来自不同服务商的AI模型。

## 支持的服务商

### 预配置服务商

系统已预配置以下服务商的API地址：

| 服务商 | API Base URL |
|--------|--------------|
| 硅基流动 | https://api.siliconflow.cn/v1 |
| OpenAI | https://api.openai.com/v1 |
| Anthropic | https://api.anthropic.com/v1 |
| DeepSeek | https://api.deepseek.com/v1 |
| Moonshot | https://api.moonshot.cn/v1 |
| 智谱AI | https://open.bigmodel.cn/api/paas/v4 |
| 阿里云 | https://dashscope.aliyuncs.com/compatible-mode/v1 |
| 腾讯云 | https://api.hunyuan.cloud.tencent.com/v1 |

### 自定义服务商

如果你的服务商不在上述列表中，可以：
1. 在服务商下拉框中输入自定义名称
2. 在"API地址"字段中输入完整的API base URL

## 使用方法

### 1. 添加自定义模型

在"系统设置"页面：

1. 点击"添加模型"按钮
2. 选择模型类型（回复模型/嵌入模型）
3. 选择或输入服务商名称
4. 输入模型名称（例如：gpt-4、claude-3-opus-20240229）
5. 输入该服务商的API密钥
6. （可选）输入自定义API地址
   - 如果留空，系统会根据服务商自动推断
   - 如果填写，将使用你指定的地址

### 2. 使用示例

#### 使用OpenAI的模型

```
服务商: OpenAI
模型: gpt-4-turbo
API密钥: sk-xxx...
API地址: （留空，自动使用 https://api.openai.com/v1）
```

#### 使用DeepSeek的模型

```
服务商: DeepSeek
模型: deepseek-chat
API密钥: sk-xxx...
API地址: （留空，自动使用 https://api.deepseek.com/v1）
```

#### 使用自定义服务商

```
服务商: 我的私有服务
模型: my-custom-model
API密钥: xxx...
API地址: https://my-api.example.com/v1
```

## 技术实现

### 后端

1. **数据模型**：`CustomModelModel` 添加了 `apiBaseUrl` 字段
2. **API地址映射**：`get_api_base_url()` 函数根据服务商返回对应的API地址
3. **模型配置获取**：`get_model_config()` 函数同时返回API密钥和base URL
4. **自动选择**：所有模型调用都会自动使用正确的API地址

### 前端

1. **服务商选择**：支持预定义选项和自定义输入
2. **API地址输入**：可选字段，支持完全自定义
3. **智能提示**：显示示例API地址格式

## 兼容性

### 向后兼容

- 已有的模型配置会自动使用硅基流动的API地址
- 不需要修改现有配置

### 系统默认模型

- 系统默认模型（通过环境变量配置）仍然使用硅基流动API
- 只有自定义模型才会使用各自的API地址

## 注意事项

### API兼容性

不同服务商的API可能有细微差异：

1. **OpenAI兼容**：大多数服务商（硅基流动、DeepSeek、Moonshot等）都兼容OpenAI的API格式
2. **Anthropic**：使用不同的API格式，可能需要额外适配
3. **模型名称**：确保使用服务商支持的正确模型名称

### 测试建议

添加新模型后，建议：
1. 在"系统设置"中点击"测试AI连接"
2. 确认模型可以正常调用
3. 检查返回结果是否符合预期

### 常见问题

**Q: 为什么我的OpenAI模型调用失败？**
A: 检查：
- API密钥是否正确
- 模型名称是否正确（如 gpt-4-turbo）
- API地址是否正确（应该是 https://api.openai.com/v1）
- 账户是否有可用额度

**Q: 可以同时使用多个服务商的模型吗？**
A: 可以！你可以添加多个不同服务商的模型，系统会自动为每个模型使用正确的API地址。

**Q: 自定义API地址有什么用？**
A: 适用于：
- 使用代理服务
- 使用私有部署的模型服务
- 使用未预配置的服务商

## 相关文件

### 后端文件

- `backend_api.py` - 第580-610行：`get_api_base_url()` 函数（服务商到API地址的映射）
- `backend_api.py` - 第5620-5670行：`get_model_config()` 和 `get_models_config()` 函数
- `backend_api.py` - 第5718-5760行：添加/删除自定义模型的API端点
- `src/agents.py` - 第22行：`Agents` 类初始化，支持自定义API base URL
- `src/nodes.py` - 第8行：`Nodes` 类初始化，支持自定义API base URL

### 前端文件

- `frontend/src/views/Settings.vue` - 添加模型对话框，包含API地址输入框

### 修改的调用点

所有创建 `Nodes` 实例的地方都已更新，包括：
1. 单封邮件处理（`/api/emails/process`）
2. 批量并发处理（`/api/emails/process-batch`）
3. 自动处理（SystemState.auto_process_emails）
4. RAG测试（`/api/rag/test`）
5. 摘要生成（`generate_body_summary_only`、`generate_email_summaries_async`）

## 升级说明

### 对现有用户的影响

- **无需任何操作**：现有配置会自动使用硅基流动API
- **完全兼容**：所有现有功能保持不变
- **可选升级**：如果需要使用其他服务商，只需添加新模型即可

### 数据迁移

不需要数据迁移。系统会自动为没有 `apiBaseUrl` 字段的模型使用默认值。
