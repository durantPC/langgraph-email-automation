# è‡ªåŠ¨å‘é€çº¿ç¨‹ä¼˜åŒ–è¯´æ˜

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šå³ä½¿æ²¡æœ‰å¼€å¯"è‡ªåŠ¨å‘é€"åŠŸèƒ½ï¼Œç³»ç»Ÿå¯åŠ¨ç›‘æ§æ—¶ä»ç„¶ä¼šæ˜¾ç¤º"å¯åŠ¨è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹"çš„æ—¥å¿—ï¼Œå®¹æ˜“è®©ç”¨æˆ·è¯¯è§£ç³»ç»Ÿè¡Œä¸ºã€‚

```
ğŸš€ [ç›‘æ§ç³»ç»Ÿ] å¯åŠ¨ç›‘æ§çº¿ç¨‹ï¼Œç”¨æˆ·: admin
ğŸ”„ [ç›‘æ§å¾ªç¯] ç›‘æ§å¾ªç¯å·²å¯åŠ¨ï¼Œç”¨æˆ·: admin, æ£€æŸ¥é—´éš”: 900ç§’
âœ… [ç›‘æ§ç³»ç»Ÿ] ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨
ğŸš€ [ç›‘æ§ç³»ç»Ÿ] å¯åŠ¨è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹ï¼Œç”¨æˆ·: admin  â† ç”¨æˆ·æ²¡æœ‰å¼€å¯è‡ªåŠ¨å‘é€
ğŸ”„ [è‡ªåŠ¨å‘é€çº¿ç¨‹] çº¿ç¨‹å·²å¯åŠ¨ï¼Œç”¨æˆ·: admin
âœ… [ç›‘æ§ç³»ç»Ÿ] è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹å·²å¯åŠ¨
```

## é—®é¢˜åˆ†æ

### åŸæœ‰è®¾è®¡

åœ¨ `start_monitor()` æ–¹æ³•ä¸­ï¼Œæ— è®ºç”¨æˆ·æ˜¯å¦å¼€å¯äº†"è‡ªåŠ¨å‘é€"ï¼Œéƒ½ä¼šå¯åŠ¨è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹ï¼š

```python
def start_monitor(self):
    if not self.is_running:
        self.is_running = True
        # å¯åŠ¨ç›‘æ§çº¿ç¨‹
        self.monitor_thread = threading.Thread(target=self._monitor_loop, daemon=True)
        self.monitor_thread.start()
        
        # æ— æ¡ä»¶å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹
        self.auto_send_thread = threading.Thread(target=self._auto_send_loop, daemon=True)
        self.auto_send_thread.start()
```

è™½ç„¶ `_auto_send_loop` å†…éƒ¨ä¼šæ£€æŸ¥ `autoSend` è®¾ç½®ï¼Œåªæœ‰å¼€å¯æ—¶æ‰æ‰§è¡Œå‘é€æ“ä½œï¼Œä½†è¿™ç§è®¾è®¡å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **èµ„æºæµªè´¹**ï¼šå³ä½¿æ²¡æœ‰å¼€å¯è‡ªåŠ¨å‘é€ï¼Œçº¿ç¨‹ä¹Ÿåœ¨åå°è¿è¡Œå¹¶æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
2. **æ—¥å¿—æ··æ·†**ï¼šå¯åŠ¨æ—¶ä¼šæ‰“å°"å¯åŠ¨è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹"ï¼Œå®¹æ˜“è®©ç”¨æˆ·è¯¯è§£
3. **ä¸å¤Ÿä¼˜é›…**ï¼šåº”è¯¥æŒ‰éœ€å¯åŠ¨çº¿ç¨‹ï¼Œè€Œä¸æ˜¯æ€»æ˜¯å¯åŠ¨ç„¶åå†…éƒ¨åˆ¤æ–­

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æŒ‰éœ€å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹

ä¿®æ”¹ `start_monitor()` æ–¹æ³•ï¼Œåªåœ¨ç”¨æˆ·å¼€å¯äº†"è‡ªåŠ¨å‘é€"æ—¶æ‰å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹ï¼š

```python
def start_monitor(self):
    if not self.is_running:
        self.is_running = True
        print(f"ğŸš€ [ç›‘æ§ç³»ç»Ÿ] å¯åŠ¨ç›‘æ§çº¿ç¨‹ï¼Œç”¨æˆ·: {self.username}")
        self.monitor_thread = threading.Thread(target=self._monitor_loop, daemon=True)
        self.monitor_thread.start()
        print(f"âœ… [ç›‘æ§ç³»ç»Ÿ] ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨")
        
        # æ£€æŸ¥æ˜¯å¦å¼€å¯äº†è‡ªåŠ¨å‘é€ï¼Œåªæœ‰å¼€å¯æ—¶æ‰å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹
        user_settings = get_user_settings(self.username)
        if user_settings.get("autoSend", False):
            print(f"ğŸš€ [ç›‘æ§ç³»ç»Ÿ] å¯åŠ¨è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹ï¼Œç”¨æˆ·: {self.username}")
            self.auto_send_thread = threading.Thread(target=self._auto_send_loop, daemon=True)
            self.auto_send_thread.start()
            print(f"âœ… [ç›‘æ§ç³»ç»Ÿ] è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹å·²å¯åŠ¨")
        else:
            print(f"â„¹ï¸ [ç›‘æ§ç³»ç»Ÿ] è‡ªåŠ¨å‘é€æœªå¼€å¯ï¼Œè·³è¿‡å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹")
    else:
        print(f"âš ï¸ [ç›‘æ§ç³»ç»Ÿ] ç›‘æ§å·²åœ¨è¿è¡Œä¸­ï¼Œè·³è¿‡å¯åŠ¨")
```

### 2. åŠ¨æ€å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹

åœ¨ä¿å­˜è®¾ç½®æ—¶ï¼Œå¦‚æœç”¨æˆ·åœ¨ç›‘æ§è¿è¡ŒæœŸé—´å¼€å¯äº†"è‡ªåŠ¨å‘é€"ï¼Œéœ€è¦åŠ¨æ€å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹ï¼š

```python
# å¦‚æœå¼€å¯äº†è‡ªåŠ¨å‘é€ï¼Œç¡®ä¿ç›‘æ§å’Œè‡ªåŠ¨å‘é€çº¿ç¨‹éƒ½å·²å¯åŠ¨
if auto_send_enabled:
    user_state = get_user_state(current_username)
    # å¦‚æœç›‘æ§æ²¡æœ‰è¿è¡Œï¼Œå¯åŠ¨ç›‘æ§ï¼ˆstart_monitor ä¼šæ£€æŸ¥ autoSend å¹¶å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹ï¼‰
    if not user_state.is_running:
        print(f"ğŸš€ [ä¿å­˜è®¾ç½®] æ£€æµ‹åˆ°è‡ªåŠ¨å‘é€å·²å¼€å¯ï¼Œä½†ç›‘æ§æœªè¿è¡Œï¼Œå¯åŠ¨ç›‘æ§...")
        user_state.start_monitor()
    else:
        # å¦‚æœç›‘æ§å·²åœ¨è¿è¡Œï¼Œä½†è‡ªåŠ¨å‘é€çº¿ç¨‹æœªå¯åŠ¨ï¼Œå¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹
        if user_state.auto_send_thread is None or not user_state.auto_send_thread.is_alive():
            print(f"ğŸš€ [ä¿å­˜è®¾ç½®] æ£€æµ‹åˆ°è‡ªåŠ¨å‘é€å·²å¼€å¯ï¼Œå¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹...")
            user_state.auto_send_thread = threading.Thread(target=user_state._auto_send_loop, daemon=True)
            user_state.auto_send_thread.start()
            print(f"âœ… [ä¿å­˜è®¾ç½®] è‡ªåŠ¨å‘é€çº¿ç¨‹å·²å¯åŠ¨")
    
    # åœ¨åå°ä»»åŠ¡ä¸­æ‰§è¡Œè‡ªåŠ¨å‘é€ï¼Œé¿å…é˜»å¡å“åº”
    background_tasks.add_task(send_processed_emails_with_rate_limit, current_username)
```

### 3. å…³é—­è‡ªåŠ¨å‘é€çš„å¤„ç†

å½“ç”¨æˆ·å…³é—­"è‡ªåŠ¨å‘é€"æ—¶ï¼Œè®°å½•æ—¥å¿—å¹¶è¯´æ˜çº¿ç¨‹ä¼šè‡ªåŠ¨åœæ­¢å·¥ä½œï¼š

```python
if settings.autoSend is not None:
    old_auto_send = user_info["settings"].get("autoSend", False)
    user_info["settings"]["autoSend"] = settings.autoSend
    auto_send_enabled = settings.autoSend
    
    # å¦‚æœ autoSend ä» True å˜ä¸º Falseï¼Œè®°å½•æ—¥å¿—
    if old_auto_send and not settings.autoSend:
        print(f"â„¹ï¸ [ä¿å­˜è®¾ç½®] ç”¨æˆ· {current_username} å…³é—­äº†è‡ªåŠ¨å‘é€")
        # æ³¨æ„ï¼šè‡ªåŠ¨å‘é€çº¿ç¨‹ä¼šåœ¨ä¸‹æ¬¡å¾ªç¯æ—¶æ£€æŸ¥è®¾ç½®å¹¶è·³è¿‡å‘é€ï¼Œæ— éœ€æ‰‹åŠ¨åœæ­¢çº¿ç¨‹
```

## ä¼˜åŒ–æ•ˆæœ

### ä¼˜åŒ–å‰

æ— è®ºæ˜¯å¦å¼€å¯è‡ªåŠ¨å‘é€ï¼Œéƒ½ä¼šçœ‹åˆ°ï¼š

```
ğŸš€ [ç›‘æ§ç³»ç»Ÿ] å¯åŠ¨ç›‘æ§çº¿ç¨‹ï¼Œç”¨æˆ·: admin
âœ… [ç›‘æ§ç³»ç»Ÿ] ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨
ğŸš€ [ç›‘æ§ç³»ç»Ÿ] å¯åŠ¨è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹ï¼Œç”¨æˆ·: admin
ğŸ”„ [è‡ªåŠ¨å‘é€çº¿ç¨‹] çº¿ç¨‹å·²å¯åŠ¨ï¼Œç”¨æˆ·: admin
âœ… [ç›‘æ§ç³»ç»Ÿ] è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹å·²å¯åŠ¨
```

### ä¼˜åŒ–å

**æœªå¼€å¯è‡ªåŠ¨å‘é€æ—¶ï¼š**

```
ğŸš€ [ç›‘æ§ç³»ç»Ÿ] å¯åŠ¨ç›‘æ§çº¿ç¨‹ï¼Œç”¨æˆ·: admin
âœ… [ç›‘æ§ç³»ç»Ÿ] ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨
â„¹ï¸ [ç›‘æ§ç³»ç»Ÿ] è‡ªåŠ¨å‘é€æœªå¼€å¯ï¼Œè·³è¿‡å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹
```

**å¼€å¯è‡ªåŠ¨å‘é€æ—¶ï¼š**

```
ğŸš€ [ç›‘æ§ç³»ç»Ÿ] å¯åŠ¨ç›‘æ§çº¿ç¨‹ï¼Œç”¨æˆ·: admin
âœ… [ç›‘æ§ç³»ç»Ÿ] ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨
ğŸš€ [ç›‘æ§ç³»ç»Ÿ] å¯åŠ¨è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹ï¼Œç”¨æˆ·: admin
âœ… [ç›‘æ§ç³»ç»Ÿ] è‡ªåŠ¨å‘é€æ£€æŸ¥çº¿ç¨‹å·²å¯åŠ¨
```

## æŠ€æœ¯è¦ç‚¹

### 1. çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†

- **å¯åŠ¨æ—¶æœº**ï¼šåªåœ¨éœ€è¦æ—¶å¯åŠ¨çº¿ç¨‹
- **è¿è¡Œæ£€æŸ¥**ï¼šä½¿ç”¨ `thread.is_alive()` æ£€æŸ¥çº¿ç¨‹æ˜¯å¦å­˜æ´»
- **å®ˆæŠ¤çº¿ç¨‹**ï¼šä½¿ç”¨ `daemon=True` ç¡®ä¿ä¸»ç¨‹åºé€€å‡ºæ—¶çº¿ç¨‹è‡ªåŠ¨ç»“æŸ

### 2. åŠ¨æ€çº¿ç¨‹æ§åˆ¶

æ”¯æŒåœ¨è¿è¡Œæ—¶åŠ¨æ€å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹ï¼Œæ— éœ€é‡å¯ç›‘æ§ï¼š

```python
# æ£€æŸ¥çº¿ç¨‹æ˜¯å¦å­˜æ´»
if user_state.auto_send_thread is None or not user_state.auto_send_thread.is_alive():
    # å¯åŠ¨æ–°çº¿ç¨‹
    user_state.auto_send_thread = threading.Thread(target=user_state._auto_send_loop, daemon=True)
    user_state.auto_send_thread.start()
```

### 3. è®¾ç½®æ£€æŸ¥æœºåˆ¶

è‡ªåŠ¨å‘é€çº¿ç¨‹å†…éƒ¨ä»ç„¶ä¿ç•™è®¾ç½®æ£€æŸ¥ï¼Œä½œä¸ºåŒé‡ä¿éšœï¼š

```python
def _auto_send_loop(self):
    while self.is_running:
        # è·å–ç”¨æˆ·è®¾ç½®ï¼Œæ£€æŸ¥æ˜¯å¦å¼€å¯äº†è‡ªåŠ¨å‘é€
        user_settings = get_user_settings(self.username)
        if user_settings.get("autoSend", False):
            # æ‰§è¡Œè‡ªåŠ¨å‘é€
            send_processed_emails_with_rate_limit(self.username)
        time.sleep(30)
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå¯åŠ¨ç›‘æ§ä½†ä¸è‡ªåŠ¨å‘é€

ç”¨æˆ·åªæƒ³ç›‘æ§é‚®ä»¶ï¼Œæ‰‹åŠ¨ç¡®è®¤åå†å‘é€ï¼š

1. å…³é—­"è‡ªåŠ¨å‘é€"å¼€å…³
2. å¯åŠ¨ç›‘æ§
3. ç³»ç»Ÿåªå¯åŠ¨ç›‘æ§çº¿ç¨‹ï¼Œä¸å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹
4. ç”¨æˆ·å¯ä»¥åœ¨é‚®ä»¶ç®¡ç†é¡µé¢æ‰‹åŠ¨ç‚¹å‡»"å‘é€"æŒ‰é’®

### åœºæ™¯2ï¼šå¯åŠ¨ç›‘æ§å¹¶è‡ªåŠ¨å‘é€

ç”¨æˆ·å¸Œæœ›å®Œå…¨è‡ªåŠ¨åŒ–å¤„ç†é‚®ä»¶ï¼š

1. å¼€å¯"è‡ªåŠ¨å‘é€"å¼€å…³
2. å¯åŠ¨ç›‘æ§
3. ç³»ç»ŸåŒæ—¶å¯åŠ¨ç›‘æ§çº¿ç¨‹å’Œè‡ªåŠ¨å‘é€çº¿ç¨‹
4. ç³»ç»Ÿè‡ªåŠ¨å¤„ç†å¹¶å‘é€é‚®ä»¶

### åœºæ™¯3ï¼šè¿è¡Œæ—¶å¼€å¯è‡ªåŠ¨å‘é€

ç”¨æˆ·åœ¨ç›‘æ§è¿è¡ŒæœŸé—´å†³å®šå¼€å¯è‡ªåŠ¨å‘é€ï¼š

1. ç›‘æ§å·²åœ¨è¿è¡Œ
2. åœ¨è®¾ç½®é¡µé¢å¼€å¯"è‡ªåŠ¨å‘é€"å¹¶ä¿å­˜
3. ç³»ç»Ÿæ£€æµ‹åˆ°ç›‘æ§å·²è¿è¡Œï¼ŒåŠ¨æ€å¯åŠ¨è‡ªåŠ¨å‘é€çº¿ç¨‹
4. æ— éœ€é‡å¯ç›‘æ§å³å¯å¼€å§‹è‡ªåŠ¨å‘é€

### åœºæ™¯4ï¼šè¿è¡Œæ—¶å…³é—­è‡ªåŠ¨å‘é€

ç”¨æˆ·åœ¨ç›‘æ§è¿è¡ŒæœŸé—´å†³å®šå…³é—­è‡ªåŠ¨å‘é€ï¼š

1. ç›‘æ§å’Œè‡ªåŠ¨å‘é€éƒ½åœ¨è¿è¡Œ
2. åœ¨è®¾ç½®é¡µé¢å…³é—­"è‡ªåŠ¨å‘é€"å¹¶ä¿å­˜
3. è‡ªåŠ¨å‘é€çº¿ç¨‹åœ¨ä¸‹æ¬¡å¾ªç¯æ—¶æ£€æŸ¥è®¾ç½®å¹¶è·³è¿‡å‘é€
4. çº¿ç¨‹ç»§ç»­è¿è¡Œä½†ä¸æ‰§è¡Œå‘é€æ“ä½œï¼ˆé¿å…é¢‘ç¹åˆ›å»º/é”€æ¯çº¿ç¨‹ï¼‰

## ç›¸å…³æ–‡ä»¶

- `backend_api.py`ï¼šUserState ç±»çš„ `start_monitor()` æ–¹æ³•
- `backend_api.py`ï¼š`save_settings` API ç«¯ç‚¹

## ä¼˜åŒ–æ—¥æœŸ

2024-12-20
