# 模型兼容性说明

## 结构化输出支持

系统在处理邮件时需要模型返回结构化的JSON输出。不同模型对结构化输出的支持程度不同。

### 支持良好的模型

以下模型经过测试，支持结构化输出：

- **硅基流动**的所有模型（Qwen系列、Moonshot系列等）
- **OpenAI**的GPT系列模型
- **DeepSeek**的模型

### 部分支持的模型

某些模型可能返回Markdown格式的文本而不是JSON，系统已添加容错处理：

- **OpenWond**的模型（如Qwen3 Max）
- 其他小型或定制模型

### 容错机制

当模型返回非JSON格式时，系统会：

1. **邮件分类**：
   - 捕获JSON解析错误
   - 从返回的文本中提取关键信息
   - 使用关键词匹配确定邮件分类
   - 如果无法提取，使用默认分类（产品咨询）

2. **RAG查询生成**：
   - 捕获JSON解析错误
   - 从Markdown列表中提取查询内容
   - 支持 `- "查询"` 和 `1. "查询"` 格式
   - 如果无法提取，使用邮件内容的前100字作为查询

### 关键词匹配规则

| 分类 | 关键词 |
|------|--------|
| 无关邮件 | unrelated, 无关 |
| 客户投诉 | complaint, 投诉 |
| 客户反馈 | feedback, 反馈 |
| 产品咨询 | enquiry, inquiry, 咨询 |

### 日志示例

**邮件分类失败时**：
```
⚠️ 结构化输出失败，尝试从文本中提取分类...
   错误: 1 validation error for CategorizeEmailOutput...
   模型返回文本: **Category:** customer_feedback...
✅ 从文本中提取到分类: customer_feedback
```

**RAG查询生成失败时**：
```
⚠️ RAG查询结构化输出失败，尝试从文本中提取...
   错误: 1 validation error for RAGQueriesOutput...
   模型返回文本: - "CRM系统客户跟进记录功能"...
✅ 从文本中提取到 3 个查询
```

## 建议

### 选择模型时

1. **优先选择支持结构化输出的模型**（如硅基流动、OpenAI）
2. **测试新模型**：添加新模型后，先处理一封测试邮件，确认是否正常工作
3. **查看日志**：如果看到"结构化输出失败"的警告，说明模型不完全兼容

### 如果必须使用不支持结构化输出的模型

系统已经添加了容错处理，可以正常工作，但：

- 分类准确度可能略有下降
- 依赖关键词匹配，可能出现误判
- 建议定期检查处理结果

### 混合使用

你可以：
- **回复模型**：使用任何模型（如OpenWond的Qwen3 Max）
- **嵌入模型**：使用支持良好的模型（如硅基流动的Qwen3-Embedding-4B）

系统会自动处理不同模型的差异。

## 技术细节

### 结构化输出的实现

系统使用LangChain的 `with_structured_output()` 方法：

```python
self.categorize_email = (
    email_category_prompt | 
    qwen_llm.with_structured_output(CategorizeEmailOutput)
)
```

这要求模型返回符合 `CategorizeEmailOutput` 结构的JSON。

### 容错处理的实现

在 `src/nodes.py` 的 `categorize_email` 函数中：

```python
try:
    result = self.agents.categorize_email.invoke({"email": current_email.body})
    category = result.category.value
except Exception as e:
    # 从错误信息中提取文本
    # 使用关键词匹配确定分类
    category = extract_category_from_text(text)
```

## 相关文件

- `src/nodes.py` - 第60-115行：邮件分类函数，包含容错处理
- `src/nodes.py` - 第132-175行：RAG查询生成函数，包含容错处理
- `src/agents.py` - 第264-268行：结构化输出配置
- `src/structure_outputs.py` - 第12-18行：`CategorizeEmailOutput` 数据模型
- `src/structure_outputs.py` - 第20-25行：`RAGQueriesOutput` 数据模型
